<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>CVE-2012-0158 漏洞分析 | Chu&#39;s BLoG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="这个漏洞分析了几天才搞懂，实战与做实验区别还是很大的。
漏洞概要此漏洞是一个栈溢出漏洞，是由于 Microsoft Windows Common Controls 的 MSCOMCTL.TreeView、MSCOMCTL.ListView2、MSCOMCTL.TreeView2、MSCOMCTL.ListView 控件（MSCOMCTL.OCX）中存在错误，可被利用破坏内存，导致任意代码执行。">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2012-0158 漏洞分析">
<meta property="og:url" content="http://sh3ll.me/2015/09/19/CVE-2012-0158/index.html">
<meta property="og:site_name" content="Chu's BLoG">
<meta property="og:description" content="这个漏洞分析了几天才搞懂，实战与做实验区别还是很大的。
漏洞概要此漏洞是一个栈溢出漏洞，是由于 Microsoft Windows Common Controls 的 MSCOMCTL.TreeView、MSCOMCTL.ListView2、MSCOMCTL.TreeView2、MSCOMCTL.ListView 控件（MSCOMCTL.OCX）中存在错误，可被利用破坏内存，导致任意代码执行。">
<meta property="og:updated_time" content="2016-07-16T09:12:50.038Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2012-0158 漏洞分析">
<meta name="twitter:description" content="这个漏洞分析了几天才搞懂，实战与做实验区别还是很大的。
漏洞概要此漏洞是一个栈溢出漏洞，是由于 Microsoft Windows Common Controls 的 MSCOMCTL.TreeView、MSCOMCTL.ListView2、MSCOMCTL.TreeView2、MSCOMCTL.ListView 控件（MSCOMCTL.OCX）中存在错误，可被利用破坏内存，导致任意代码执行。">
  
    <link rel="alternative" href="/atom.xml" title="Chu&#39;s BLoG" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link href="http://fonts.useso.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Chu&#39;s BLoG</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Talk is cheap, show me the shell.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-home-icon" class="nav-icon" href="/"></a>
        
          <a id="nav-archives-icon" class="nav-icon" href="/archives"></a>
        
          <a id="nav-about-icon" class="nav-icon" href="/about"></a>
        
          <a id="nav-links-icon" class="nav-icon" href="/links"></a>
        
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-CVE-2012-0158" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      CVE-2012-0158 漏洞分析
    </h1>
  

      </header>
    
    <time class="article-date" datetime="2015-09-19T02:33:52.000Z" itemprop="datePublished">09-19-2015</time>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Exploit/">Exploit</a>
  </div>

  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>这个漏洞分析了几天才搞懂，实战与做实验区别还是很大的。</p>
<h2 id="漏洞概要"><a href="#漏洞概要" class="headerlink" title="漏洞概要"></a>漏洞概要</h2><p>此漏洞是一个栈溢出漏洞，是由于 Microsoft Windows Common Controls 的 MSCOMCTL.TreeView、MSCOMCTL.ListView2、MSCOMCTL.TreeView2、MSCOMCTL.ListView 控件（MSCOMCTL.OCX）中存在错误，可被利用破坏内存，导致任意代码执行。<a id="more"></a></p>
<h2 id="分析环境"><a href="#分析环境" class="headerlink" title="分析环境"></a>分析环境</h2><p>OS：Windows XP SP3<br>Debugger：WinDbg<br>Target：Mircrosoft Office Word 2003（11.5604.5606）</p>
<h2 id="定位-shellcode"><a href="#定位-shellcode" class="headerlink" title="定位 shellcode"></a>定位 shellcode</h2><p>拿到手的是一枚 msf 生成的 POC（exec calc）。考虑到 POC 运行后调用 calc.exe，所以首先选在 kernel32.WinExec 处下断点：<code>bp kernel32!WinExec</code>。<br>运行程序，不出意料地程序断在了 WinExec 处，先来查看下 WinExec 的参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">0:000&gt; kb L3</div><div class="line">ChildEBP RetAddr  Args to Child              </div><div class="line">00120960 001218e6 00121905 00000001 00000000 kernel32!WinExec</div><div class="line">WARNING: Frame IP not in any known module. Following frames may be wrong.</div><div class="line">00121853 508b64c0 0c528b30 8b14528b b70f2872 &lt;Unloaded_dui.DLL&gt;+0x1218c5</div><div class="line">00121857 0c528b30 8b14528b b70f2872 ff31264a 0x508b64c0</div><div class="line">0:000&gt; db 121905 </div><div class="line">00121905  63 61 6c 63 00 00 00 00-00 00 00 00 00 00 00 00  calc............</div><div class="line">00121915  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</div><div class="line">00121925  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</div><div class="line">00121935  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</div><div class="line">00121945  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</div><div class="line">00121955  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</div><div class="line">00121965  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</div><div class="line">00121975  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</div></pre></td></tr></table></figure></p>
<p>确实调用的是 calc。</p>
<p>因为大部分 shellcode 附近都会有一段滑行区（<code>\x90\x90\x90\x90</code>），所以这里直接在栈中搜索 <code>\x90\x90\x90\x90</code> 快速定位 shellcode：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">0:000&gt; !py mona find -type bin -b 120000 -t 130000 -s 90909090</div><div class="line">Hold on...</div><div class="line">[+] Command used:</div><div class="line">!py mona.py find -type bin -b 120000 -t 130000 -s 90909090</div><div class="line"></div><div class="line">---------- Mona command started on 2015-09-19 11:02:35 (v2.0, rev 562) ----------</div><div class="line">[+] Processing arguments and criteria</div><div class="line">    - Pointer access level : *</div><div class="line">    - Treating search pattern as bin</div><div class="line">[+] Searching from 0x00120000 to 0x00130000</div><div class="line">[+] Preparing output file &apos;find.txt&apos;</div><div class="line">    - (Re)setting logfile C:\Documents and Settings\chu\....\mona_logs\WINWORD\find.txt</div><div class="line">[+] Generating module info table, hang on...</div><div class="line">    - Processing modules</div><div class="line">    - Done. Let&apos;s rock &apos;n roll.</div><div class="line">[+] Writing results to C:\Documents and Settings\chu\....\mona_logs\WINWORD\find.txt</div><div class="line">    - Number of pointers of type &apos;90909090&apos; : 2 </div><div class="line">[+] Results : </div><div class="line">0x00121710 |   0x00121710 : 90909090 | startnull,ascii &#123;PAGE_READWRITE&#125; [Stack] </div><div class="line">0x00121714 |   0x00121714 : 90909090 | startnull,ascii &#123;PAGE_READWRITE&#125; [Stack] </div><div class="line">    Found a total of 2 pointers</div><div class="line"></div><div class="line">[+] This mona.py action took 0:00:00.562000</div></pre></td></tr></table></figure></p>
<p>查看滑行区附近发现了 0x7c86467b（<code>jmp esp</code>）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">0:000&gt; dd 121710-20</div><div class="line">001216f0  0a0c0810 6a626f43 00000064 00008282</div><div class="line">00121700  00000000 00000000 00000000 7c86467b</div><div class="line">00121710  90909090 90909090 9849993f 41469348</div><div class="line">00121720  90974f97 97489797 fd969697 47414099</div><div class="line">00121730  96f9d6f8 98d699f8 fd97f8fd f94849f5</div><div class="line">00121740  423f4840 963f4090 fd4a993f 92484fd6</div><div class="line">00121750  4ff9419b 99924727 97494b49 f593903f</div><div class="line">00121760  42974240 f9929949 2f3f4e4e 963f3790</div></pre></td></tr></table></figure></p>
<p>对比 poc 文件我们可以确定这就是 shellcode，查看该段内存属性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">0:000&gt; !py mona info -a 121710</div><div class="line">Hold on...</div><div class="line">[+] Command used:</div><div class="line">!py mona.py info -a 121710</div><div class="line">[+] Generating module info table, hang on...</div><div class="line">    - Processing modules</div><div class="line">    - Done. Let&apos;s rock &apos;n roll.</div><div class="line">[+] NtGlobalFlag: 0x00000070</div><div class="line">    0x00000040 : +hpc - Enable Heap Parameter Checking</div><div class="line">    0x00000020 : +hfc - Enable Heap Free Checking</div><div class="line">    0x00000010 : +htc - Enable Heap Tail Checking</div><div class="line"></div><div class="line">[+] Information about address 0x00121710</div><div class="line">    startnull,ascii &#123;PAGE_READWRITE&#125;</div><div class="line">    Address is part of page 0x00106000 - 0x00130000</div><div class="line">    This address is in a stack segment  (Thread 0x000007f0, Stack Base : 0x00106000, Stack Top : 0x00130000)</div><div class="line">    Module: None</div><div class="line"></div><div class="line">[+] Disassembly:</div><div class="line">    Instruction at 00121710 : NOP</div><div class="line"></div><div class="line">Output of !address 0x00121710:</div><div class="line">    00030000 : 00106000 - 0002a000</div><div class="line">                    Type     00020000 MEM_PRIVATE</div><div class="line">                    Protect  00000004 PAGE_READWRITE</div><div class="line">                    State    00001000 MEM_COMMIT</div><div class="line">                    Usage    RegionUsageStack</div><div class="line">                    Pid.Tid  7cc.7f0</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">[+] This mona.py action took 0:00:00.625000</div></pre></td></tr></table></figure></p>
<p>shellcode 处于栈中，内存属性为 PAGE_READWRITE，所以如果实际利用中为求稳定需要考虑绕过 DEP。</p>
<h2 id="确定函数调用关系"><a href="#确定函数调用关系" class="headerlink" title="确定函数调用关系"></a>确定函数调用关系</h2><p>根据网上的资料已知此漏洞是 MSCOMCTL.OCX 控件的问题，故设置一个加载断点：<code>sxe ld:MSCOMCTL.OCX</code>，并在 0x7c86467b 处设置断点。<br>程序中断在加载处后，单步一段后发现就触发了 <code>jmp esp</code>，在 Command 窗口中可以看到最近调用的函数如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">0:000&gt; p</div><div class="line">eax=08dda94c ebx=01cb2338 ecx=275a3518 edx=08dda8f8 esi=00000000 edi=01cb2350</div><div class="line">eip=301ecdca esp=0012181c ebp=001218a8 iopl=0         nv up ei pl zr na pe nc</div><div class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</div><div class="line">winword+0x1ecdca:</div><div class="line">301ecdca ff5118          call    dword ptr [ecx+18h]  ds:0023:275a3530=276008d9</div><div class="line">0:000&gt; p</div><div class="line">Breakpoint 0 hit</div><div class="line">eax=00000000 ebx=0a6f0810 ecx=7c93003d edx=00140608 esi=08dad0c4 edi=00000000</div><div class="line">eip=7c86467b esp=00121718 ebp=00000000 iopl=0         nv up ei pl zr na pe nc</div><div class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</div><div class="line">kernel32!UnhandledExceptionFilter+0x7fc:</div><div class="line">7c86467b ffe4            jmp     esp &#123;&lt;Unloaded_dui.DLL&gt;+0x1216d7 (00121718)&#125;</div></pre></td></tr></table></figure></p>
<p>查看 276008d9 处信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">0:000&gt; !py mona info -a 276008d9</div><div class="line">Hold on...</div><div class="line">[+] Command used:</div><div class="line">!py mona.py info -a 276008d9</div><div class="line">[+] Generating module info table, hang on...</div><div class="line">    - Processing modules</div><div class="line">    - Done. Let&apos;s rock &apos;n roll.</div><div class="line">[+] NtGlobalFlag: 0x00000070</div><div class="line">    0x00000040 : +hpc - Enable Heap Parameter Checking</div><div class="line">    0x00000020 : +hfc - Enable Heap Free Checking</div><div class="line">    0x00000010 : +htc - Enable Heap Tail Checking</div><div class="line"></div><div class="line">[+] Information about address 0x276008d9</div><div class="line">     &#123;PAGE_EXECUTE_READ&#125;</div><div class="line">    Address is part of page 0x27581000 - 0x2762d000</div><div class="line">    Section : .text</div><div class="line">    Address is part of a module:</div><div class="line">    [MSCOMCTL.OCX] ASLR: False, Rebase: False, SafeSEH: False, OS: True, v6.1.95.45 (C:\WINDOWS\system32\MSCOMCTL.OCX)</div><div class="line">    Offset from module base: 0x808d9</div><div class="line"></div><div class="line">[+] Disassembly:</div><div class="line">    Instruction at 276008d9 : PUSH EBP</div><div class="line"></div><div class="line">Output of !address 0x276008d9:</div><div class="line">    27580000 : 27581000 - 000ac000</div><div class="line">                    Type     01000000 MEM_IMAGE</div><div class="line">                    Protect  00000020 PAGE_EXECUTE_READ</div><div class="line">                    State    00001000 MEM_COMMIT</div><div class="line">                    Usage    RegionUsageImage</div><div class="line">                    FullPath C:\WINDOWS\system32\MSCOMCTL.OCX</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">[+] This mona.py action took 0:00:20.188000</div></pre></td></tr></table></figure></p>
<p>确定确实是 MSCOMCTL.OCX 控件出的问题。接下来就是在 <code>winword+0x1ecdca</code> 处下断点，跟进：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">0:000&gt; p</div><div class="line">eax=08e28bf0 ebx=09581fa4 ecx=275a3540 edx=00000000 esi=00000000 edi=09581fbc</div><div class="line">eip=27600905 esp=00121808 ebp=00121814 iopl=0         nv up ei pl nz ac pe cy</div><div class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000217</div><div class="line">MSCOMCTL!DllUnregisterServer+0xc2e:</div><div class="line">27600905 ff5114          call    dword ptr [ecx+14h]  ds:0023:275a3554=275b66de</div><div class="line">0:000&gt; p</div><div class="line">Breakpoint 1 hit</div><div class="line">eax=00000000 ebx=0a0a0810 ecx=7c93003d edx=00140608 esi=08e2beac edi=00000000</div><div class="line">eip=7c86467b esp=00121718 ebp=00000000 iopl=0         nv up ei pl zr na pe nc</div><div class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</div><div class="line">kernel32!UnhandledExceptionFilter+0x7fc:</div><div class="line">7c86467b ffe4            jmp     esp &#123;&lt;Unloaded_dui.DLL&gt;+0x1216f7 (00121718)&#125;</div></pre></td></tr></table></figure></p>
<p>继续跟进：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">······ 省略中间跟进过程 ······</div><div class="line">0:000&gt; p</div><div class="line">eax=00000000 ebx=0a5f0810 ecx=7c93003d edx=00140608 esi=00186ad4 edi=00000000</div><div class="line">eip=275c8a56 esp=0012170c ebp=00000000 iopl=0         nv up ei pl zr na pe nc</div><div class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</div><div class="line">MSCOMCTL!DllGetClassObject+0x41d12:</div><div class="line">275c8a56 c20800          ret     8</div><div class="line">0:000&gt; p</div><div class="line">Breakpoint 1 hit</div><div class="line">eax=00000000 ebx=0a5f0810 ecx=7c93003d edx=00140608 esi=00186ad4 edi=00000000</div><div class="line">eip=7c86467b esp=00121718 ebp=00000000 iopl=0         nv up ei pl zr na pe nc</div><div class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</div><div class="line">kernel32!UnhandledExceptionFilter+0x7fc:</div><div class="line">7c86467b ffe4            jmp     esp &#123;&lt;Unloaded_dui.DLL&gt;+0x1216d7 (00121718)&#125;</div></pre></td></tr></table></figure></p>
<p>最后的函数调用关系如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">0:000&gt; kb</div><div class="line">ChildEBP RetAddr  Args to Child              </div><div class="line">WARNING: Stack unwind information not available. Following frames may be wrong.</div><div class="line">00121708 275e701a 08d97aa4 0a0a0810 00000000 MSCOMCTL!DllGetClassObject+0x41c89</div><div class="line">00121730 275e7361 08d97aa4 0a0a0810 0a0a0810 MSCOMCTL!DLLGetDocumentation+0xd08</div><div class="line">00121750 275ca8b6 08d969d0 0a0a0810 08d96828 MSCOMCTL!DLLGetDocumentation+0x104f</div><div class="line">001217d0 2758aee8 08d967d8 00000000 0a0a0810 MSCOMCTL!DllGetClassObject+0x43b72</div><div class="line">00121800 27600908 08d96828 0a0a0810 00000000 MSCOMCTL!DllGetClassObject+0x41a4</div><div class="line">00121814 301ecdcd 08d9682c 0a0a0810 00000000 MSCOMCTL!DllUnregisterServer+0xc31</div><div class="line">001218a8 3032463c 00000000 00000000 09581fa4 winword+0x1ecdcd</div><div class="line">001218fc 3046c59c 00000000 00000000 00000001 winword!wdCommandDispatch+0x44983</div><div class="line">00121974 302d90c1 00000001 00000000 00000000 winword!wdCommandDispatch+0x18c8e3</div><div class="line">00121a38 300424d3 09580a0c 00000002 00121e08 winword+0x2d90c1</div><div class="line">00121e6c 7c98d144 7c969564 00140000 0000001e winword+0x424d3</div><div class="line">00121f8c 30cc67f6 3160ff00 00aabe1a 00aabd1a ntdll!RtlDebugAllocateHeap+0x281</div><div class="line">00121fa8 30cc64e5 00aafffc 00000008 3160ff00 mso!_MsoPvFree+0x129</div><div class="line">00121fd0 30cc641e 30cc6431 3160ff00 0000001a mso!Ordinal573+0xff</div><div class="line">00122010 300086e1 00000004 00aabd04 00000000 mso!Ordinal573+0x38</div><div class="line">00000000 00000000 00000000 00000000 00000000 winword+0x86e1</div></pre></td></tr></table></figure></p>
<h2 id="分析漏洞"><a href="#分析漏洞" class="headerlink" title="分析漏洞"></a>分析漏洞</h2><p>具体跟进下 <code>MSCOMCTL!DllGetClassObject+0x41c83</code>，这时将 WinDbg 的 Memory 窗口锁定在 <code>0x12170c</code>，观察具体是走到哪一步造成的溢出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">275c89c7 55              push    ebp</div><div class="line">275c89c8 8bec            mov     ebp,esp</div><div class="line">;注意只开辟了 0x14 的栈空间</div><div class="line">275c89ca 83ec14          sub     esp,14h</div><div class="line">275c89cd 53              push    ebx</div><div class="line">275c89ce 8b5d0c          mov     ebx,dword ptr [ebp+0Ch]</div><div class="line">275c89d1 56              push    esi</div><div class="line">275c89d2 57              push    edi</div><div class="line">275c89d3 6a0c            push    0Ch</div><div class="line">275c89d5 8d45ec          lea     eax,[ebp-14h]</div><div class="line">275c89d8 53              push    ebx</div><div class="line">275c89d9 50              push    eax</div><div class="line">;第一次调用 MSCOMCTL!DllGetClassObject+0x41a29</div><div class="line">275c89da e88efdffff      call    MSCOMCTL!DllGetClassObject+0x41a29 (275c876d)</div><div class="line">275c89df 83c40c          add     esp,0Ch</div><div class="line">275c89e2 85c0            test    eax,eax</div><div class="line">275c89e4 7c6c            jl      MSCOMCTL!DllGetClassObject+0x41d0e (275c8a52)</div><div class="line">275c89e6 817dec436f626a  cmp     dword ptr [ebp-14h],6A626F43h</div><div class="line">275c89ed 0f8592a60000    jne     MSCOMCTL!DllGetClassObject+0x4c341 (275d3085)</div><div class="line">275c89f3 837df408        cmp     dword ptr [ebp-0Ch],8</div><div class="line">;就是这个比较导致了漏洞，jb：小于跳转，应为大于跳转</div><div class="line">275c89f7 0f8288a60000    jb      MSCOMCTL!DllGetClassObject+0x4c341 (275d3085)</div><div class="line">275c89fd ff75f4          push    dword ptr [ebp-0Ch]</div><div class="line">275c8a00 8d45f8          lea     eax,[ebp-8]</div><div class="line">275c8a03 53              push    ebx</div><div class="line">275c8a04 50              push    eax</div><div class="line">;第二次调用 MSCOMCTL!DllGetClassObject+0x41a29，导致了栈溢出</div><div class="line">275c8a05 e863fdffff      call    MSCOMCTL!DllGetClassObject+0x41a29 (275c876d)</div><div class="line">275c8a0a 8bf0            mov     esi,eax</div><div class="line">······ 省略中间指令 ······</div><div class="line">275c8a53 5e              pop     esi</div><div class="line">275c8a54 5b              pop     ebx</div><div class="line">275c8a55 c9              leave</div><div class="line">275c8a56 c20800          ret     8</div></pre></td></tr></table></figure></p>
<p>调用了两次 <code>MSCOMCTL!DllGetClassObject+0x41a29</code>，第二次调用时造成了栈溢出。第二次调用时入栈的三个参数如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">0:000&gt; dd esp L3</div><div class="line">001216dc  00121700 0a130810 00008282</div></pre></td></tr></table></figure></p>
<p>第一个参数指向栈内，第二个参数指向一片内存区域，第三个参数为大小（由后面分析得知）。接下来跟进下 <code>MSCOMCTL!DllGetClassObject+0x41a29</code>，注意继续观察 <code>0x12170c</code> 处的内存变化：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">······ 省略中间指令 ······</div><div class="line">;参数拷入 edi</div><div class="line">275c878a 8b7d10          mov     edi,dword ptr [ebp+10h]</div><div class="line">;edi=00008282</div><div class="line">275c878d 397dfc          cmp     dword ptr [ebp-4],edi</div><div class="line">275c8790 0f85fdb70000    jne     MSCOMCTL!DllGetClassObject+0x4d24f (275d3f93)</div><div class="line">······ 省略中间指令 ······</div><div class="line">275c87c6 8bc1            mov     eax,ecx</div><div class="line">275c87c8 c1e902          shr     ecx,2</div><div class="line">;memcpy，造成溢出</div><div class="line">275c87cb f3a5            rep movs dword ptr es:[edi],dword ptr [esi]</div><div class="line">275c87cd 8bc8            mov     ecx,eax</div><div class="line">275c87cf 8b4510          mov     eax,dword ptr [ebp+10h]</div><div class="line">275c87d2 83e103          and     ecx,3</div><div class="line">275c87d5 6a00            push    0</div><div class="line">275c87d7 8d5003          lea     edx,[eax+3]</div><div class="line">275c87da 83e2fc          and     edx,0FFFFFFFCh</div></pre></td></tr></table></figure></p>
<p>观察溢出前后栈数据的变化：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">;溢出前</div><div class="line">0:000&gt; db esp</div><div class="line">001216c4  00 00 00 00 84 be d9 08-10 08 0a 0a 82 82 00 00  ................</div><div class="line">001216d4  08 17 12 00 0a 8a 5c 27-00 17 12 00 08 70 dc 08  ......\&apos;.....p..</div><div class="line">001216e4  82 82 00 00 00 00 00 00-84 be d9 08 10 08 0a 0a  ................</div><div class="line">001216f4  43 6f 62 6a 64 00 00 00-82 82 00 00 70 bf d9 08  Cobjd.......p...</div><div class="line">00121704  e4 59 58 27 30 17 12 00-1a 70 5e 27 84 be d9 08  .YX&apos;0....p^&apos;....</div><div class="line">00121714  10 08 0a 0a 00 00 00 00-60 be d9 08 28 8b d9 08  ........`...(...</div><div class="line">00121724  96 c2 5a 27 01 00 00 00-50 17 12 00 50 17 12 00  ..Z&apos;....P...P...</div><div class="line">00121734  61 73 5e 27 84 be d9 08-10 08 0a 0a 10 08 0a 0a  as^&apos;............</div><div class="line">;rep movs dword ptr es:[edi],dword ptr [esi] =&gt; memcpy 造成溢出</div><div class="line">0:000&gt; p</div><div class="line">eax=00008282 ebx=0a0a0810 ecx=00000000 edx=00000000 esi=08dcf288 edi=00129980</div><div class="line">eip=275c87cd esp=001216c4 ebp=001216d4 iopl=0         nv up ei pl nz na pe cy</div><div class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000207</div><div class="line">MSCOMCTL!DllGetClassObject+0x41a89:</div><div class="line">275c87cd 8bc8            mov     ecx,eax</div><div class="line">;溢出后</div><div class="line">0:000&gt; db esp</div><div class="line">001216c4  00 00 00 00 84 be d9 08-10 08 0a 0a 82 82 00 00  ................</div><div class="line">001216d4  08 17 12 00 0a 8a 5c 27-00 17 12 00 08 70 dc 08  ......\&apos;.....p..</div><div class="line">001216e4  82 82 00 00 00 00 00 00-84 be d9 08 10 08 0a 0a  ................</div><div class="line">001216f4  43 6f 62 6a 64 00 00 00-82 82 00 00 00 00 00 00  Cobjd...........</div><div class="line">00121704  00 00 00 00 00 00 00 00-7b 46 86 7c 90 90 90 90  ........&#123;F.|....</div><div class="line">00121714  90 90 90 90 3f 99 49 98-48 93 46 41 97 4f 97 90  ....?.I.H.FA.O..</div><div class="line">00121724  97 97 48 97 97 96 96 fd-99 40 41 47 f8 d6 f9 96  ..H......@AG....</div><div class="line">00121734  f8 99 d6 98 fd f8 97 fd-f5 49 48 f9 40 48 3f 42  .........IH.@H?B</div></pre></td></tr></table></figure></p>
<p>可见 shellcode 已经被拷入栈中，并且上层函数返回地址已经被 0x7c86467b（<code>jmp esp</code>）覆盖：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">;在上层函数栈桢中观察</div><div class="line">0:000&gt; kb</div><div class="line">ChildEBP RetAddr  Args to Child              </div><div class="line">WARNING: Stack unwind information not available. Following frames may be wrong.</div><div class="line">00121708 7c86467b 90909090 90909090 9849993f MSCOMCTL!DllGetClassObject+0x41cc6</div><div class="line">0012196c 00000000 00000000 00000000 00000000 kernel32!UnhandledExceptionFilter+0x7fc</div></pre></td></tr></table></figure></p>
<p>函数 <code>MSCOMCTL!DllGetClassObject+0x41c83</code> 开辟了 0x14 的栈桢，其中两次调用 <code>MSCOMCTL!DllGetClassObject+0x41a29</code>。第二次调用前进行了判断，本应该是小于等于却被写成了大于等于，结果拷入了 0x8282 字节的数据，破坏了上层函数的栈桢，覆盖返回地址，造成代码执行漏洞。</p>
<p>在 IDA 中观察伪代码可以清晰地看到整个流程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">int __stdcall sub_275C89C7(int a1, void *lpMem)</div><div class="line">&#123;</div><div class="line">  void *v2; // ebx@1</div><div class="line">  int result; // eax@1</div><div class="line">  int v4; // esi@4</div><div class="line">  int v5; // [sp+Ch] [bp-14h]@1</div><div class="line">  SIZE_T dwBytes; // [sp+14h] [bp-Ch]@3</div><div class="line">  int v7; // [sp+18h] [bp-8h]@4</div><div class="line">  int v8; // [sp+1Ch] [bp-4h]@8</div><div class="line"></div><div class="line">  v2 = lpMem;</div><div class="line">  //第一次拷贝 0xC 字节</div><div class="line">  result = sub_275C876D(&amp;v5, lpMem, 0xCu);</div><div class="line">  if ( result &gt;= 0 )</div><div class="line">  &#123;</div><div class="line">  	//判断错误，应该为 &lt;= 8</div><div class="line">    if ( v5 == 1784835907 &amp;&amp; dwBytes &gt;= 8 )</div><div class="line">    &#123;</div><div class="line">      //第二次调用，dwBytes=0x8282，造成溢出</div><div class="line">      v4 = sub_275C876D(&amp;v7, v2, dwBytes);</div><div class="line">      if ( v4 &gt;= 0 )</div><div class="line">      ······ 省略中间代码 ······</div><div class="line">  &#125;</div><div class="line">  return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int __cdecl sub_275C876D(void *a1, LPVOID lpMem, SIZE_T dwBytes)</div><div class="line">&#123;</div><div class="line">  LPVOID v3; // ebx@1</div><div class="line">  int result; // eax@1</div><div class="line">  LPVOID v5; // eax@3</div><div class="line">  int v6; // esi@4</div><div class="line">  int v7; // [sp+Ch] [bp-4h]@1</div><div class="line">  const void *lpMema; // [sp+1Ch] [bp+Ch]@3</div><div class="line"></div><div class="line">  v3 = lpMem;</div><div class="line">  result = (*(int (__stdcall **)(LPVOID, int *, signed int, _DWORD))(*(_DWORD *)lpMem + 12))(lpMem, &amp;v7, 4, 0);</div><div class="line">  if ( result &gt;= 0 )</div><div class="line">  &#123;</div><div class="line">    if ( v7 == dwBytes )</div><div class="line">    &#123;</div><div class="line">      ······ 省略中间代码 ······</div><div class="line">        if ( v6 &gt;= 0 )</div><div class="line">        &#123;</div><div class="line">          ;memcpy 造成溢出</div><div class="line">          memcpy(a1, lpMema, dwBytes);</div><div class="line">          v6 = (*(int (__stdcall **)(LPVOID, _UNKNOWN *, SIZE_T, _DWORD))(*(_DWORD *)v3 + 12))(</div><div class="line">                 v3,</div><div class="line">                 &amp;unk_27632368,</div><div class="line">                 ((dwBytes + 3) &amp; 0xFFFFFFFC) - dwBytes,</div><div class="line">                 0);</div><div class="line">        &#125;</div><div class="line">        ······ 省略中间代码 ······</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="http://www.xjymw.cn/wangluoguanli/wangluoanquan/2015/0415/70150.html" target="_blank" rel="external">Step by Step 调试 CVE‐2012‐0158 POC</a></li>
<li><a href="http://www.binvul.com/viewthread.php?tid=66&amp;highlight=CVE-2012-0158%2BMSCOMCTL%2B%E6%8E%A7%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90" target="_blank" rel="external">CVE-2012-0158 MSCOMCTL控件漏洞分析</a></li>
</ul>
<p>感谢@大师傅、@二师傅、@小师傅的帮助！</p>

      
    </div>
    <footer class="article-footer">
      
        <a href="http://sh3ll.me/2015/09/19/CVE-2012-0158/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/09/28/nsctf-bin-1500/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          NSCTF Bin 1500
        
      </div>
    </a>
  
  
    <a href="/2015/09/03/bypass-av-with-exploit/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">通过溢出漏洞绕过杀毒防护</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Chu<br>
      <a href="https://github.com/steven5538/hexo-theme-athena" target="_blank">Athena</a> by <a href="http://steven5538.tw" target="_blank">Steven5538</a> | Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> | <script src="http://s11.cnzz.com/z_stat.php?id=1254610758&web_id=1254610758" language="JavaScript"></script>
    </div>
  </div>
</footer>
    </div>
    
<script>
  var disqus_shortname = 'sh3ll';
  
  var disqus_url = 'http://sh3ll.me/2015/09/19/CVE-2012-0158/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="http://libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>
</body>
</html>